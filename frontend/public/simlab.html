<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIM LAB // MLB</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');
:root {
    --bg-deep: #1A2350;
    --bg-main: #2B3A8C;
    --bg-light: #3D4DB0;
    --text-main: #FFFFFF;
    --text-muted: #8E9AFF;
    --accent: #FF4400;
    --accent-hover: #ff6a33;
    --green: #2a9d8f;
    --red: #e63946;
    --grid-unit: 8px;
    --border-radius: 0px;
    --dashed-border: 1px dashed rgba(255, 255, 255, 0.3);
    --font-stack: 'Space Mono', 'Courier New', monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
    background-color:var(--bg-main);color:var(--text-main);font-family:var(--font-stack);
    font-size:14px;line-height:1.4;min-height:100vh;overflow-x:hidden;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
}
.layout-shell{display:grid;grid-template-rows:auto 1fr;height:100vh;max-width:1600px;margin:0 auto;
    border-left:1px solid rgba(0,0,0,0.2);border-right:1px solid rgba(0,0,0,0.2);box-shadow:0 0 50px rgba(0,0,0,0.5)}

/* ═══ TOP BAR ═══ */
.top-bar{display:grid;grid-template-columns:320px 1fr auto;gap:1.5rem;padding:1rem 1.5rem;
    border-bottom:var(--dashed-border);align-items:center;background:rgba(43,58,140,0.9);
    backdrop-filter:blur(5px);z-index:100}
.brand-block{display:flex;align-items:center;gap:1rem}
.back-link{text-decoration:none;color:var(--text-muted);font-size:0.8rem;transition:color 0.15s}
.back-link:hover{color:var(--accent)}
.logo{font-weight:700;letter-spacing:-0.5px;font-size:1.1rem;border:1px solid var(--text-main);padding:2px 6px}
.mode-toggle{display:flex;gap:0;margin-left:8px}
.mode-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:var(--text-muted);
    font-family:var(--font-stack);font-size:0.65rem;padding:3px 8px;cursor:pointer;transition:all 0.15s;letter-spacing:0.5px;border-right:none}
.mode-btn:last-child{border-right:1px solid rgba(255,255,255,0.3)}
.mode-btn.active{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.control-cluster{display:flex;gap:1.5rem;align-items:center;padding-left:0.5rem}
.search-wrap{position:relative;flex:0 0 300px}
.hitter-search{background:transparent;border:none;border-bottom:var(--dashed-border);color:var(--text-main);
    font-family:var(--font-stack);font-size:1rem;width:100%;padding:4px 0;text-transform:uppercase}
.hitter-search::placeholder{color:var(--text-muted);opacity:0.5}
.hitter-search:focus{outline:none;border-bottom:1px solid var(--accent)}
.s-drop{position:absolute;top:100%;left:0;width:100%;max-height:260px;overflow-y:auto;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);border-top:none;display:none;z-index:200}
.s-drop.visible{display:block}
.s-item{display:flex;justify-content:space-between;align-items:center;padding:0 14px;height:36px;
    font-size:12px;color:#eee;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05)}
.s-item:hover,.s-item.hl{background:var(--bg-light)}
.s-item .pa{color:var(--text-muted);font-size:10px}

/* ═══ CALENDAR ═══ */
.cal-wrap{position:relative}
.cal-dropdown{display:none;position:absolute;top:100%;right:0;z-index:300;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);padding:12px;
    width:280px;box-shadow:8px 8px 0px rgba(0,0,0,0.3)}
.cal-dropdown.visible{display:block}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
    font-size:0.75rem;letter-spacing:1px;text-transform:uppercase}
.cal-arrow{cursor:pointer;color:var(--text-muted);padding:4px 8px;user-select:none}
.cal-arrow:hover{color:var(--accent)}
.cal-month{font-weight:700;color:var(--text-main)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-dow{font-size:0.55rem;color:var(--text-muted);text-align:center;padding:4px 0;
    letter-spacing:1px;font-weight:700}
.cal-day{text-align:center;padding:6px 0;font-size:0.7rem;cursor:pointer;
    border:1px solid transparent;transition:all 0.1s;font-family:var(--font-stack)}
.cal-day:hover{border-color:var(--accent)}
.cal-day.other-month{color:rgba(255,255,255,0.15);cursor:default}
.cal-day.other-month:hover{border-color:transparent}
.cal-day.today{border:1px dashed var(--text-muted)}
.cal-day.range-start,.cal-day.range-end{background:var(--accent);color:#000;font-weight:700}
.cal-day.in-range{background:rgba(255,68,0,0.25);color:var(--text-main)}
.cal-range-label{font-size:0.6rem;color:var(--text-muted);margin-top:8px;min-height:20px;text-align:center;
    padding:4px 0;letter-spacing:0.5px}
.cal-range-label .range-accent{color:var(--accent);font-weight:700}
.cal-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px;padding-top:8px;
    border-top:var(--dashed-border)}

.action-area{display:flex;align-items:center;gap:1rem}
.btn{background:transparent;border:1px solid var(--text-main);color:var(--text-main);padding:0.6rem 1.2rem;
    font-family:var(--font-stack);text-transform:uppercase;cursor:pointer;transition:all 0.2s;font-size:0.8rem}
.btn:hover{background:var(--text-main);color:var(--bg-main)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.btn-primary:hover{background:var(--accent-hover);border-color:var(--accent-hover);box-shadow:0 0 15px var(--accent)}
.btn-primary:disabled{opacity:0.3;cursor:not-allowed}
.btn-sm{padding:4px 8px;font-size:0.7rem}

/* ═══ WORKSPACE ═══ */
.workspace{display:grid;grid-template-columns:260px 1fr 300px;overflow:hidden}

/* Left: Context Column */
.col-context{padding:1.5rem;border-right:var(--dashed-border);background:rgba(0,0,0,0.1);overflow-y:auto}
.hero{margin-bottom:2rem}
.hero-name{font-size:2rem;line-height:1;text-transform:uppercase;word-break:break-word;margin-bottom:0.8rem;letter-spacing:2px}
.hero-meta{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:1.5rem;font-size:0.75rem;color:var(--text-muted)}
.hero-clear{font-size:0.7rem;color:var(--text-muted);cursor:pointer;margin-top:8px;display:inline-block}
.hero-clear:hover{color:var(--accent)}
.section-label{font-size:0.65rem;letter-spacing:1px;color:var(--text-muted);margin-bottom:1rem;display:flex;align-items:center;gap:0.8rem}
.section-label::after{content:'';flex:1;height:1px;border-bottom:var(--dashed-border)}
.stat-block{margin-bottom:1.5rem}
.stat-row{display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.1);padding:6px 0;font-size:0.8rem}
.stat-row .val{font-family:var(--font-stack);letter-spacing:-1px}
.stat-row .val.good{color:var(--green)}.stat-row .val.bad{color:var(--red)}
.archetype-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;margin-top:8px;
    border:1px dashed rgba(255,255,255,0.3);font-size:0.75rem}
.archetype-badge .dot{width:8px;height:8px;display:inline-block}
.no-player{color:var(--text-muted);font-size:0.85rem;font-style:italic;padding:2rem 0}

/* Game Mode Info */
.game-mode-info{display:none}
.game-mode-info p{color:var(--text-muted);font-size:0.75rem;margin-bottom:1rem;line-height:1.5}
.game-mode-info .step-list .stat-row{font-size:0.7rem}
.game-mode-info .step-list .val{font-size:0.65rem;color:var(--text-muted);text-align:right;max-width:160px}

/* Center: Slate Column */
.col-slate{padding:1.5rem;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--accent) transparent}
.status-banner{background:var(--bg-deep);border:1px solid #e76f51;padding:10px 14px;margin-bottom:12px;
    font-size:0.75rem;color:#e76f51;display:none}
.status-banner.visible{display:block}
.day-hdr{font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);
    margin-bottom:6px;padding-left:4px;margin-top:16px}
.off-day{font-size:0.75rem;font-style:italic;color:var(--text-muted);padding:6px 0}

/* Game Cards */
.game-card{display:grid;grid-template-columns:70px 1fr;background:var(--bg-light);margin-bottom:1.5rem;
    box-shadow:8px 8px 0px rgba(0,0,0,0.2);position:relative;transition:transform 0.2s}
.game-card:hover{transform:translate(-2px,-2px);box-shadow:10px 10px 0px rgba(0,0,0,0.3)}
.card-spine{background:var(--bg-deep);padding:0.8rem;display:flex;flex-direction:column;
    justify-content:center;align-items:center;text-align:center;border-right:1px solid rgba(255,255,255,0.05)}
.card-spine .vs-label{font-size:1.2rem;font-weight:bold}
.card-spine .opp-team{margin-top:8px;color:var(--text-muted);font-size:0.8rem}
.spine-mark{display:block;width:100%;border-top:1px dashed rgba(255,255,255,0.2);margin:4px 0}
.card-content{padding:1.2rem}
.matchup-header{display:flex;justify-content:space-between;margin-bottom:0.8rem;font-size:0.9rem;align-items:center}
.pitcher-info{color:var(--text-muted);font-size:0.8rem;margin-bottom:0.8rem;padding-bottom:0.8rem;border-bottom:1px dashed rgba(255,255,255,0.2)}
.gc-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.gc-section{font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:700;margin-bottom:6px}
.gc-section.warn{color:#e76f51}
.stat-chips{display:flex;gap:6px;flex-wrap:wrap}
.sc{background:rgba(0,0,0,0.2);padding:8px 10px;text-align:center;min-width:50px;flex:1}
.sc .sl{font-size:0.5rem;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.5px;font-weight:700;margin-bottom:3px}
.sc .sv{font-size:1rem;font-weight:800}
.sc .sv.good{color:var(--green)}.sc .sv.bad{color:var(--red)}

/* Projections */
.proj-row{margin-top:12px;padding-top:12px;border-top:1px dashed rgba(255,255,255,0.2)}
.proj-label{font-size:0.6rem;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:3px}
.proj-method{font-size:0.65rem;color:var(--text-muted);font-style:italic;margin-bottom:8px}
.proj-cards{display:flex;gap:6px;flex-wrap:wrap}
.pa-edit{width:28px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);color:var(--text-main);
    font-family:var(--font-stack);font-size:1rem;font-weight:800;text-align:center;outline:none}
.pa-edit:focus{border-color:var(--accent)}

/* Lines Panel */
.lines-toggle{font-size:0.6rem;color:var(--text-muted);cursor:pointer;margin-top:10px;
    letter-spacing:1px;text-transform:uppercase;display:flex;align-items:center;gap:4px}
.lines-toggle:hover{color:var(--accent)}
.lines-panel{display:none;margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,0.15)}
.lines-panel.visible{display:block}
.lines-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.line-item{text-align:center}
.line-item label{display:block;font-size:0.5rem;color:var(--text-muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px}
.line-item .line-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.15);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.8rem;text-align:center;padding:4px 0;outline:none}
.line-item .line-input:focus{border-color:var(--accent)}
.line-item .line-input::placeholder{color:rgba(255,255,255,0.2)}
.line-item .edge{font-size:0.65rem;margin-top:2px;font-weight:700}
.line-item .edge.over{color:var(--green)}.line-item .edge.under{color:var(--red)}.line-item .edge.neutral{color:var(--text-muted)}

/* ═══ PITCHER OVERRIDE ═══ */
.pitcher-name-wrap{display:inline-flex;align-items:center;gap:6px}
.pitcher-edit-icon{font-size:0.7rem;color:var(--text-muted);cursor:pointer;opacity:0.5;transition:all 0.15s}
.pitcher-edit-icon:hover{color:var(--accent);opacity:1}
.pitcher-override-badge{display:flex;justify-content:space-between;align-items:center;
    background:rgba(255,68,0,0.1);border:1px dashed var(--accent);padding:3px 8px;margin-bottom:6px;
    font-size:0.55rem;letter-spacing:1px;color:var(--accent);text-transform:uppercase}
.pitcher-reset{cursor:pointer;font-weight:700}
.pitcher-reset:hover{color:var(--text-main)}
.pitcher-override-search{position:relative;margin-bottom:8px}
.po-search-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.75rem;padding:6px 8px;outline:none}
.po-search-input:focus{border-color:var(--accent)}
.po-drop{position:absolute;top:100%;left:0;width:100%;max-height:180px;overflow-y:auto;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);border-top:none;display:none;z-index:200}
.po-drop.visible{display:block}

/* ═══ GAME TOTAL CARDS ═══ */
.game-total-card{display:grid;grid-template-columns:80px 1fr;background:var(--bg-light);margin-bottom:1.5rem;
    box-shadow:8px 8px 0px rgba(0,0,0,0.2);position:relative;transition:transform 0.2s}
.game-total-card:hover{transform:translate(-2px,-2px);box-shadow:10px 10px 0px rgba(0,0,0,0.3)}
.gt-spine{background:var(--bg-deep);padding:0.8rem;display:flex;flex-direction:column;
    justify-content:center;align-items:center;text-align:center;border-right:1px solid rgba(255,255,255,0.05)}
.gt-spine .gt-total{font-size:1.6rem;font-weight:900;color:var(--accent)}
.gt-spine .gt-label{font-size:0.5rem;color:var(--text-muted);letter-spacing:1px;margin-top:4px}
.gt-content{padding:1rem}
.gt-matchup{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:0.85rem;font-weight:700}
.gt-pitchers{font-size:0.7rem;color:var(--text-muted);margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed rgba(255,255,255,0.2)}
.gt-pitchers .sp-name{color:var(--text-main)}
.gt-sides{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
.gt-side{text-align:center}
.gt-side-label{font-size:0.55rem;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px;font-weight:700}
.gt-side-runs{font-size:1.4rem;font-weight:900;margin-bottom:6px}
.gt-side-stats{display:flex;gap:4px;justify-content:center;flex-wrap:wrap}
.gt-side-stats .mini-stat{font-size:0.55rem;color:var(--text-muted);background:rgba(0,0,0,0.2);padding:2px 6px}
.gt-side-stats .mini-stat span{color:var(--text-main);font-weight:700}
.gt-line-row{display:flex;align-items:center;gap:12px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.15)}
.gt-line-row label{font-size:0.55rem;color:var(--text-muted);letter-spacing:1px;white-space:nowrap}
.gt-line-row .line-input{width:60px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.15);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.85rem;text-align:center;padding:4px 0;outline:none}
.gt-line-row .line-input:focus{border-color:var(--accent)}
.gt-line-row .line-input::placeholder{color:rgba(255,255,255,0.2)}
.gt-coverage{font-size:0.55rem;color:var(--text-muted);margin-top:6px;letter-spacing:0.5px}
.gt-coverage .cov-good{color:var(--green)}.gt-coverage .cov-warn{color:#e76f51}
.gt-lineup-toggle{font-size:0.55rem;color:var(--text-muted);cursor:pointer;margin-top:8px;
    letter-spacing:1px;text-transform:uppercase}
.gt-lineup-toggle:hover{color:var(--accent)}
.gt-lineup-detail{display:none;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.1)}
.gt-lineup-detail.visible{display:block}
.gt-lineup-section{font-size:0.55rem;color:var(--accent);font-weight:700;letter-spacing:1px;margin:6px 0 4px}
.gt-batter-row{display:flex;justify-content:space-between;font-size:0.6rem;padding:2px 0;
    border-bottom:1px solid rgba(255,255,255,0.05)}
.gt-batter-row .batter-name{max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.gt-batter-row .batter-stats{color:var(--text-muted)}
.gt-batter-row .batter-stats span{color:var(--text-main);font-weight:700}
.gt-batter-row .batter-src{font-size:0.5rem;color:var(--text-muted);font-style:italic}
.gt-tbd{text-align:center;padding:16px 0;color:var(--text-muted);font-size:0.75rem;font-style:italic}

/* Totals */
.totals-box{background:var(--bg-deep);border:2px solid var(--accent);padding:16px;margin-top:20px}
.totals-title{font-size:0.7rem;text-transform:uppercase;letter-spacing:2px;color:var(--accent);font-weight:800;margin-bottom:12px}
.totals-row{display:flex;gap:8px;flex-wrap:wrap}
.totals-row .sc{min-width:70px;padding:10px 12px}.totals-row .sc .sv{font-size:1.2rem}
.btn-save{display:block;margin:14px auto 0;width:100%}

/* Right: Research Column */
.col-research{background:rgba(0,0,0,0.2);border-left:var(--dashed-border);display:grid;
    grid-template-rows:auto 1fr auto;overflow:hidden}
.research-panel{padding:1.2rem;border-bottom:var(--dashed-border)}
.research-panel .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.csv-table{width:100%;border-collapse:collapse;font-size:0.65rem;margin-top:8px}
.csv-table th{text-align:center;color:var(--text-muted);padding:4px 3px;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.55rem;letter-spacing:0.5px}
.csv-table th:first-child{text-align:left}
.csv-table td{padding:4px 3px;border-bottom:1px dashed rgba(255,255,255,0.1);text-align:center;font-size:0.65rem}
.csv-table td:first-child{text-align:left;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.csv-table .del{color:var(--text-muted);cursor:pointer;font-size:0.8rem}.csv-table .del:hover{color:var(--red)}
.empty-msg{text-align:center;color:var(--text-muted);font-size:0.75rem;padding:20px 0}
.notes-area{width:100%;height:100%;background:transparent;border:none;color:var(--text-main);
    font-family:var(--font-stack);font-size:0.8rem;padding:1.2rem;resize:none}
.notes-area:focus{outline:none;background:rgba(255,255,255,0.02)}
.notes-area::placeholder{color:var(--text-muted)}
.totals-dock{padding:1.2rem;background:var(--bg-deep);border-top:1px solid rgba(255,255,255,0.1)}
.pad-btns{display:flex;gap:6px;margin-top:8px;padding:0 1.2rem 1.2rem}
.pad-btn{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--text-muted);
    font-family:var(--font-stack);font-size:0.65rem;padding:4px 10px;cursor:pointer;transition:all 0.15s}
.pad-btn:hover{border-color:var(--accent);color:var(--accent)}
.pad-btn.primary{background:var(--accent);border-color:var(--accent);color:#000}
.flash{font-size:0.6rem;color:var(--green);margin-left:6px;opacity:0;transition:opacity 0.3s}
.flash.show{opacity:1}
.text-accent{color:var(--accent)}.text-right{text-align:right}.mono{font-family:var(--font-stack);letter-spacing:-1px}

/* Loading */
#loading-overlay{position:fixed;inset:0;background:var(--bg-deep);display:flex;align-items:center;
    justify-content:center;z-index:999;flex-direction:column;gap:16px}
#loading-overlay .load-title{font-size:20px;font-weight:700;color:var(--accent);font-family:var(--font-stack)}
#loading-overlay .load-sub{font-size:10px;color:var(--text-muted);font-family:var(--font-stack);letter-spacing:2px}
#load-status{font-size:11px;color:var(--text-muted);font-family:var(--font-stack)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-deep)}
::-webkit-scrollbar-thumb{background:var(--text-muted)}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* Responsive */
@media(max-width:1100px){.workspace{grid-template-columns:1fr}.col-context,.col-research{display:none}}
</style>
</head>
<body>
<div id="loading-overlay">
  <div class="load-title">SIM LAB</div>
  <div class="load-sub">ATLAS // MLB</div>
  <div id="load-status">Loading data...</div>
</div>

<div class="layout-shell">
  <!-- TOP BAR -->
  <header class="top-bar">
    <div class="brand-block">
      <a href="cosmos.html" class="back-link">&larr; ATLAS</a>
      <div class="logo">SIM LAB</div>
      <div class="mode-toggle">
        <button class="mode-btn active" id="mode-hitter" data-mode="hitter">HITTER</button>
        <button class="mode-btn" id="mode-pitcher" data-mode="pitcher">PITCHER</button>
        <button class="mode-btn" id="mode-game" data-mode="game">GAME</button>
      </div>
    </div>
    <div class="control-cluster">
      <div class="search-wrap">
        <input type="text" class="hitter-search" id="search" placeholder="SEARCH HITTER..." autocomplete="off">
        <div class="s-drop" id="s-drop"></div>
      </div>
      <div class="cal-wrap" id="cal-wrap">
        <button class="btn btn-sm" id="cal-trigger">
          <span id="cal-trigger-label">SELECT DATES</span>
        </button>
        <div class="cal-dropdown" id="cal-dropdown">
          <div class="cal-nav">
            <span class="cal-arrow" id="cal-prev">&larr;</span>
            <span class="cal-month" id="cal-month-label"></span>
            <span class="cal-arrow" id="cal-next">&rarr;</span>
          </div>
          <div class="cal-grid" id="cal-grid"></div>
          <div class="cal-range-label" id="cal-range-label"></div>
          <div class="cal-actions">
            <button class="btn btn-sm" id="cal-clear">CLEAR</button>
            <button class="btn btn-sm btn-primary" id="cal-done">DONE</button>
          </div>
        </div>
      </div>
    </div>
    <div class="action-area">
      <button class="btn btn-primary" id="btn-run" disabled>RUN SLATE</button>
    </div>
  </header>

  <!-- WORKSPACE -->
  <main class="workspace">
    <!-- Left: Context -->
    <aside class="col-context">
      <div id="player-context">
        <div class="no-player" id="no-player">Search a player to begin.</div>
        <!-- Hitter hero -->
        <div class="hero" id="hitter-hero" style="display:none">
          <div class="hero-name" id="hero-name"></div>
          <div class="hero-meta" id="hero-meta"></div>
          <span class="hero-clear" id="hc-clear">&times; CLEAR</span>
        </div>
        <!-- Pitcher hero -->
        <div class="hero" id="pitcher-hero" style="display:none">
          <div class="hero-name" id="pitcher-hero-name"></div>
          <div class="hero-meta" id="pitcher-hero-meta"></div>
          <div id="pitcher-archetype-badge"></div>
          <span class="hero-clear" id="pc-clear">&times; CLEAR</span>
        </div>
        <!-- Game mode info -->
        <div class="game-mode-info" id="game-mode-info">
          <div class="section-label">GAME MODE</div>
          <p>Select a date range and RUN SLATE to project game totals for all MLB games. Uses archetype matchup data to estimate team runs via BaseRuns model.</p>
          <div class="section-label">HOW IT WORKS</div>
          <div class="stat-block step-list">
            <div class="stat-row"><span>1.</span><span class="val">Fetch lineups from MLB API</span></div>
            <div class="stat-row"><span>2.</span><span class="val">Project each batter vs opposing SP archetype</span></div>
            <div class="stat-row"><span>3.</span><span class="val">Sum team H/HR/BB/TB &rarr; BaseRuns</span></div>
            <div class="stat-row"><span>4.</span><span class="val">Compare projected total to O/U line</span></div>
          </div>
          <div id="game-mode-summary" style="display:none">
            <div class="section-label">SLATE SUMMARY</div>
            <div id="game-summary-stats"></div>
          </div>
        </div>
      </div>
      <div id="context-stats"></div>
    </aside>

    <!-- Center: Slate -->
    <section class="col-slate">
      <div class="section-label" id="slate-label">AVAILABLE MATCHUPS // EDITABLE PA</div>
      <div class="status-banner" id="status-banner"></div>
      <div id="slate"></div>
    </section>

    <!-- Right: Research -->
    <aside class="col-research">
      <div class="research-panel">
        <div class="hdr">
          <div class="section-label" style="margin:0">SAVED PROJECTIONS</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm" id="btn-clear-all">CLEAR</button>
            <button class="btn btn-sm" id="btn-export">CSV</button>
          </div>
        </div>
        <table class="csv-table">
          <thead><tr><th>PLAYER</th><th>DATES</th><th>H</th><th>HR</th><th>K</th><th>TB</th><th></th></tr></thead>
          <tbody id="saved-rows"></tbody>
        </table>
        <div class="empty-msg" id="empty-msg">No saved projections yet.</div>
      </div>
      <textarea class="notes-area" id="pad" placeholder="RESEARCH NOTES // TYPE HERE..."></textarea>
      <div class="pad-btns">
        <button class="pad-btn primary" id="pad-save">Save<span class="flash" id="flash-save">OK</span></button>
        <button class="pad-btn" id="pad-copy">Copy<span class="flash" id="flash-copy">OK</span></button>
        <button class="pad-btn" id="pad-clear">Clear</button>
      </div>
      <div class="totals-dock" id="totals-dock" style="display:none">
        <div class="section-label">SLATE AGGREGATE</div>
        <div id="dock-stats"></div>
        <button class="btn" style="width:100%;margin-top:10px" id="btn-save-dock">SAVE PROJECTION</button>
      </div>
    </aside>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
// ═══ DATA ═══
const DATA = { pitcherSeasons: [], hitterVsCluster: [], hitterVsPitcher: [], clusters: {}, batters: [], archetypeKings: {} };

// ═══ STATE ═══
let currentMode = 'hitter';
let selectedBatter = null;
let selectedPitcher = null;
let teamId = null;
let schedule = [];
let projections = [];
let calRangeStart = null;
let calRangeEnd = null;
let calViewYear, calViewMonth;

// ═══ LOAD DATA ═══
async function loadData() {
    const status = document.getElementById('load-status');
    const update = (msg) => { if (status) status.textContent = msg; };
    update('Loading cluster profiles...');
    const [clusters, batters, pitcherSeasons, hvc, hvp, kings] = await Promise.all([
        fetch('clusters.json').then(r => r.json()),
        fetch('batters.json').then(r => r.json()),
        fetch('pitcher_seasons.json').then(r => r.json()),
        fetch('hitter_vs_cluster.json').then(r => r.json()),
        fetch('hitter_vs_pitcher.json').then(r => r.json()).catch(() => []),
        fetch('archetype_kings.json').then(r => r.json()).catch(() => {}),
    ]);
    Object.assign(DATA, { clusters, batters, pitcherSeasons, hitterVsCluster: hvc, hitterVsPitcher: hvp, archetypeKings: kings });
    update('Building indexes...');
    DATA._hvpIndex = {};
    (DATA.hitterVsPitcher || []).forEach(r => {
        if (!DATA._hvpIndex[r.b]) DATA._hvpIndex[r.b] = {};
        if (!DATA._hvpIndex[r.b][r.c]) DATA._hvpIndex[r.b][r.c] = [];
        DATA._hvpIndex[r.b][r.c].push(r);
    });
}

// ═══ HELPERS ═══
function fmtName(n){if(!n)return'Unknown';return n.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')}
function baColor(v){return v>=0.300?'good':v<=0.180?'bad':''}
function wobaColor(v){return v>=0.370?'good':v<=0.250?'bad':''}
function nextMonday(){const d=new Date();const day=d.getDay();const diff=day===0?1:(8-day);d.setDate(d.getDate()+diff);return d.toISOString().split('T')[0]}
function fmtDate(s){const d=new Date(s+'T12:00:00');return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}).toUpperCase()}
function archName(clusterId){const c=DATA.clusters[clusterId];return c?(c.short_name||c.full_name||clusterId):clusterId}
function archEmoji(clusterId){const c=DATA.clusters[clusterId];return c&&c.emoji?c.emoji:''}
function sc(label,val){return '<div class="sc"><div class="sl">'+label+'</div><div class="sv">'+val+'</div></div>'}
function scC(label,val,cls){return '<div class="sc"><div class="sl">'+label+'</div><div class="sv '+(cls||'')+'">'+val+'</div></div>'}

function edgeLabel(proj, line) {
    if (line === '' || line == null || isNaN(line)) return '<span class="edge neutral">&mdash;</span>';
    const diff = proj - parseFloat(line);
    const pct = parseFloat(line) > 0 ? Math.abs(diff / parseFloat(line) * 100) : 0;
    if (diff > 0) return '<span class="edge over">OVER +' + pct.toFixed(0) + '%</span>';
    if (diff < 0) return '<span class="edge under">UNDER ' + pct.toFixed(0) + '%</span>';
    return '<span class="edge neutral">PUSH</span>';
}

function getSelectedDates() {
    if (!calRangeStart) return [];
    if (!calRangeEnd) return [calRangeStart];
    const dates = [];
    let d = new Date(calRangeStart + 'T12:00:00');
    const end = new Date(calRangeEnd + 'T12:00:00');
    while (d <= end) {
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate() + 1);
    }
    return dates;
}

function countDaysInRange() {
    if (!calRangeStart || !calRangeEnd) return calRangeStart ? 1 : 0;
    const s = new Date(calRangeStart + 'T12:00:00');
    const e = new Date(calRangeEnd + 'T12:00:00');
    return Math.round((e - s) / 86400000) + 1;
}

// ═══ CALENDAR ═══
function renderCalendar() {
    const monthNames = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
    document.getElementById('cal-month-label').textContent = monthNames[calViewMonth] + ' ' + calViewYear;
    const firstDay = new Date(calViewYear, calViewMonth, 1).getDay();
    const daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];
    let html = '<div class="cal-dow">SU</div><div class="cal-dow">MO</div><div class="cal-dow">TU</div><div class="cal-dow">WE</div><div class="cal-dow">TH</div><div class="cal-dow">FR</div><div class="cal-dow">SA</div>';
    for (let i = 0; i < firstDay; i++) html += '<div class="cal-day other-month"></div>';
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = calViewYear + '-' + String(calViewMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
        let cls = 'cal-day';
        if (dateStr === todayStr) cls += ' today';
        if (dateStr === calRangeStart) cls += ' range-start';
        else if (dateStr === calRangeEnd) cls += ' range-end';
        else if (calRangeStart && calRangeEnd && dateStr > calRangeStart && dateStr < calRangeEnd) cls += ' in-range';
        html += '<div class="' + cls + '" data-date="' + dateStr + '">' + d + '</div>';
    }
    const totalCells = firstDay + daysInMonth;
    const trailing = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 0; i < trailing; i++) html += '<div class="cal-day other-month"></div>';
    document.getElementById('cal-grid').innerHTML = html;
    renderRangeLabel();
    updateCalTriggerLabel();
}

function renderRangeLabel() {
    const container = document.getElementById('cal-range-label');
    if (!calRangeStart) {
        container.innerHTML = 'Click a start date';
        return;
    }
    if (!calRangeEnd) {
        container.innerHTML = '<span class="range-accent">' + fmtDate(calRangeStart) + '</span> &rarr; <span style="opacity:0.5">click end date</span>';
        return;
    }
    const days = countDaysInRange();
    container.innerHTML = '<span class="range-accent">' + fmtDate(calRangeStart) + '</span> &rarr; <span class="range-accent">' + fmtDate(calRangeEnd) + '</span> (' + days + ' day' + (days > 1 ? 's' : '') + ')';
}

function updateCalTriggerLabel() {
    const label = document.getElementById('cal-trigger-label');
    if (!calRangeStart) {
        label.textContent = 'SELECT DATES';
    } else if (!calRangeEnd) {
        label.textContent = fmtDate(calRangeStart);
    } else {
        label.textContent = fmtDate(calRangeStart) + ' \u2192 ' + fmtDate(calRangeEnd);
    }
}

// ═══ BASERUNS ═══
function baseRuns(teamH, teamHR, teamBB, teamTB, teamPA) {
    const A = teamH + teamBB - teamHR;
    const B = 1.02 * (1.4 * teamTB - 0.6 * teamH + 0.1 * teamBB);
    const C = (teamPA || 36) - teamH - teamBB;
    const D = teamHR;
    if (B + C === 0) return D;
    return Math.max(0, A * B / (B + C) + D);
}

// ═══ PROJECT TEAM ═══
function projectTeam(lineupIds, opposingPitcherId) {
    const ps = DATA.pitcherSeasons
        .filter(p => p.pitcher === opposingPitcherId)
        .sort((a, b) => b.game_year - a.game_year)[0] || null;
    const cluster = ps ? ps.cluster : null;

    let teamH = 0, teamHR = 0, teamBB = 0, teamK = 0, teamTB = 0, teamPA = 0;
    let coverage = 0;
    const batterDetails = [];

    lineupIds.forEach((batterId) => {
        const assumedPA = 4;
        let projH = 0, projHR = 0, projK = 0, projBB = 0, projTB = 0;
        let source = 'none';
        let batterName = 'Unknown';

        // Find batter name
        const batter = DATA.batters.find(b => b.batter === batterId);
        if (batter) batterName = batter.batter_name;

        // 1. Try head-to-head
        if (opposingPitcherId && DATA._hvpIndex[batterId]) {
            const allMatchups = Object.values(DATA._hvpIndex[batterId]).flat();
            const h2h = allMatchups.find(m => m.p === opposingPitcherId);
            if (h2h && h2h.pa >= 10) {
                const ba = h2h.ba || 0;
                const bbRate = h2h.pa > 0 ? (h2h.bb || 0) / h2h.pa : 0;
                const kRate = h2h.pa > 0 ? (h2h.k || 0) / h2h.pa : 0;
                const hrRate = h2h.pa > 0 ? (h2h.hr || 0) / h2h.pa : 0;
                const estAB = assumedPA * (1 - bbRate);
                projH = ba * estAB;
                projHR = hrRate * assumedPA;
                projK = kRate * assumedPA;
                projBB = bbRate * assumedPA;
                projTB = projH + projHR * 3;
                source = 'h2h';
                coverage++;
            }
        }

        // 2. Try archetype match
        if (source === 'none' && cluster !== null) {
            const archRows = DATA.hitterVsCluster.filter(r =>
                r.batter === batterId && String(r.cluster) === cluster
            );
            if (archRows.length > 0) {
                const tot = { PA: 0, H: 0, HR: 0, BB: 0, K: 0, singles: 0, doubles: 0, triples: 0 };
                archRows.forEach(r => {
                    tot.PA += r.PA || 0; tot.H += r.H || 0; tot.HR += r.HR || 0;
                    tot.BB += r.BB || 0; tot.K += r.K || 0;
                    tot.singles += r.singles || 0; tot.doubles += r.doubles || 0; tot.triples += r.triples || 0;
                });
                if (tot.PA >= 5) {
                    const baRate = (tot.PA - tot.BB) > 0 ? tot.H / (tot.PA - tot.BB) : 0;
                    const bbRate = tot.PA > 0 ? tot.BB / tot.PA : 0;
                    const kRate = tot.PA > 0 ? tot.K / tot.PA : 0;
                    const hrRate = tot.PA > 0 ? tot.HR / tot.PA : 0;
                    const tbTotal = tot.singles + (tot.doubles * 2) + (tot.triples * 3) + (tot.HR * 4);
                    const tbRate = tot.PA > 0 ? tbTotal / tot.PA : 0;
                    const estAB = assumedPA * (1 - bbRate);
                    projH = baRate * estAB;
                    projHR = hrRate * assumedPA;
                    projK = kRate * assumedPA;
                    projBB = bbRate * assumedPA;
                    projTB = tbRate * assumedPA;
                    source = 'archetype';
                    coverage++;
                }
            }
        }

        teamH += projH; teamHR += projHR; teamBB += projBB; teamK += projK; teamTB += projTB;
        teamPA += assumedPA;
        batterDetails.push({ batterId, name: batterName, projH, projHR, projK, projBB, projTB, source });
    });

    const runs = baseRuns(teamH, teamHR, teamBB, teamTB, teamPA);
    return { teamH, teamHR, teamBB, teamK, teamTB, teamPA, runs, coverage, total: lineupIds.length, batterDetails };
}

// ═══ BOOT ═══
(async function boot() {
    await loadData();

    const params = new URLSearchParams(window.location.search);
    const batterIdParam = params.get('batter');
    const pitcherIdParam = params.get('pitcher');
    let PRESELECT = null;
    if (batterIdParam) PRESELECT = DATA.batters.find(b => b.batter === parseInt(batterIdParam)) || null;

    // ═══ MODE TOGGLE ═══
    const modeHitter = document.getElementById('mode-hitter');
    const modePitcher = document.getElementById('mode-pitcher');
    const modeGame = document.getElementById('mode-game');
    const searchInput = document.getElementById('search');

    function setMode(mode) {
        currentMode = mode;
        modeHitter.classList.toggle('active', mode === 'hitter');
        modePitcher.classList.toggle('active', mode === 'pitcher');
        modeGame.classList.toggle('active', mode === 'game');
        searchInput.value = '';
        document.getElementById('s-drop').classList.remove('visible');

        if (mode === 'game') {
            searchInput.placeholder = 'FILTER BY TEAM...';
            document.getElementById('slate-label').textContent = 'GAME PROJECTIONS // O/U RUNS';
            document.getElementById('hitter-hero').style.display = 'none';
            document.getElementById('pitcher-hero').style.display = 'none';
            document.getElementById('no-player').style.display = 'none';
            document.getElementById('game-mode-info').style.display = 'block';
            document.getElementById('context-stats').innerHTML = '';
            document.getElementById('btn-run').disabled = false;
        } else {
            searchInput.placeholder = mode === 'hitter' ? 'SEARCH HITTER...' : 'SEARCH PITCHER...';
            document.getElementById('slate-label').textContent = mode === 'hitter'
                ? 'AVAILABLE MATCHUPS // EDITABLE PA'
                : 'OPPOSING LINEUP // MATCHUP DATA';
            document.getElementById('game-mode-info').style.display = 'none';
            if (!selectedBatter && !selectedPitcher) {
                document.getElementById('no-player').style.display = 'block';
            }
        }
    }
    modeHitter.addEventListener('click', () => setMode('hitter'));
    modePitcher.addEventListener('click', () => setMode('pitcher'));
    modeGame.addEventListener('click', () => setMode('game'));

    // ═══ SEARCH ═══
    const fuseHitters = new Fuse(DATA.batters, { keys: ['batter_name'], threshold: 0.3 });

    const pitcherMap = {};
    DATA.pitcherSeasons.forEach(ps => {
        if (!pitcherMap[ps.pitcher] || ps.game_year > pitcherMap[ps.pitcher].game_year) {
            pitcherMap[ps.pitcher] = ps;
        }
    });
    const pitcherList = Object.values(pitcherMap);
    const fusePitchers = new Fuse(pitcherList, { keys: ['player_name'], threshold: 0.3 });

    const sDrop = document.getElementById('s-drop');
    let sResults = [], sHighlight = 0;

    searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim();
        if (currentMode === 'game') { sDrop.classList.remove('visible'); return; } // team filter handled at runtime
        if (q.length < 2) { sDrop.classList.remove('visible'); sResults = []; return; }
        if (currentMode === 'hitter') {
            sResults = fuseHitters.search(q).slice(0, 8).map(r => r.item);
        } else {
            sResults = fusePitchers.search(q).slice(0, 8).map(r => r.item);
        }
        sHighlight = 0;
        renderSearchResults();
    });
    searchInput.addEventListener('keydown', (e) => {
        if (currentMode === 'game') return;
        if (e.key === 'ArrowDown') { e.preventDefault(); sHighlight = Math.min(sHighlight + 1, sResults.length - 1); renderSearchResults(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); sHighlight = Math.max(sHighlight - 1, 0); renderSearchResults(); }
        if (e.key === 'Enter' && sResults[sHighlight]) {
            if (currentMode === 'hitter') selectBatter(sResults[sHighlight]);
            else selectPitcherMode(sResults[sHighlight]);
            sDrop.classList.remove('visible');
        }
        if (e.key === 'Escape') sDrop.classList.remove('visible');
    });
    searchInput.addEventListener('blur', () => { setTimeout(() => sDrop.classList.remove('visible'), 150) });

    function renderSearchResults() {
        if (!sResults.length) { sDrop.classList.remove('visible'); return }
        sDrop.innerHTML = sResults.map((item, i) => {
            const name = currentMode === 'hitter' ? fmtName(item.batter_name) : fmtName(item.player_name);
            const info = currentMode === 'hitter'
                ? (item.total_PA || 0).toLocaleString() + ' PA'
                : (item.avg_velo_FF || 0).toFixed(1) + ' mph';
            return '<div class="s-item' + (i === sHighlight ? ' hl' : '') + '" data-idx="' + i + '"><span>' + name + '</span><span class="pa">' + info + '</span></div>';
        }).join('');
        sDrop.classList.add('visible');
    }
    sDrop.addEventListener('mousedown', (e) => {
        const el = e.target.closest('.s-item');
        if (!el) return; e.preventDefault();
        if (currentMode === 'hitter') selectBatter(sResults[parseInt(el.dataset.idx)]);
        else selectPitcherMode(sResults[parseInt(el.dataset.idx)]);
        sDrop.classList.remove('visible');
    });

    // ═══ HITTER SELECTION ═══
    async function selectBatter(batter) {
        selectedBatter = batter;
        selectedPitcher = null;
        searchInput.value = '';
        sDrop.classList.remove('visible');
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('pitcher-hero').style.display = 'none';

        const rows = DATA.hitterVsCluster.filter(r => r.batter === batter.batter);
        let totalPA = 0, totalHR = 0, wobaSum = 0;
        rows.forEach(r => { totalPA += r.PA || 0; totalHR += r.HR || 0; wobaSum += (r.wOBA || 0) * (r.PA || 0) });
        const careerWoba = totalPA > 0 ? (wobaSum / totalPA).toFixed(3) : '.000';

        const heroEl = document.getElementById('hitter-hero');
        const nameParts = fmtName(batter.batter_name).split(' ');
        document.getElementById('hero-name').innerHTML = nameParts.length > 1
            ? nameParts.slice(-1)[0] + '<br>' + nameParts.slice(0, -1).join(' ')
            : nameParts[0];

        try {
            const res = await fetch('https://statsapi.mlb.com/api/v1/people/' + batter.batter + '?hydrate=currentTeam');
            const data = await res.json();
            if (data.people && data.people[0]) {
                const p = data.people[0];
                teamId = p.currentTeam ? p.currentTeam.id : null;
                const teamAbbr = p.currentTeam ? p.currentTeam.abbreviation : '';
                const pos = p.primaryPosition ? p.primaryPosition.abbreviation : '';
                const bat = p.batSide ? p.batSide.code : '';
                document.getElementById('hero-meta').innerHTML =
                    '<div><span class="text-accent">&gt;</span> ' + teamAbbr + '<br>' + pos + '</div>' +
                    '<div class="text-right">' + bat + ' / ' + (p.throwSide ? p.throwSide.code : '') + '</div>';
            }
        } catch (e) { console.warn('MLB API player lookup failed:', e); showBanner('Could not reach MLB API.'); }

        document.getElementById('context-stats').innerHTML =
            '<div class="section-label">CAREER BASELINE</div><div class="stat-block">' +
            '<div class="stat-row"><span>wOBA</span><span class="val mono">' + careerWoba + '</span></div>' +
            '<div class="stat-row"><span>HR</span><span class="val mono">' + totalHR + '</span></div>' +
            '<div class="stat-row"><span>PA</span><span class="val mono">' + totalPA.toLocaleString() + '</span></div>' +
            '</div>';

        heroEl.style.display = 'block';
        document.getElementById('btn-run').disabled = false;
    }

    // ═══ PITCHER SELECTION ═══
    async function selectPitcherMode(ps) {
        selectedPitcher = ps;
        selectedBatter = null;
        searchInput.value = '';
        sDrop.classList.remove('visible');
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('hitter-hero').style.display = 'none';

        const cluster = DATA.clusters[ps.cluster] || {};
        const color = cluster.color || '#888';

        const heroEl = document.getElementById('pitcher-hero');
        const nameParts = fmtName(ps.player_name).split(' ');
        document.getElementById('pitcher-hero-name').innerHTML = nameParts.length > 1
            ? nameParts.slice(-1)[0] + '<br>' + nameParts.slice(0, -1).join(' ')
            : nameParts[0];

        let teamAbbr = '', throwHand = ps.cluster.startsWith('RHP') ? 'RHP' : 'LHP';
        try {
            const res = await fetch('https://statsapi.mlb.com/api/v1/people/' + ps.pitcher + '?hydrate=currentTeam');
            const data = await res.json();
            if (data.people && data.people[0]) {
                const p = data.people[0];
                teamId = p.currentTeam ? p.currentTeam.id : null;
                teamAbbr = p.currentTeam ? p.currentTeam.abbreviation : '';
            }
        } catch (e) { teamId = null; }

        document.getElementById('pitcher-hero-meta').innerHTML =
            '<div><span class="text-accent">&gt;</span> ' + teamAbbr + '<br>' + throwHand + '</div>' +
            '<div class="text-right">' + (ps.is_sp ? 'SP' : 'RP') + '</div>';

        document.getElementById('pitcher-archetype-badge').innerHTML =
            '<div class="archetype-badge"><span class="dot" style="background:' + color + '"></span>' +
            archEmoji(ps.cluster) + ' ' + archName(ps.cluster) + '</div>';

        document.getElementById('context-stats').innerHTML =
            '<div class="section-label">SEASON PROFILE</div><div class="stat-block">' +
            '<div class="stat-row"><span>VELO</span><span class="val mono">' + (ps.avg_velo_FF || 0).toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>WHIFF%</span><span class="val mono">' + ((ps.whiff_rate || 0) * 100).toFixed(0) + '%</span></div>' +
            '<div class="stat-row"><span>GB%</span><span class="val mono">' + ((ps.groundball_rate || 0) * 100).toFixed(0) + '%</span></div>' +
            '<div class="stat-row"><span>H-BRK</span><span class="val mono">' + ((ps.pfx_x_avg || 0) * 12).toFixed(1) + '"</span></div>' +
            '<div class="stat-row"><span>ARM</span><span class="val mono">' + (ps.arm_angle || 0).toFixed(0) + '\u00b0</span></div>' +
            '</div>';

        heroEl.style.display = 'block';
        document.getElementById('btn-run').disabled = false;
    }

    // ═══ CLEAR HANDLERS ═══
    document.getElementById('hc-clear').addEventListener('click', () => {
        selectedBatter = null; teamId = null; schedule = []; projections = [];
        document.getElementById('hitter-hero').style.display = 'none';
        document.getElementById('no-player').style.display = 'block';
        document.getElementById('context-stats').innerHTML = '';
        document.getElementById('slate').innerHTML = '';
        document.getElementById('totals-dock').style.display = 'none';
        document.getElementById('btn-run').disabled = true;
        hideBanner();
    });
    document.getElementById('pc-clear').addEventListener('click', () => {
        selectedPitcher = null; teamId = null; schedule = []; projections = [];
        document.getElementById('pitcher-hero').style.display = 'none';
        document.getElementById('no-player').style.display = 'block';
        document.getElementById('context-stats').innerHTML = '';
        document.getElementById('slate').innerHTML = '';
        document.getElementById('totals-dock').style.display = 'none';
        document.getElementById('btn-run').disabled = true;
        hideBanner();
    });

    // ═══ CALENDAR INIT ═══
    calRangeStart = nextMonday();
    calRangeEnd = null;
    const initDate = new Date(nextMonday() + 'T12:00:00');
    calViewMonth = initDate.getMonth();
    calViewYear = initDate.getFullYear();

    document.getElementById('cal-trigger').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('cal-dropdown').classList.toggle('visible');
        renderCalendar();
    });
    document.getElementById('cal-prev').addEventListener('click', () => {
        calViewMonth--;
        if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
        renderCalendar();
    });
    document.getElementById('cal-next').addEventListener('click', () => {
        calViewMonth++;
        if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
        renderCalendar();
    });
    document.getElementById('cal-grid').addEventListener('click', (e) => {
        const cell = e.target.closest('.cal-day');
        if (!cell || cell.classList.contains('other-month') || !cell.dataset.date) return;
        const dateStr = cell.dataset.date;
        if (!calRangeStart || (calRangeStart && calRangeEnd)) {
            calRangeStart = dateStr;
            calRangeEnd = null;
        } else {
            if (dateStr < calRangeStart) {
                calRangeEnd = calRangeStart;
                calRangeStart = dateStr;
            } else if (dateStr === calRangeStart) {
                calRangeEnd = null;
            } else {
                calRangeEnd = dateStr;
            }
        }
        renderCalendar();
    });
    document.getElementById('cal-clear').addEventListener('click', () => { calRangeStart = null; calRangeEnd = null; renderCalendar(); });
    document.getElementById('cal-done').addEventListener('click', () => { document.getElementById('cal-dropdown').classList.remove('visible'); });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#cal-wrap')) document.getElementById('cal-dropdown').classList.remove('visible');
    });
    updateCalTriggerLabel();

    // ═══ RUN SLATE ═══
    document.getElementById('btn-run').addEventListener('click', runSlate);

    async function runSlate() {
        const selectedDates = getSelectedDates();
        if (selectedDates.length === 0) { showBanner('Select at least one date.'); return; }
        if (currentMode === 'hitter' && !selectedBatter) return;
        if (currentMode === 'pitcher' && !selectedPitcher) return;

        const sorted = [...selectedDates].sort();
        const startDate = sorted[0];
        const endDate = sorted[sorted.length - 1];
        hideBanner();
        schedule = [];

        if (currentMode === 'game') {
            await runGameSlate(startDate, endDate, sorted);
        } else if (currentMode === 'hitter') {
            await runHitterSlate(startDate, endDate, sorted);
        } else {
            await runPitcherSlate(startDate, endDate, sorted);
        }
    }

    // ═══ HITTER SLATE ═══
    async function runHitterSlate(startDate, endDate, filterDates) {
        if (teamId) {
            try {
                const res = await fetch('https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher');
                const data = await res.json();
                if (data.dates) {
                    data.dates.forEach(dateObj => {
                        dateObj.games.forEach(game => {
                            const isHome = game.teams.home.team.id === teamId;
                            const opp = isHome ? game.teams.away : game.teams.home;
                            const oppPitcher = opp.probablePitcher || null;
                            schedule.push({
                                date: game.officialDate || dateObj.date,
                                oppTeam: opp.team.abbreviation || opp.team.name,
                                pitcher: oppPitcher ? { id: oppPitcher.id, name: oppPitcher.fullName } : null,
                                originalPitcher: oppPitcher ? { id: oppPitcher.id, name: oppPitcher.fullName } : null,
                                overridden: false
                            });
                        });
                    });
                }
            } catch (e) { showBanner('Could not fetch MLB schedule.'); }
        } else {
            showBanner('Team not found. Add pitcher matchups manually.');
        }

        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];
        const days = filterDates;

        days.forEach(day => {
            const games = schedule.filter(g => g.date === day);
            html += '<div class="day-hdr">' + fmtDate(day) + '</div>';
            if (games.length === 0) { html += '<div class="off-day">OFF DAY</div>'; return; }
            games.forEach(game => {
                const schedIdx = schedule.indexOf(game);
                const proj = buildGameCard(game, day, schedIdx);
                html += proj.html;
                projections.push(proj.data);
            });
        });

        if (projections.length > 0) {
            updateTotalsDock();
        }

        slateEl.innerHTML = html;
        bindPAEdits();
        bindLinePanels();
        bindPitcherOverrides();
    }

    // ═══ PITCHER SLATE ═══
    async function runPitcherSlate(startDate, endDate, filterDates) {
        if (teamId) {
            try {
                const res = await fetch('https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher');
                const data = await res.json();
                if (data.dates) {
                    data.dates.forEach(dateObj => {
                        dateObj.games.forEach(game => {
                            const isHome = game.teams.home.team.id === teamId;
                            const opp = isHome ? game.teams.away : game.teams.home;
                            const myTeam = isHome ? game.teams.home : game.teams.away;
                            const myPP = myTeam.probablePitcher || null;
                            if (myPP && myPP.id === selectedPitcher.pitcher) {
                                schedule.push({
                                    date: game.officialDate || dateObj.date,
                                    oppTeam: opp.team.abbreviation || opp.team.name,
                                    oppTeamId: opp.team.id
                                });
                            }
                        });
                    });
                }
            } catch (e) { showBanner('Could not fetch MLB schedule.'); }
        }

        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];

        const filteredSchedule = schedule.filter(g => filterDates.includes(g.date));

        if (filteredSchedule.length === 0) {
            html = '<div class="off-day">No scheduled starts found for this pitcher on selected dates.</div>';
            slateEl.innerHTML = html;
            return;
        }

        for (const game of filteredSchedule) {
            html += '<div class="day-hdr">' + fmtDate(game.date) + ' vs ' + game.oppTeam + '</div>';

            const matchedBatters = [];
            Object.entries(DATA._hvpIndex).forEach(([batterId, clusters]) => {
                Object.values(clusters).flat().forEach(m => {
                    if (m.p === selectedPitcher.pitcher) {
                        const batter = DATA.batters.find(b => b.batter === parseInt(batterId));
                        if (batter && !matchedBatters.find(x => x.batter.batter === batter.batter)) {
                            matchedBatters.push({ batter, matchup: m });
                        }
                    }
                });
            });

            if (matchedBatters.length === 0) {
                html += '<div class="off-day">No head-to-head data for opposing batters.</div>';
                continue;
            }

            matchedBatters.sort((a, b) => (b.matchup.pa || 0) - (a.matchup.pa || 0));

            let totalK = 0, totalH = 0, totalHR = 0, totalPA = 0;
            matchedBatters.slice(0, 9).forEach(mb => {
                const m = mb.matchup;
                const pa = m.pa || 0;
                totalPA += pa;
                totalK += m.k || 0;
                totalH += (m.ba || 0) * pa;
                totalHR += m.hr || 0;

                html += '<div class="game-card">';
                html += '<div class="card-spine"><div class="vs-label">AB</div><div class="opp-team">' + pa + '</div></div>';
                html += '<div class="card-content">';
                html += '<div class="matchup-header"><span>' + fmtName(mb.batter.batter_name) + '</span></div>';
                html += '<div class="stat-chips">';
                html += scC('BA', m.ba != null ? m.ba.toFixed(3) : '\u2014', baColor(m.ba || 0));
                html += scC('wOBA', m.w != null ? m.w.toFixed(3) : '\u2014', wobaColor(m.w || 0));
                html += sc('HR', m.hr || 0);
                html += sc('K', m.k || 0);
                html += sc('BB', m.bb || 0);
                html += '</div></div></div>';
            });

            const kRate = totalPA > 0 ? (totalK / totalPA) : 0;
            const hRate = totalPA > 0 ? (totalH / totalPA) : 0;
            projections.push({
                pa: totalPA, k: totalK, h: totalH, hr: totalHR, tb: totalH + totalHR * 3,
                k_rate: kRate, h_rate: hRate,
                pitcher: fmtName(selectedPitcher.player_name),
                opp: game.oppTeam
            });
        }

        slateEl.innerHTML = html;
    }

    // ═══ GAME SLATE ═══
    async function runGameSlate(startDate, endDate, filterDates) {
        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];
        document.getElementById('totals-dock').style.display = 'none';

        const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher,lineups';

        let allGames = [];
        try {
            const data = await (await fetch(url)).json();
            (data.dates || []).forEach(dateObj => {
                dateObj.games.forEach(game => {
                    if (filterDates.includes(game.officialDate || dateObj.date)) {
                        allGames.push({ ...game, displayDate: game.officialDate || dateObj.date });
                    }
                });
            });
        } catch(e) { showBanner('Could not fetch MLB schedule.'); return; }

        // Team filter from search bar
        const teamFilter = searchInput.value.trim().toUpperCase();
        if (teamFilter.length >= 2) {
            allGames = allGames.filter(g =>
                (g.teams.away.team.abbreviation || '').toUpperCase().includes(teamFilter) ||
                (g.teams.home.team.abbreviation || '').toUpperCase().includes(teamFilter)
            );
        }

        if (allGames.length === 0) {
            html = '<div class="off-day">No games found for selected dates.</div>';
            slateEl.innerHTML = html;
            return;
        }

        // Group by date
        const byDate = {};
        allGames.forEach(g => {
            const d = g.displayDate;
            if (!byDate[d]) byDate[d] = [];
            byDate[d].push(g);
        });

        let gameIdx = 0;
        Object.keys(byDate).sort().forEach(day => {
            html += '<div class="day-hdr">' + fmtDate(day) + ' \u2014 ' + byDate[day].length + ' GAME' + (byDate[day].length > 1 ? 'S' : '') + '</div>';
            byDate[day].forEach(game => {
                const result = buildGameTotalCard(game, day, gameIdx);
                html += result.html;
                projections.push(result.data);
                gameIdx++;
            });
        });

        slateEl.innerHTML = html;
        bindGameLineInputs();
        bindLineupToggles();
        updateGameSummary();
    }

    // ═══ GAME TOTAL CARD BUILDER ═══
    function buildGameTotalCard(game, day, idx) {
        const awayTeam = game.teams.away.team.abbreviation || game.teams.away.team.name;
        const homeTeam = game.teams.home.team.abbreviation || game.teams.home.team.name;
        const awayPP = game.teams.away.probablePitcher || null;
        const homePP = game.teams.home.probablePitcher || null;

        // Get pitcher archetypes
        const awayPS = awayPP ? DATA.pitcherSeasons.filter(p => p.pitcher === awayPP.id).sort((a, b) => b.game_year - a.game_year)[0] : null;
        const homePS = homePP ? DATA.pitcherSeasons.filter(p => p.pitcher === homePP.id).sort((a, b) => b.game_year - a.game_year)[0] : null;
        const awayCluster = awayPS ? (DATA.clusters[awayPS.cluster] || {}) : {};
        const homeCluster = homePS ? (DATA.clusters[homePS.cluster] || {}) : {};

        // Get lineups
        const awayLineup = [];
        const homeLineup = [];
        if (game.lineups) {
            if (game.lineups.awayPlayers) game.lineups.awayPlayers.forEach(p => { if (p.id) awayLineup.push(p.id); });
            if (game.lineups.homePlayers) game.lineups.homePlayers.forEach(p => { if (p.id) homeLineup.push(p.id); });
        }

        const hasLineups = awayLineup.length > 0 && homeLineup.length > 0;

        // Project teams
        let awayProj = null, homeProj = null, totalRuns = 0;
        if (hasLineups) {
            awayProj = projectTeam(awayLineup, homePP ? homePP.id : null);
            homeProj = projectTeam(homeLineup, awayPP ? awayPP.id : null);
            totalRuns = awayProj.runs + homeProj.runs;
        }

        const gameData = {
            awayTeam, homeTeam, totalRuns, hasLineups,
            awayRuns: awayProj ? awayProj.runs : 0,
            homeRuns: homeProj ? homeProj.runs : 0,
            awayProj, homeProj,
            awayPP: awayPP ? awayPP.fullName : 'TBD',
            homePP: homePP ? homePP.fullName : 'TBD'
        };

        let card = '<div class="game-total-card">';

        // Spine
        card += '<div class="gt-spine">';
        if (hasLineups) {
            card += '<div class="gt-total">' + totalRuns.toFixed(1) + '</div>';
            card += '<div class="gt-label">TOTAL<br>RUNS</div>';
        } else {
            card += '<div class="gt-total" style="font-size:1rem;color:var(--text-muted)">TBD</div>';
            card += '<div class="gt-label">LINEUP<br>PENDING</div>';
        }
        card += '</div>';

        // Content
        card += '<div class="gt-content">';

        // Matchup header
        card += '<div class="gt-matchup"><span>' + awayTeam + ' @ ' + homeTeam + '</span><span style="font-size:0.6rem;color:var(--text-muted);font-weight:400">' + fmtDate(day) + '</span></div>';

        // Pitchers
        card += '<div class="gt-pitchers">';
        const awayPName = awayPP ? awayPP.fullName : 'TBD';
        const homePName = homePP ? homePP.fullName : 'TBD';
        const awayArch = awayPS ? archName(awayPS.cluster) : '';
        const homeArch = homePS ? archName(homePS.cluster) : '';
        const awayColor = awayCluster.color || '#888';
        const homeColor = homeCluster.color || '#888';
        card += awayTeam + ' SP: <span class="sp-name">' + fmtName(awayPName) + '</span>';
        if (awayArch) card += ' <span style="color:' + awayColor + ';font-size:0.6rem">(' + awayArch + ')</span>';
        card += '<br>' + homeTeam + ' SP: <span class="sp-name">' + fmtName(homePName) + '</span>';
        if (homeArch) card += ' <span style="color:' + homeColor + ';font-size:0.6rem">(' + homeArch + ')</span>';
        card += '</div>';

        if (hasLineups) {
            // Side-by-side projections
            card += '<div class="gt-sides">';

            // Away offense
            card += '<div class="gt-side">';
            card += '<div class="gt-side-label">' + awayTeam + ' OFFENSE</div>';
            card += '<div class="gt-side-runs">' + awayProj.runs.toFixed(1) + '</div>';
            card += '<div class="gt-side-stats">';
            card += '<div class="mini-stat">H <span>' + awayProj.teamH.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">HR <span>' + awayProj.teamHR.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">TB <span>' + awayProj.teamTB.toFixed(1) + '</span></div>';
            card += '</div></div>';

            // Home offense
            card += '<div class="gt-side">';
            card += '<div class="gt-side-label">' + homeTeam + ' OFFENSE</div>';
            card += '<div class="gt-side-runs">' + homeProj.runs.toFixed(1) + '</div>';
            card += '<div class="gt-side-stats">';
            card += '<div class="mini-stat">H <span>' + homeProj.teamH.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">HR <span>' + homeProj.teamHR.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">TB <span>' + homeProj.teamTB.toFixed(1) + '</span></div>';
            card += '</div></div>';

            card += '</div>';

            // O/U Line
            card += '<div class="gt-line-row">';
            card += '<label>O/U RUNS</label>';
            card += '<input class="line-input game-ou-input" data-game-idx="' + idx + '" placeholder="8.5">';
            card += '<div class="edge-display" id="game-edge-' + idx + '"></div>';
            card += '</div>';

            // Coverage
            const awayCov = awayProj.coverage + '/' + awayProj.total;
            const homeCov = homeProj.coverage + '/' + homeProj.total;
            const awayPct = awayProj.total > 0 ? awayProj.coverage / awayProj.total : 0;
            const homePct = homeProj.total > 0 ? homeProj.coverage / homeProj.total : 0;
            const awayClass = awayPct >= 0.7 ? 'cov-good' : 'cov-warn';
            const homeClass = homePct >= 0.7 ? 'cov-good' : 'cov-warn';
            card += '<div class="gt-coverage">COVERAGE: <span class="' + awayClass + '">' + awayCov + '</span> ' + awayTeam + ' \u00b7 <span class="' + homeClass + '">' + homeCov + '</span> ' + homeTeam + '</div>';

            // Lineup toggle
            card += '<div class="gt-lineup-toggle" data-gidx="' + idx + '">\u25B6 LINEUP DETAILS</div>';
            card += '<div class="gt-lineup-detail" id="lineup-detail-' + idx + '">';

            // Away lineup
            card += '<div class="gt-lineup-section">' + awayTeam + ' vs ' + (homeArch || 'Unknown') + '</div>';
            awayProj.batterDetails.forEach((bd, i) => {
                const lastName = fmtName(bd.name).split(' ').pop();
                card += '<div class="gt-batter-row">';
                card += '<span class="batter-name">' + (i + 1) + '. ' + lastName + '</span>';
                card += '<span class="batter-stats">H <span>' + bd.projH.toFixed(2) + '</span> TB <span>' + bd.projTB.toFixed(2) + '</span></span>';
                card += '<span class="batter-src">' + bd.source + '</span>';
                card += '</div>';
            });

            // Home lineup
            card += '<div class="gt-lineup-section">' + homeTeam + ' vs ' + (awayArch || 'Unknown') + '</div>';
            homeProj.batterDetails.forEach((bd, i) => {
                const lastName = fmtName(bd.name).split(' ').pop();
                card += '<div class="gt-batter-row">';
                card += '<span class="batter-name">' + (i + 1) + '. ' + lastName + '</span>';
                card += '<span class="batter-stats">H <span>' + bd.projH.toFixed(2) + '</span> TB <span>' + bd.projTB.toFixed(2) + '</span></span>';
                card += '<span class="batter-src">' + bd.source + '</span>';
                card += '</div>';
            });

            card += '</div>';
        } else {
            card += '<div class="gt-tbd">LINEUPS TBD &mdash; RUN CLOSER TO GAME TIME</div>';
        }

        card += '</div></div>';

        return { html: card, data: gameData };
    }

    function bindGameLineInputs() {
        document.querySelectorAll('.game-ou-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const line = el.value;
                const proj = projections[idx];
                if (!proj || !proj.hasLineups) return;
                const display = document.getElementById('game-edge-' + idx);
                if (display) display.innerHTML = edgeLabel(proj.totalRuns, line);
            });
        });
    }

    function bindLineupToggles() {
        document.querySelectorAll('.gt-lineup-toggle').forEach(el => {
            el.addEventListener('click', () => {
                const idx = el.dataset.gidx;
                const detail = document.getElementById('lineup-detail-' + idx);
                detail.classList.toggle('visible');
                el.textContent = detail.classList.contains('visible') ? '\u25BC LINEUP DETAILS' : '\u25B6 LINEUP DETAILS';
            });
        });
    }

    function updateGameSummary() {
        const summary = document.getElementById('game-mode-summary');
        const stats = document.getElementById('game-summary-stats');
        if (projections.length === 0) { summary.style.display = 'none'; return; }

        const gamesWithLineups = projections.filter(p => p.hasLineups);
        const avgTotal = gamesWithLineups.length > 0
            ? gamesWithLineups.reduce((s, p) => s + p.totalRuns, 0) / gamesWithLineups.length : 0;

        summary.style.display = 'block';
        stats.innerHTML =
            '<div class="stat-row"><span>GAMES</span><span class="val mono">' + projections.length + '</span></div>' +
            '<div class="stat-row"><span>W/ LINEUPS</span><span class="val mono">' + gamesWithLineups.length + '</span></div>' +
            '<div class="stat-row"><span>AVG TOTAL</span><span class="val mono text-accent" style="font-size:1.1rem">' + avgTotal.toFixed(1) + '</span></div>';
    }

    // ═══ HITTER GAME CARD BUILDER ═══
    function buildGameCard(game, day, scheduleIdx) {
        let ps = null, cluster = null, cent = null;
        if (game.pitcher) {
            const allSeasons = DATA.pitcherSeasons.filter(p => p.pitcher === game.pitcher.id);
            if (allSeasons.length > 0) {
                ps = allSeasons.sort((a, b) => b.game_year - a.game_year)[0];
                cluster = DATA.clusters[ps.cluster] || null;
                cent = cluster || {};
            }
        }
        const clusterName = cluster ? archName(ps.cluster) : 'Unknown';
        const clusterColor = cluster ? cluster.color : '#666';
        const pitcherName = game.pitcher ? game.pitcher.name : 'TBD';
        const role = ps ? (ps.is_sp ? 'SP' : 'RP') : 'SP';

        let h2h = null;
        if (game.pitcher && selectedBatter) {
            const allMatchups = Object.values(DATA._hvpIndex[selectedBatter.batter] || {}).flat();
            h2h = allMatchups.find(m => m.p === game.pitcher.id) || null;
        }

        let archMatch = null;
        if (ps && selectedBatter) {
            const archRows = DATA.hitterVsCluster.filter(r => r.batter === selectedBatter.batter && String(r.cluster) === ps.cluster);
            if (archRows.length > 0) {
                const tot = { PA: 0, AB: 0, H: 0, HR: 0, BB: 0, K: 0, HBP: 0, woba_sum: 0, singles: 0, doubles: 0, triples: 0 };
                archRows.forEach(r => { tot.PA += r.PA || 0; tot.AB += r.AB || 0; tot.H += r.H || 0; tot.HR += r.HR || 0; tot.BB += r.BB || 0; tot.K += r.K || 0; tot.HBP += r.HBP || 0; tot.woba_sum += (r.wOBA || 0) * (r.PA || 0); tot.singles += r.singles || 0; tot.doubles += r.doubles || 0; tot.triples += r.triples || 0 });
                const tb = tot.singles + (tot.doubles * 2) + (tot.triples * 3) + (tot.HR * 4);
                archMatch = { PA: tot.PA, BA: tot.AB > 0 ? tot.H / tot.AB : 0, wOBA: tot.PA > 0 ? tot.woba_sum / tot.PA : 0, HR: tot.HR, K: tot.K, BB: tot.BB, K_pct: tot.PA > 0 ? tot.K / tot.PA : 0, BB_pct: tot.PA > 0 ? tot.BB / tot.PA : 0, TB: tb, TB_rate: tot.PA > 0 ? tb / tot.PA : 0 };
            }
        }

        const assumedPA = role === 'SP' ? 4 : 1.5;
        let projBA = 0, projWOBA = 0, projHRrate = 0, projKrate = 0, projBBrate = 0, projTBrate = 0, projSource = '';
        if (h2h && h2h.pa >= 10) {
            projBA = h2h.ba || 0; projWOBA = h2h.w || 0; projHRrate = h2h.pa > 0 ? (h2h.hr || 0) / h2h.pa : 0;
            projKrate = h2h.pa > 0 ? (h2h.k || 0) / h2h.pa : 0; projBBrate = h2h.pa > 0 ? (h2h.bb || 0) / h2h.pa : 0;
            const estH = (h2h.ba || 0) * (h2h.pa - (h2h.bb || 0));
            projTBrate = h2h.pa > 0 ? (estH + (h2h.hr || 0) * 3) / h2h.pa : 0;
            projSource = 'head-to-head (' + h2h.pa + ' PA)';
        } else if (archMatch && archMatch.PA >= 5) {
            projBA = archMatch.BA; projWOBA = archMatch.wOBA; projHRrate = archMatch.PA > 0 ? archMatch.HR / archMatch.PA : 0;
            projKrate = archMatch.K_pct; projBBrate = archMatch.BB_pct;
            projTBrate = archMatch.TB_rate;
            projSource = h2h ? 'archetype avg (<10 PA direct)' : 'archetype avg (no direct history)';
        } else {
            projSource = 'insufficient data';
        }
        const projAB = assumedPA * (1 - projBBrate);
        const projH = projAB * projBA;
        const projHR = assumedPA * projHRrate;
        const projK = assumedPA * projKrate;
        const projBB = assumedPA * projBBrate;
        const projTB = assumedPA * projTBrate;
        const gameData = { pa: assumedPA, ab: projAB, h: projH, hr: projHR, k: projK, bb: projBB, tb: projTB, ba: projBA, woba: projWOBA, pitcher: pitcherName, cluster: ps ? ps.cluster : '', source: projSource, scheduleIdx: scheduleIdx };

        const idx = projections.length;
        let card = '<div class="game-card">';
        card += '<div class="card-spine"><div class="vs-label">VS</div><div class="opp-team">' + game.oppTeam + '</div>';
        card += '<div class="spine-mark"></div></div>';
        card += '<div class="card-content">';

        card += '<div class="matchup-header">';
        card += '<span class="pitcher-name-wrap"><span class="pitcher-name-text" id="pname-' + idx + '">' + pitcherName + '</span>';
        card += ' <span class="pitcher-edit-icon" data-idx="' + idx + '" title="Change pitcher">&#9998;</span></span>';
        card += '<span style="color:' + clusterColor + '" id="pcluster-' + idx + '">' + clusterName + '</span>';
        card += '</div>';

        if (game.overridden) {
            card += '<div class="pitcher-override-badge"><span>MANUAL OVERRIDE</span><span class="pitcher-reset" data-idx="' + idx + '">RESET</span></div>';
        }

        card += '<div class="pitcher-override-search" id="poverride-' + idx + '" style="display:none">';
        card += '<input type="text" class="po-search-input" id="psearch-' + idx + '" placeholder="SEARCH PITCHER..." autocomplete="off">';
        card += '<div class="po-drop" id="pdrop-' + idx + '"></div>';
        card += '</div>';

        card += '<div class="pitcher-info">';
        card += 'VELO: ' + (ps ? (ps.avg_velo_FF || 0).toFixed(1) : '\u2014') + ' \u00b7 ';
        card += 'WHIFF: ' + (ps ? ((ps.whiff_rate || 0) * 100).toFixed(0) + '%' : '\u2014') + ' \u00b7 ';
        card += role;
        card += '</div>';

        card += '<div class="gc-grid">';
        card += '<div><div class="gc-section">' + (h2h && h2h.pa >= 1 ? 'Head-to-Head (' + h2h.pa + ' PA)' : 'vs Archetype') + '</div>';
        card += '<div class="stat-chips">';
        if (h2h && h2h.pa >= 1) {
            card += scC('BA', h2h.ba != null ? h2h.ba.toFixed(3) : '\u2014', baColor(h2h.ba || 0));
            card += scC('wOBA', h2h.w != null ? h2h.w.toFixed(3) : '\u2014', wobaColor(h2h.w || 0));
            card += sc('HR', h2h.hr || 0);
        } else if (archMatch) {
            card += scC('BA', '~' + archMatch.BA.toFixed(3), baColor(archMatch.BA));
            card += scC('wOBA', '~' + archMatch.wOBA.toFixed(3), wobaColor(archMatch.wOBA));
            card += sc('K%', (archMatch.K_pct * 100).toFixed(0) + '%');
        } else {
            card += '<div style="font-size:0.7rem;color:var(--text-muted);padding:4px">No data</div>';
        }
        card += '</div></div>';

        card += '<div><div class="gc-section" style="color:var(--accent)">Projection</div>';
        card += '<div class="stat-chips">';
        card += '<div class="sc"><div class="sl">PA</div><div class="sv"><input class="pa-edit" type="number" value="' + assumedPA + '" min="1" max="9" step="0.5" data-idx="' + idx + '"></div></div>';
        card += sc('H', projH.toFixed(2));
        card += sc('HR', projHR.toFixed(2));
        card += sc('TB', projTB.toFixed(2));
        card += '</div></div></div>';

        card += '<div class="lines-toggle" data-idx="' + idx + '">\u25B6 LINES</div>';
        card += '<div class="lines-panel" id="lines-' + idx + '">';
        card += '<div class="lines-grid">';
        card += '<div class="line-item"><label>O/U HITS</label><input class="line-input" data-idx="' + idx + '" data-stat="h" placeholder="1.5"><div class="edge-display" id="edge-h-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U HR</label><input class="line-input" data-idx="' + idx + '" data-stat="hr" placeholder="0.5"><div class="edge-display" id="edge-hr-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U K</label><input class="line-input" data-idx="' + idx + '" data-stat="k" placeholder="1.5"><div class="edge-display" id="edge-k-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U TB</label><input class="line-input" data-idx="' + idx + '" data-stat="tb" placeholder="1.5"><div class="edge-display" id="edge-tb-' + idx + '"></div></div>';
        card += '</div></div>';

        card += '</div></div>';
        return { html: card, data: gameData };
    }

    function bindPAEdits() {
        document.querySelectorAll('.pa-edit').forEach(el => {
            el.addEventListener('change', () => {
                const idx = parseInt(el.dataset.idx);
                const newPA = parseFloat(el.value) || 4;
                recalcGame(idx, newPA);
            });
        });
    }

    function bindLinePanels() {
        document.querySelectorAll('.lines-toggle').forEach(el => {
            el.addEventListener('click', () => {
                const idx = el.dataset.idx;
                const panel = document.getElementById('lines-' + idx);
                panel.classList.toggle('visible');
                el.textContent = panel.classList.contains('visible') ? '\u25BC LINES' : '\u25B6 LINES';
            });
        });
        document.querySelectorAll('.line-input:not(.game-ou-input)').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.idx);
                const stat = el.dataset.stat;
                const line = el.value;
                const proj = projections[idx];
                if (!proj) return;
                const projVal = proj[stat] || 0;
                const display = document.getElementById('edge-' + stat + '-' + idx);
                if (display) display.innerHTML = edgeLabel(projVal, line);
            });
        });
    }

    // ═══ PITCHER OVERRIDE ═══
    function bindPitcherOverrides() {
        document.querySelectorAll('.pitcher-edit-icon').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.idx);
                const searchPanel = document.getElementById('poverride-' + idx);
                searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
                if (searchPanel.style.display === 'block') {
                    document.getElementById('psearch-' + idx).focus();
                }
            });
        });

        document.querySelectorAll('.pitcher-reset').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.idx);
                const p = projections[idx];
                if (!p) return;
                const schedIdx = p.scheduleIdx;
                const game = schedule[schedIdx];
                if (!game) return;
                game.pitcher = game.originalPitcher ? { ...game.originalPitcher } : null;
                game.overridden = false;
                rebuildSingleCard(idx, schedIdx);
            });
        });

        document.querySelectorAll('.po-search-input').forEach(el => {
            const idx = parseInt(el.id.replace('psearch-', ''));
            const drop = document.getElementById('pdrop-' + idx);
            let results = [];

            el.addEventListener('input', () => {
                const q = el.value.trim();
                if (q.length < 2) { drop.classList.remove('visible'); return; }
                results = fusePitchers.search(q).slice(0, 6).map(r => r.item);
                drop.innerHTML = results.map((item, i) => {
                    const cl = DATA.clusters[item.cluster] || {};
                    return '<div class="s-item" data-pidx="' + i + '"><span>' + fmtName(item.player_name) + '</span><span class="pa" style="color:' + (cl.color || '#888') + '">' + archName(item.cluster) + '</span></div>';
                }).join('');
                drop.classList.add('visible');
            });

            drop.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const item = e.target.closest('.s-item');
                if (!item) return;
                const pitcherSeason = results[parseInt(item.dataset.pidx)];
                applyPitcherOverride(idx, pitcherSeason);
                drop.classList.remove('visible');
                el.value = '';
                document.getElementById('poverride-' + idx).style.display = 'none';
            });

            el.addEventListener('blur', () => { setTimeout(() => drop.classList.remove('visible'), 150); });
        });
    }

    function applyPitcherOverride(cardIdx, pitcherSeason) {
        const p = projections[cardIdx];
        if (!p) return;
        const schedIdx = p.scheduleIdx;
        schedule[schedIdx].pitcher = { id: pitcherSeason.pitcher, name: pitcherSeason.player_name };
        schedule[schedIdx].overridden = true;
        rebuildSingleCard(cardIdx, schedIdx);
    }

    function rebuildSingleCard(cardIdx, schedIdx) {
        const game = schedule[schedIdx];
        const day = game.date;
        const proj = buildGameCard(game, day, schedIdx);
        projections[cardIdx] = proj.data;

        const cards = document.querySelectorAll('.game-card');
        if (cards[cardIdx]) {
            cards[cardIdx].outerHTML = proj.html;
        }

        bindPAEdits();
        bindLinePanels();
        bindPitcherOverrides();
        updateTotalsDock();
    }

    function recalcGame(idx, newPA) {
        const p = projections[idx];
        if (!p) return;
        const oldPA = p.pa;
        p.pa = newPA;
        p.ab = newPA * (1 - (p.ba > 0 ? (p.bb / (p.bb + p.ab + p.h)) : 0));
        p.h = p.ab * p.ba;
        p.hr = newPA * (oldPA > 0 ? p.hr / oldPA : 0);
        p.k = newPA * (oldPA > 0 ? p.k / oldPA : 0);
        p.bb = newPA * (oldPA > 0 ? p.bb / oldPA : 0);
        p.tb = newPA * (oldPA > 0 ? p.tb / oldPA : 0);
        updateTotalsDock();
    }

    function updateTotalsDock() {
        const dock = document.getElementById('totals-dock');
        if (projections.length === 0 || currentMode === 'game') { dock.style.display = 'none'; return; }
        dock.style.display = 'block';
        let tPA = 0, tH = 0, tHR = 0, tK = 0, tBB = 0, tTB = 0;
        projections.forEach(p => { tPA += p.pa; tH += p.h || 0; tHR += p.hr || 0; tK += p.k || 0; tBB += p.bb || 0; tTB += p.tb || 0 });

        document.getElementById('dock-stats').innerHTML =
            '<div class="stat-row"><span>PA</span><span class="val mono">' + tPA.toFixed(0) + '</span></div>' +
            '<div class="stat-row"><span>HITS</span><span class="val mono">' + tH.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>HR</span><span class="val mono">' + tHR.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>K</span><span class="val mono">' + tK.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>TB</span><span class="val mono text-accent" style="font-size:1.1rem">' + tTB.toFixed(1) + '</span></div>';
    }

    // ═══ SAVE/LOAD PROJECTIONS ═══
    let savedProjections = JSON.parse(localStorage.getItem('pfx_sim_projections') || '[]');
    renderSaved();

    document.getElementById('btn-save-dock').addEventListener('click', saveProjection);

    function saveProjection() {
        if (projections.length === 0) return;
        const playerName = currentMode === 'hitter'
            ? (selectedBatter ? selectedBatter.batter_name : 'Unknown')
            : (selectedPitcher ? selectedPitcher.player_name : 'Unknown');
        let tPA = 0, tAB = 0, tH = 0, tHR = 0, tK = 0, tBB = 0, tTB = 0, tWS = 0;
        projections.forEach(p => { tPA += p.pa; tAB += p.ab || 0; tH += p.h || 0; tHR += p.hr || 0; tK += p.k || 0; tBB += p.bb || 0; tTB += p.tb || 0; tWS += (p.woba || 0) * p.pa });
        const selectedDates = getSelectedDates();
        savedProjections.push({
            hitter_name: playerName, hitter_id: selectedBatter ? selectedBatter.batter : (selectedPitcher ? selectedPitcher.pitcher : 0),
            mode: currentMode,
            selected_dates: [...selectedDates].sort(),
            week_start: [...selectedDates].sort()[0],
            pa: +tPA.toFixed(0), ab: +tAB.toFixed(0), h: +tH.toFixed(1),
            hr: +tHR.toFixed(1), k: +tK.toFixed(1), bb: +tBB.toFixed(1),
            tb: +tTB.toFixed(1),
            ba: tAB > 0 ? +(tH / tAB).toFixed(3) : 0, woba: tPA > 0 ? +(tWS / tPA).toFixed(3) : 0,
            timestamp: Date.now()
        });
        localStorage.setItem('pfx_sim_projections', JSON.stringify(savedProjections));
        renderSaved();
    }

    function renderSaved() {
        const rows = document.getElementById('saved-rows');
        const empty = document.getElementById('empty-msg');
        if (!savedProjections.length) { rows.innerHTML = ''; empty.style.display = 'block'; return }
        empty.style.display = 'none';
        rows.innerHTML = savedProjections.map((s, i) => {
            const dates = s.selected_dates
                ? s.selected_dates.length + 'd'
                : new Date(s.week_start + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const tb = s.tb != null ? s.tb : ((s.h || 0) + (s.hr || 0) * 3);
            const lastName = fmtName(s.hitter_name).split(' ').pop();
            return '<tr><td title="' + fmtName(s.hitter_name) + '">' + lastName + '</td>' +
                '<td>' + dates + '</td>' +
                '<td>' + (s.h || 0).toFixed(1) + '</td>' +
                '<td>' + (s.hr || 0).toFixed(1) + '</td>' +
                '<td>' + (s.k || 0).toFixed(1) + '</td>' +
                '<td style="color:var(--accent);font-weight:700">' + (+tb).toFixed(1) + '</td>' +
                '<td class="del" data-del="' + i + '">\u00d7</td></tr>';
        }).join('');
    }
    document.getElementById('saved-rows').addEventListener('click', (e) => {
        const del = e.target.closest('.del');
        if (!del) return;
        savedProjections.splice(parseInt(del.dataset.del), 1);
        localStorage.setItem('pfx_sim_projections', JSON.stringify(savedProjections));
        renderSaved();
    });
    document.getElementById('btn-clear-all').addEventListener('click', () => {
        if (!confirm('Clear all saved projections?')) return;
        savedProjections = []; localStorage.removeItem('pfx_sim_projections'); renderSaved();
    });
    document.getElementById('btn-export').addEventListener('click', () => {
        if (!savedProjections.length) return;
        let csv = 'Player,Mode,Dates,PA,AB,H,HR,K,BB,TB,BA,wOBA\n';
        savedProjections.forEach(s => {
            const dates = s.selected_dates ? s.selected_dates.join(';') : s.week_start;
            const tb = s.tb != null ? s.tb : ((s.h || 0) + (s.hr || 0) * 3);
            csv += fmtName(s.hitter_name) + ',' + (s.mode || 'hitter') + ',' + dates + ',' + s.pa + ',' + s.ab + ',' + s.h + ',' + s.hr + ',' + s.k + ',' + s.bb + ',' + (+tb).toFixed(1) + ',' + s.ba + ',' + s.woba + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'projections_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
    });

    // ═══ RESEARCH PAD ═══
    const pad = document.getElementById('pad');
    pad.value = localStorage.getItem('pfx_sim_notes') || '';
    let padDirty = false;
    pad.addEventListener('input', () => { padDirty = true });
    setInterval(() => { if (padDirty) { localStorage.setItem('pfx_sim_notes', pad.value); padDirty = false } }, 5000);
    document.getElementById('pad-save').addEventListener('click', () => { localStorage.setItem('pfx_sim_notes', pad.value); flash('flash-save') });
    document.getElementById('pad-copy').addEventListener('click', () => { navigator.clipboard.writeText(pad.value).then(() => flash('flash-copy')) });
    document.getElementById('pad-clear').addEventListener('click', () => { if (confirm('Clear all notes?')) { pad.value = ''; localStorage.removeItem('pfx_sim_notes') } });
    function flash(id) { const el = document.getElementById(id); el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500) }

    // ═══ UI HELPERS ═══
    function showBanner(msg) { const b = document.getElementById('status-banner'); b.textContent = msg; b.classList.add('visible') }
    function hideBanner() { document.getElementById('status-banner').classList.remove('visible') }

    // ═══ INIT ═══
    document.getElementById('loading-overlay').remove();
    if (PRESELECT) selectBatter(PRESELECT);
})();
</script>
</body>
</html>
