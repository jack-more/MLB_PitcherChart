<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIM LAB // MLB</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap');
:root {
    --bg-deep: #1A2350;
    --bg-main: #2B3A8C;
    --bg-light: #3D4DB0;
    --text-main: #FFFFFF;
    --text-muted: #8E9AFF;
    --accent: #FF4400;
    --accent-hover: #ff6a33;
    --green: #2a9d8f;
    --red: #e63946;
    --conf-1: #00c853;
    --conf-2: #66bb6a;
    --conf-3: #fdd835;
    --conf-4: #ef6c00;
    --conf-5: #b71c1c;
    --grid-unit: 8px;
    --border-radius: 0px;
    --dashed-border: 1px dashed rgba(255, 255, 255, 0.3);
    --font-stack: 'Space Mono', 'Courier New', monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
    background-color:var(--bg-main);color:var(--text-main);font-family:var(--font-stack);
    font-size:14px;line-height:1.4;min-height:100vh;overflow-x:hidden;
    background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
}
.layout-shell{display:grid;grid-template-rows:auto 1fr;height:100vh;max-width:1600px;margin:0 auto;
    border-left:1px solid rgba(0,0,0,0.2);border-right:1px solid rgba(0,0,0,0.2);box-shadow:0 0 50px rgba(0,0,0,0.5)}

/* ═══ TOP BAR ═══ */
.top-bar{display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;
    gap:0.5rem 1.5rem;padding:1rem 1.5rem;
    border-bottom:var(--dashed-border);align-items:center;background:rgba(43,58,140,0.9);
    backdrop-filter:blur(5px);z-index:100}
.brand-block{grid-column:1;grid-row:1;display:flex;align-items:center;gap:1rem}
.back-link{text-decoration:none;color:var(--text-muted);font-size:0.8rem;transition:color 0.15s}
.back-link:hover{color:var(--accent)}
.logo{font-weight:700;letter-spacing:-0.5px;font-size:1.1rem;border:1px solid var(--text-main);padding:2px 6px}
.mode-toggle{grid-column:2;grid-row:1;justify-self:end;display:flex;gap:0}
.mode-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:var(--text-muted);
    font-family:var(--font-stack);font-size:0.75rem;padding:6px 16px;cursor:pointer;transition:all 0.15s;letter-spacing:1px;border-right:none}
.mode-btn:last-child{border-right:1px solid rgba(255,255,255,0.3)}
.mode-btn.active{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.control-row{grid-column:1 / -1;grid-row:2;display:flex;gap:1rem;align-items:center}
.search-wrap{position:relative;flex:1}
.hitter-search{background:transparent;border:none;border-bottom:var(--dashed-border);color:var(--text-main);
    font-family:var(--font-stack);font-size:1rem;width:100%;padding:4px 0;text-transform:uppercase}
.hitter-search::placeholder{color:var(--text-muted);opacity:0.5}
.hitter-search:focus{outline:none;border-bottom:1px solid var(--accent)}
.s-drop{position:absolute;top:100%;left:0;width:100%;max-height:260px;overflow-y:auto;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);border-top:none;display:none;z-index:200}
.s-drop.visible{display:block}
.s-item{display:flex;justify-content:space-between;align-items:center;padding:0 14px;height:36px;
    font-size:12px;color:#eee;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05)}
.s-item:hover,.s-item.hl{background:var(--bg-light)}
.s-item .pa{color:var(--text-muted);font-size:10px}

/* ═══ CALENDAR ═══ */
.cal-wrap{position:relative}
.cal-dropdown{display:none;position:absolute;top:100%;right:0;z-index:300;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);padding:12px;
    width:280px;box-shadow:8px 8px 0px rgba(0,0,0,0.3)}
.cal-dropdown.visible{display:block}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;
    font-size:0.75rem;letter-spacing:1px;text-transform:uppercase}
.cal-arrow{cursor:pointer;color:var(--text-muted);padding:4px 8px;user-select:none}
.cal-arrow:hover{color:var(--accent)}
.cal-month{font-weight:700;color:var(--text-main)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-dow{font-size:0.55rem;color:var(--text-muted);text-align:center;padding:4px 0;
    letter-spacing:1px;font-weight:700}
.cal-day{text-align:center;padding:6px 0;font-size:0.7rem;cursor:pointer;
    border:1px solid transparent;transition:all 0.1s;font-family:var(--font-stack)}
.cal-day:hover{border-color:var(--accent)}
.cal-day.other-month{color:rgba(255,255,255,0.15);cursor:default}
.cal-day.other-month:hover{border-color:transparent}
.cal-day.today{border:1px dashed var(--text-muted)}
.cal-day.range-start,.cal-day.range-end{background:var(--accent);color:#000;font-weight:700}
.cal-day.in-range{background:rgba(255,68,0,0.25);color:var(--text-main)}
.cal-range-label{font-size:0.6rem;color:var(--text-muted);margin-top:8px;min-height:20px;text-align:center;
    padding:4px 0;letter-spacing:0.5px}
.cal-range-label .range-accent{color:var(--accent);font-weight:700}
.cal-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:8px;padding-top:8px;
    border-top:var(--dashed-border)}

.date-indicator{background:transparent;border:1px dashed rgba(255,255,255,0.25);color:var(--text-muted);
    padding:5px 12px;font-family:var(--font-stack);font-size:0.7rem;cursor:pointer;transition:all 0.15s;
    letter-spacing:0.5px;white-space:nowrap}
.date-indicator:hover{border-color:var(--accent);color:var(--accent)}
.date-indicator .di-dates{color:var(--accent);font-weight:700}
.btn-refresh{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--text-muted);
    padding:5px 12px;font-family:var(--font-stack);font-size:0.7rem;cursor:pointer;transition:all 0.15s;
    letter-spacing:0.5px;white-space:nowrap}
.btn-refresh:hover{border-color:var(--accent);color:var(--accent)}
.btn{background:transparent;border:1px solid var(--text-main);color:var(--text-main);padding:0.6rem 1.2rem;
    font-family:var(--font-stack);text-transform:uppercase;cursor:pointer;transition:all 0.2s;font-size:0.8rem}
.btn:hover{background:var(--text-main);color:var(--bg-main)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.btn-primary:hover{background:var(--accent-hover);border-color:var(--accent-hover);box-shadow:0 0 15px var(--accent)}
.btn-primary:disabled{opacity:0.3;cursor:not-allowed}
.btn-sm{padding:4px 8px;font-size:0.7rem}

/* ═══ WORKSPACE ═══ */
.workspace{display:grid;grid-template-columns:240px 1fr 340px;overflow:hidden}

/* Left: Context Column */
.col-context{padding:1.5rem;border-right:var(--dashed-border);background:rgba(0,0,0,0.1);overflow-y:auto}
.hero{margin-bottom:2rem}
.hero-name{font-size:1.8rem;line-height:1;text-transform:uppercase;word-break:break-word;margin-bottom:0.8rem;letter-spacing:2px}
.hero-meta{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:1.5rem;font-size:0.75rem;color:var(--text-muted)}
.hero-clear{font-size:0.7rem;color:var(--text-muted);cursor:pointer;margin-top:8px;display:inline-block}
.hero-clear:hover{color:var(--accent)}
.section-label{font-size:0.65rem;letter-spacing:1px;color:var(--text-muted);margin-bottom:1rem;display:flex;align-items:center;gap:0.8rem}
.section-label::after{content:'';flex:1;height:1px;border-bottom:var(--dashed-border)}
.stat-block{margin-bottom:1.5rem}
.stat-row{display:flex;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.1);padding:6px 0;font-size:0.8rem}
.stat-row .val{font-family:var(--font-stack);letter-spacing:-1px}
.stat-row .val.good{color:var(--conf-1)}.stat-row .val.bad{color:var(--conf-5)}
.conf-1{color:var(--conf-1)}.conf-2{color:var(--conf-2)}.conf-3{color:var(--conf-3)}.conf-4{color:var(--conf-4)}.conf-5{color:var(--conf-5)}
.archetype-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;margin-top:8px;
    border:1px dashed rgba(255,255,255,0.3);font-size:0.75rem}
.archetype-badge .dot{width:8px;height:8px;display:inline-block}
.no-player{color:var(--text-muted);font-size:0.85rem;font-style:italic;padding:2rem 0}

/* Game Mode Info */
.game-mode-info{display:none}
.game-mode-info p{color:var(--text-muted);font-size:0.75rem;margin-bottom:1rem;line-height:1.5}
.game-mode-info .step-list .stat-row{font-size:0.7rem}
.game-mode-info .step-list .val{font-size:0.65rem;color:var(--text-muted);text-align:right;max-width:160px}

/* Center: Slate Column */
.col-slate{padding:1.5rem;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--accent) transparent}
.status-banner{background:var(--bg-deep);border:1px solid #e76f51;padding:10px 14px;margin-bottom:12px;
    font-size:0.75rem;color:#e76f51;display:none}
.status-banner.visible{display:block}
.day-hdr{font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);
    margin-bottom:6px;padding-left:4px;margin-top:16px}
.off-day{font-size:0.75rem;font-style:italic;color:var(--text-muted);padding:6px 0}

/* Game Cards */
.game-card{display:grid;grid-template-columns:70px 1fr;background:var(--bg-light);margin-bottom:1.5rem;
    box-shadow:8px 8px 0px rgba(0,0,0,0.2);position:relative;transition:transform 0.2s}
.game-card:hover{transform:translate(-2px,-2px);box-shadow:10px 10px 0px rgba(0,0,0,0.3)}
.card-spine{background:var(--bg-deep);padding:0.8rem;display:flex;flex-direction:column;
    justify-content:center;align-items:center;text-align:center;border-right:1px solid rgba(255,255,255,0.05)}
.card-spine .vs-label{font-size:1.2rem;font-weight:bold}
.card-spine .opp-team{margin-top:8px;color:var(--text-muted);font-size:0.8rem}
.spine-mark{display:block;width:100%;border-top:1px dashed rgba(255,255,255,0.2);margin:4px 0}
.card-content{padding:1.2rem}
.matchup-header{display:flex;justify-content:space-between;margin-bottom:0.8rem;font-size:0.9rem;align-items:center}
.pitcher-info{color:var(--text-muted);font-size:0.8rem;margin-bottom:0.8rem;padding-bottom:0.8rem;border-bottom:1px dashed rgba(255,255,255,0.2)}
.gc-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
.gc-section{font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:700;margin-bottom:6px}
.gc-section.warn{color:#e76f51}
.stat-chips{display:flex;gap:6px;flex-wrap:wrap}
.sc{background:rgba(0,0,0,0.2);padding:8px 10px;text-align:center;min-width:50px;flex:1}
.sc .sl{font-size:0.5rem;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.5px;font-weight:700;margin-bottom:3px}
.sc .sv{font-size:1rem;font-weight:800}
.sc .sv.good{color:var(--conf-1)}.sc .sv.bad{color:var(--conf-5)}

/* Projections */
.proj-row{margin-top:12px;padding-top:12px;border-top:1px dashed rgba(255,255,255,0.2)}
.proj-label{font-size:0.6rem;text-transform:uppercase;color:var(--accent);font-weight:700;margin-bottom:3px}
.proj-method{font-size:0.65rem;color:var(--text-muted);font-style:italic;margin-bottom:8px}
.proj-cards{display:flex;gap:6px;flex-wrap:wrap}
.pa-edit{width:28px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);color:var(--text-main);
    font-family:var(--font-stack);font-size:1rem;font-weight:800;text-align:center;outline:none}
.pa-edit:focus{border-color:var(--accent)}

/* Lines Panel */
.lines-panel{display:block;margin-top:10px;padding-top:10px;border-top:1px dashed rgba(255,255,255,0.15)}
.lines-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.line-item{text-align:center}
.line-item label{display:block;font-size:0.5rem;color:var(--text-muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:0.5px}
.line-item .line-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.15);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.8rem;text-align:center;padding:4px 0;outline:none}
.line-item .line-input:focus{border-color:var(--accent)}
.line-item .line-input::placeholder{color:rgba(255,255,255,0.2)}
.line-item .edge{font-size:0.65rem;margin-top:2px;font-weight:700}
.line-item .edge.over{color:var(--conf-1)}.line-item .edge.under{color:var(--conf-5)}.line-item .edge.neutral{color:var(--text-muted)}

/* ═══ SOURCE BADGE & MATCHUP QUALITY ═══ */
.gc-source-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;
    padding-bottom:6px;border-bottom:1px dashed rgba(255,255,255,0.1)}
.source-badge{display:inline-flex;align-items:center;gap:6px;padding:3px 10px;font-size:0.6rem;
    font-weight:700;letter-spacing:1px;text-transform:uppercase;border:1px solid}
.source-badge.src-h2h{color:var(--conf-1);border-color:var(--conf-1);background:rgba(0,200,83,0.1)}
.source-badge.src-archetype{color:var(--conf-3);border-color:var(--conf-3);background:rgba(253,216,53,0.1)}
.source-badge.src-none{color:var(--conf-5);border-color:var(--conf-5);background:rgba(183,28,28,0.1)}
.matchup-quality{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;font-size:0.55rem;
    font-weight:800;letter-spacing:1px;text-transform:uppercase}
.matchup-quality.mq-1{color:var(--conf-1);border:1px solid var(--conf-1)}
.matchup-quality.mq-2{color:var(--conf-2);border:1px solid var(--conf-2)}
.matchup-quality.mq-3{color:var(--conf-3);border:1px solid var(--conf-3)}
.matchup-quality.mq-4{color:var(--conf-4);border:1px solid var(--conf-4)}
.matchup-quality.mq-5{color:var(--conf-5);border:1px solid var(--conf-5)}

/* ═══ STAT BAR (replaces gc-grid) ═══ */
.gc-stat-bar{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
.gc-stat-bar .sc{min-width:44px;flex:1}

/* ═══ PROPS LABEL ═══ */
.props-label{font-size:0.6rem;color:var(--accent);font-weight:700;letter-spacing:1px;
    text-transform:uppercase;margin-top:10px;margin-bottom:6px}

/* ═══ ARCHETYPE CONTEXT (sidebar) ═══ */
.archetype-context{margin-top:1.5rem}
.archetype-context .arch-title{display:flex;align-items:center;gap:8px;margin-bottom:8px;
    font-size:0.85rem;font-weight:700}
.archetype-context .arch-title .dot{width:10px;height:10px;display:inline-block}
.archetype-context .arch-detail{font-size:0.7rem;color:var(--text-muted);margin-bottom:4px}

/* ═══ QUICK SCAN ═══ */
.quick-scan{background:var(--bg-deep);border:2px solid var(--accent);padding:14px;margin-bottom:20px}
.qs-title{font-size:0.65rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;
    color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:8px}
.qs-title::after{content:'';flex:1;height:1px;border-bottom:1px dashed var(--accent)}
.qs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px}
.qs-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.08);transition:background 0.15s}
.qs-item:hover{background:rgba(255,255,255,0.06)}
.qs-edge{font-size:0.65rem;font-weight:800;letter-spacing:0.5px;min-width:50px;text-align:center;
    padding:3px 6px}
.qs-edge.over{color:#000;background:var(--conf-1)}
.qs-edge.under{color:#000;background:var(--conf-5)}
.qs-edge.edge-strong{background:var(--conf-1)}.qs-edge.edge-good{background:var(--conf-2)}
.qs-edge.edge-mild{background:var(--conf-3)}.qs-edge.edge-slim{background:var(--conf-4)}.qs-edge.edge-neg{background:var(--conf-5)}
.qs-detail{flex:1;min-width:0}
.qs-detail .qs-player{font-size:0.7rem;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.qs-detail .qs-info{font-size:0.55rem;color:var(--text-muted);letter-spacing:0.5px}
.qs-section{font-size:0.55rem;color:var(--text-muted);font-weight:700;letter-spacing:1px;
    text-transform:uppercase;margin:10px 0 6px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.1)}
.qs-section:first-child{border-top:none;margin-top:0;padding-top:0}

/* ═══ RECENCY BADGE ═══ */
.recency-row{display:flex;gap:4px;margin-top:4px}
.recency-chip{font-size:0.5rem;padding:2px 6px;letter-spacing:0.5px;background:rgba(0,0,0,0.2)}
.recency-chip .rc-label{color:var(--text-muted)}.recency-chip .rc-val{font-weight:700}
.recency-chip.rc-hot .rc-val{color:var(--conf-1)}.recency-chip.rc-cold .rc-val{color:var(--conf-5)}

/* ═══ PITCHER OVERRIDE ═══ */
.pitcher-name-wrap{display:inline-flex;align-items:center;gap:6px}
.pitcher-edit-icon{font-size:0.7rem;color:var(--text-muted);cursor:pointer;opacity:0.5;transition:all 0.15s}
.pitcher-edit-icon:hover{color:var(--accent);opacity:1}
.pitcher-override-badge{display:flex;justify-content:space-between;align-items:center;
    background:rgba(255,68,0,0.1);border:1px dashed var(--accent);padding:3px 8px;margin-bottom:6px;
    font-size:0.55rem;letter-spacing:1px;color:var(--accent);text-transform:uppercase}
.pitcher-reset{cursor:pointer;font-weight:700}
.pitcher-reset:hover{color:var(--text-main)}
.pitcher-override-search{position:relative;margin-bottom:8px}
.po-search-input{width:100%;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.75rem;padding:6px 8px;outline:none}
.po-search-input:focus{border-color:var(--accent)}
.po-drop{position:absolute;top:100%;left:0;width:100%;max-height:180px;overflow-y:auto;
    background:var(--bg-deep);border:1px solid rgba(255,255,255,0.2);border-top:none;display:none;z-index:200}
.po-drop.visible{display:block}

/* ═══ GAME TOTAL CARDS ═══ */
.game-total-card{display:grid;grid-template-columns:80px 1fr;background:var(--bg-light);margin-bottom:1.5rem;
    box-shadow:8px 8px 0px rgba(0,0,0,0.2);position:relative;transition:transform 0.2s}
.game-total-card:hover{transform:translate(-2px,-2px);box-shadow:10px 10px 0px rgba(0,0,0,0.3)}
.gt-spine{background:var(--bg-deep);padding:0.8rem;display:flex;flex-direction:column;
    justify-content:center;align-items:center;text-align:center;border-right:1px solid rgba(255,255,255,0.05)}
.gt-spine .gt-total{font-size:1.6rem;font-weight:900;color:var(--accent)}
.gt-spine .gt-label{font-size:0.5rem;color:var(--text-muted);letter-spacing:1px;margin-top:4px}
.gt-content{padding:1rem}
.gt-matchup{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-size:0.85rem;font-weight:700}
.gt-pitchers{font-size:0.7rem;color:var(--text-muted);margin-bottom:10px;padding-bottom:8px;border-bottom:1px dashed rgba(255,255,255,0.2)}
.gt-pitchers .sp-name{color:var(--text-main)}
.gt-sides{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
.gt-side{text-align:center}
.gt-side-label{font-size:0.55rem;color:var(--text-muted);letter-spacing:1px;margin-bottom:4px;font-weight:700}
.gt-side-runs{font-size:1.4rem;font-weight:900;margin-bottom:6px}
.gt-side-stats{display:flex;gap:4px;justify-content:center;flex-wrap:wrap}
.gt-side-stats .mini-stat{font-size:0.55rem;color:var(--text-muted);background:rgba(0,0,0,0.2);padding:2px 6px}
.gt-side-stats .mini-stat span{color:var(--text-main);font-weight:700}
.gt-line-row{display:flex;align-items:center;gap:12px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.15)}
.gt-line-row label{font-size:0.55rem;color:var(--text-muted);letter-spacing:1px;white-space:nowrap}
.gt-line-row .line-input{width:60px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.15);
    color:var(--text-main);font-family:var(--font-stack);font-size:0.85rem;text-align:center;padding:4px 0;outline:none}
.gt-line-row .line-input:focus{border-color:var(--accent)}
.gt-line-row .line-input::placeholder{color:rgba(255,255,255,0.2)}
.gt-coverage{font-size:0.55rem;color:var(--text-muted);margin-top:6px;letter-spacing:0.5px}
.gt-coverage .cov-good{color:var(--conf-1)}.gt-coverage .cov-warn{color:var(--conf-4)}
.gt-lineup-toggle{font-size:0.55rem;color:var(--text-muted);cursor:pointer;margin-top:8px;
    letter-spacing:1px;text-transform:uppercase}
.gt-lineup-toggle:hover{color:var(--accent)}
.gt-lineup-detail{display:none;margin-top:8px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.1)}
.gt-lineup-detail.visible{display:block}
.gt-lineup-section{font-size:0.55rem;color:var(--accent);font-weight:700;letter-spacing:1px;margin:6px 0 4px}
.gt-batter-row{display:flex;justify-content:space-between;font-size:0.6rem;padding:2px 0;
    border-bottom:1px solid rgba(255,255,255,0.05)}
.gt-batter-row .batter-name{max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.gt-batter-row .batter-stats{color:var(--text-muted)}
.gt-batter-row .batter-stats span{color:var(--text-main);font-weight:700}
.gt-batter-row .batter-src{font-size:0.5rem;color:var(--text-muted);font-style:italic}
.gt-tbd{text-align:center;padding:16px 0;color:var(--text-muted);font-size:0.75rem;font-style:italic}

/* Totals */
.totals-box{background:var(--bg-deep);border:2px solid var(--accent);padding:16px;margin-top:20px}
.totals-title{font-size:0.7rem;text-transform:uppercase;letter-spacing:2px;color:var(--accent);font-weight:800;margin-bottom:12px}
.totals-row{display:flex;gap:8px;flex-wrap:wrap}
.totals-row .sc{min-width:70px;padding:10px 12px}.totals-row .sc .sv{font-size:1.2rem}
.btn-save{display:block;margin:14px auto 0;width:100%}

/* Right: Research Column */
.col-research{background:rgba(0,0,0,0.2);border-left:var(--dashed-border);display:grid;
    grid-template-rows:auto 1fr auto;overflow:hidden}
.research-panel{padding:1.2rem;border-bottom:var(--dashed-border)}
.research-panel .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.csv-table{width:100%;border-collapse:collapse;font-size:0.72rem;margin-top:8px}
.csv-table th{text-align:center;color:var(--text-muted);padding:5px 4px;border-bottom:1px solid rgba(255,255,255,0.1);font-size:0.6rem;letter-spacing:0.5px}
.csv-table th:first-child{text-align:left}
.csv-table td{padding:5px 4px;border-bottom:1px dashed rgba(255,255,255,0.1);text-align:center;font-size:0.72rem}
.csv-table td:first-child{text-align:left;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.csv-table .del{color:var(--text-muted);cursor:pointer;font-size:0.8rem}.csv-table .del:hover{color:var(--red)}
.empty-msg{text-align:center;color:var(--text-muted);font-size:0.75rem;padding:20px 0}
.notes-area{width:100%;height:100%;background:transparent;border:none;color:var(--text-main);
    font-family:var(--font-stack);font-size:0.8rem;padding:1.2rem;resize:none}
.notes-area:focus{outline:none;background:rgba(255,255,255,0.02)}
.notes-area::placeholder{color:var(--text-muted)}
.totals-dock{padding:1.2rem;background:var(--bg-deep);border-top:1px solid rgba(255,255,255,0.1)}
.pad-btns{display:flex;gap:6px;margin-top:8px;padding:0 1.2rem 1.2rem}
.pad-btn{background:transparent;border:1px solid rgba(255,255,255,0.2);color:var(--text-muted);
    font-family:var(--font-stack);font-size:0.65rem;padding:4px 10px;cursor:pointer;transition:all 0.15s}
.pad-btn:hover{border-color:var(--accent);color:var(--accent)}
.pad-btn.primary{background:var(--accent);border-color:var(--accent);color:#000}
.flash{font-size:0.6rem;color:var(--green);margin-left:6px;opacity:0;transition:opacity 0.3s}
.flash.show{opacity:1}
.text-accent{color:var(--accent)}.text-right{text-align:right}.mono{font-family:var(--font-stack);letter-spacing:-1px}

/* ═══ TEAM LINEUP CARDS ═══ */
.team-game-card{background:var(--bg-light);margin-bottom:1.5rem;box-shadow:8px 8px 0px rgba(0,0,0,0.2);
    position:relative;transition:transform 0.2s}
.team-game-card:hover{transform:translate(-2px,-2px);box-shadow:10px 10px 0px rgba(0,0,0,0.3)}
.tg-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;
    border-bottom:1px dashed rgba(255,255,255,0.2);font-size:0.85rem;font-weight:700}
.tg-pitcher-info{padding:0.6rem 1.2rem;font-size:0.7rem;color:var(--text-muted);
    border-bottom:1px dashed rgba(255,255,255,0.15)}
.tg-pitcher-info .sp-name{color:var(--text-main);font-weight:700}
.tg-lineup-header{display:grid;grid-template-columns:30px 1fr 50px 50px 50px 50px 50px;gap:4px;
    padding:6px 1.2rem;font-size:0.55rem;color:var(--text-muted);letter-spacing:1px;font-weight:700;
    border-bottom:1px solid rgba(255,255,255,0.1)}
.tg-batter{display:grid;grid-template-columns:30px 1fr 50px 50px 50px 50px 50px;gap:4px;
    padding:6px 1.2rem;font-size:0.75rem;border-bottom:1px solid rgba(255,255,255,0.05);align-items:center}
.tg-batter:hover{background:rgba(255,255,255,0.03)}
.tg-batter .order{color:var(--accent);font-weight:700;font-size:0.7rem}
.tg-batter .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tg-batter .stat{text-align:center;font-family:var(--font-stack);letter-spacing:-1px}
.tg-batter .src{font-size:0.5rem;color:var(--text-muted);font-style:italic;text-align:center}
.tg-bench-toggle{font-size:0.6rem;color:var(--text-muted);cursor:pointer;padding:8px 1.2rem;
    letter-spacing:1px;text-transform:uppercase;border-bottom:1px dashed rgba(255,255,255,0.1)}
.tg-bench-toggle:hover{color:var(--accent)}
.tg-bench-section{display:none}
.tg-bench-section.visible{display:block}
.tg-batter.bench{opacity:0.5}
.tg-batter.bench .order{color:var(--text-muted)}
.tg-bench-tag{font-size:0.5rem;background:rgba(255,255,255,0.1);padding:1px 5px;letter-spacing:1px;color:var(--text-muted)}
.tg-totals{display:flex;gap:6px;flex-wrap:wrap;padding:1rem 1.2rem;border-top:2px solid var(--accent);background:var(--bg-deep)}
.tg-totals .sc{min-width:60px}.tg-totals .sc .sv{font-size:1rem}
.tg-runs-badge{background:var(--accent);color:#000;font-weight:900;font-size:1.3rem;padding:8px 14px;
    text-align:center;min-width:70px}
.tg-runs-label{font-size:0.5rem;letter-spacing:1px;font-weight:700;margin-top:2px}

/* Status Banner Loading */
.status-banner.loading{display:block;background:rgba(26,35,80,0.8);border-color:var(--accent);color:var(--accent);
    text-align:center;letter-spacing:2px;animation:pulse-load 1.5s ease-in-out infinite}
@keyframes pulse-load{0%,100%{opacity:0.5}50%{opacity:1}}

/* Empty State */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:4rem 2rem;text-align:center;color:var(--text-muted)}
.empty-state .es-arrow{font-size:2rem;color:var(--accent);margin-bottom:1rem}
.empty-state .es-title{font-size:0.85rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:0.5rem;color:var(--text-main)}
.empty-state .es-sub{font-size:0.7rem;letter-spacing:1px;line-height:1.6}

/* Loading */
#loading-overlay{position:fixed;inset:0;background:var(--bg-deep);display:flex;align-items:center;
    justify-content:center;z-index:999;flex-direction:column;gap:16px}
#loading-overlay .load-title{font-size:20px;font-weight:700;color:var(--accent);font-family:var(--font-stack)}
#loading-overlay .load-sub{font-size:10px;color:var(--text-muted);font-family:var(--font-stack);letter-spacing:2px}
#load-status{font-size:11px;color:var(--text-muted);font-family:var(--font-stack)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg-deep)}
::-webkit-scrollbar-thumb{background:var(--text-muted)}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* Responsive */
@media(max-width:1100px){.workspace{grid-template-columns:1fr}.col-context,.col-research{display:none}
    .top-bar{grid-template-columns:1fr;grid-template-rows:auto auto auto}
    .mode-toggle{grid-column:1;grid-row:2;justify-self:start}
    .control-row{grid-column:1;grid-row:3}}
</style>
</head>
<body>
<div id="loading-overlay">
  <div class="load-title">SIM LAB</div>
  <div class="load-sub">ATLAS // MLB</div>
  <div id="load-status">Loading data...</div>
</div>

<div class="layout-shell">
  <!-- TOP BAR -->
  <header class="top-bar">
    <div class="brand-block">
      <a href="cosmos.html" class="back-link">&larr; ATLAS</a>
      <div class="logo">SIM LAB</div>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-hitter" data-mode="hitter">HITTER</button>
      <button class="mode-btn" id="mode-pitcher" data-mode="pitcher">PITCHER</button>
      <button class="mode-btn" id="mode-game" data-mode="game">GAME</button>
      <button class="mode-btn" id="mode-team" data-mode="team">TEAM</button>
    </div>
    <div class="control-row">
      <div class="search-wrap">
        <input type="text" class="hitter-search" id="search" placeholder="SEARCH HITTER..." autocomplete="off">
        <div class="s-drop" id="s-drop"></div>
      </div>
      <div class="cal-wrap" id="cal-wrap">
        <button class="date-indicator" id="cal-trigger">
          <span id="cal-trigger-label">UPCOMING</span>
        </button>
        <div class="cal-dropdown" id="cal-dropdown">
          <div class="cal-nav">
            <span class="cal-arrow" id="cal-prev">&larr;</span>
            <span class="cal-month" id="cal-month-label"></span>
            <span class="cal-arrow" id="cal-next">&rarr;</span>
          </div>
          <div class="cal-grid" id="cal-grid"></div>
          <div class="cal-range-label" id="cal-range-label"></div>
          <div class="cal-actions">
            <button class="btn btn-sm" id="cal-clear">CLEAR</button>
            <button class="btn btn-sm btn-primary" id="cal-done">APPLY</button>
          </div>
        </div>
      </div>
      <button class="btn-refresh" id="btn-run">&circlearrowright; REFRESH</button>
    </div>
  </header>

  <!-- WORKSPACE -->
  <main class="workspace">
    <!-- Left: Context -->
    <aside class="col-context">
      <div id="player-context">
        <div class="no-player" id="no-player">Search a player to begin.</div>
        <!-- Hitter hero -->
        <div class="hero" id="hitter-hero" style="display:none">
          <div class="hero-name" id="hero-name"></div>
          <div class="hero-meta" id="hero-meta"></div>
          <span class="hero-clear" id="hc-clear">&times; CLEAR</span>
        </div>
        <!-- Pitcher hero -->
        <div class="hero" id="pitcher-hero" style="display:none">
          <div class="hero-name" id="pitcher-hero-name"></div>
          <div class="hero-meta" id="pitcher-hero-meta"></div>
          <div id="pitcher-archetype-badge"></div>
          <span class="hero-clear" id="pc-clear">&times; CLEAR</span>
        </div>
        <!-- Team hero -->
        <div class="hero" id="team-hero" style="display:none">
          <div class="hero-name" id="team-hero-name"></div>
          <div class="hero-meta" id="team-hero-meta"></div>
          <span class="hero-clear" id="tc-clear">&times; CLEAR</span>
        </div>
        <!-- Game mode info -->
        <div class="game-mode-info" id="game-mode-info">
          <div class="section-label">GAME MODE</div>
          <p>Select a date range and RUN SLATE to project game totals for all MLB games. Uses archetype matchup data to estimate team runs via BaseRuns model.</p>
          <div class="section-label">HOW IT WORKS</div>
          <div class="stat-block step-list">
            <div class="stat-row"><span>1.</span><span class="val">Fetch lineups from MLB API</span></div>
            <div class="stat-row"><span>2.</span><span class="val">Project each batter vs opposing SP archetype</span></div>
            <div class="stat-row"><span>3.</span><span class="val">Sum team H/HR/BB/TB &rarr; BaseRuns</span></div>
            <div class="stat-row"><span>4.</span><span class="val">Compare projected total to O/U line</span></div>
          </div>
          <div id="game-mode-summary" style="display:none">
            <div class="section-label">SLATE SUMMARY</div>
            <div id="game-summary-stats"></div>
          </div>
        </div>
      </div>
      <div id="context-stats"></div>
    </aside>

    <!-- Center: Slate -->
    <section class="col-slate">
      <div class="section-label" id="slate-label">AVAILABLE MATCHUPS // EDITABLE PA</div>
      <div class="status-banner" id="status-banner"></div>
      <div class="empty-state" id="empty-state">
        <div class="es-arrow">&rarr;</div>
        <div class="es-title">SEARCH A PLAYER</div>
        <div class="es-sub">OR SWITCH TO GAME MODE FOR<br>TODAY'S FULL SLATE</div>
      </div>
      <div id="slate"></div>
    </section>

    <!-- Right: Research -->
    <aside class="col-research">
      <div class="research-panel">
        <div class="hdr">
          <div class="section-label" style="margin:0">SAVED PROJECTIONS</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm" id="btn-clear-all">CLEAR</button>
            <button class="btn btn-sm" id="btn-export">CSV</button>
          </div>
        </div>
        <table class="csv-table">
          <thead><tr><th>PLAYER</th><th>DATES</th><th>H</th><th>HR</th><th>K</th><th>TB</th><th></th></tr></thead>
          <tbody id="saved-rows"></tbody>
        </table>
        <div class="empty-msg" id="empty-msg">No saved projections yet.</div>
      </div>
      <textarea class="notes-area" id="pad" placeholder="RESEARCH NOTES // TYPE HERE..."></textarea>
      <div class="pad-btns">
        <button class="pad-btn primary" id="pad-save">Save<span class="flash" id="flash-save">OK</span></button>
        <button class="pad-btn" id="pad-copy">Copy<span class="flash" id="flash-copy">OK</span></button>
        <button class="pad-btn" id="pad-clear">Clear</button>
      </div>
      <div class="totals-dock" id="totals-dock" style="display:none">
        <div class="section-label">SLATE AGGREGATE</div>
        <div id="dock-stats"></div>
        <button class="btn" style="width:100%;margin-top:10px" id="btn-save-dock">SAVE PROJECTION</button>
      </div>
    </aside>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script>
// ═══ DATA ═══
const DATA = { pitcherSeasons: [], hitterVsCluster: [], hitterVsPitcher: [], clusters: {}, batters: [], archetypeKings: {}, teamRosters: {} };

const MLB_TEAM_IDS = {
    'BAL':110,'BOS':111,'NYY':147,'TB':139,'TOR':141,
    'CLE':114,'CWS':145,'DET':116,'KC':118,'MIN':142,
    'HOU':117,'LAA':108,'OAK':133,'SEA':136,'TEX':140,
    'ATL':144,'MIA':146,'NYM':121,'PHI':143,'WSH':120,
    'CHC':112,'CIN':113,'MIL':158,'PIT':134,'STL':138,
    'ARI':109,'COL':115,'LAD':119,'SD':135,'SF':137
};

// ═══ STATE ═══
let currentMode = 'hitter';
let selectedBatter = null;
let selectedPitcher = null;
let selectedTeam = null;
let teamId = null;
let schedule = [];
let projections = [];
let calRangeStart = null;
let calRangeEnd = null;
let calViewYear, calViewMonth;
let _autoRunId = 0;
let _autoScheduleCache = null;

// ═══ LOAD DATA ═══
async function loadData() {
    const status = document.getElementById('load-status');
    const update = (msg) => { if (status) status.textContent = msg; };
    update('Loading cluster profiles...');
    const [clusters, batters, pitcherSeasons, hvc, hvp, kings, teamRosters] = await Promise.all([
        fetch('clusters.json').then(r => r.json()),
        fetch('batters.json').then(r => r.json()),
        fetch('pitcher_seasons.json').then(r => r.json()),
        fetch('hitter_vs_cluster.json').then(r => r.json()),
        fetch('hitter_vs_pitcher.json').then(r => r.json()).catch(() => []),
        fetch('archetype_kings.json').then(r => r.json()).catch(() => {}),
        fetch('teams_2026.json').then(r => r.json()).catch(() => ({ teams: {}, rosters: {} })),
    ]);
    Object.assign(DATA, { clusters, batters, pitcherSeasons, hitterVsCluster: hvc, hitterVsPitcher: hvp, archetypeKings: kings, teamRosters });
    update('Building indexes...');
    DATA._hvpIndex = {};
    (DATA.hitterVsPitcher || []).forEach(r => {
        if (!DATA._hvpIndex[r.b]) DATA._hvpIndex[r.b] = {};
        if (!DATA._hvpIndex[r.b][r.c]) DATA._hvpIndex[r.b][r.c] = [];
        DATA._hvpIndex[r.b][r.c].push(r);
    });
}

// ═══ HELPERS ═══
function fmtName(n){if(!n)return'Unknown';return n.split(' ').map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(' ')}
function baColor(v){if(v>=0.300)return'conf-1';if(v>=0.270)return'conf-2';if(v>=0.230)return'conf-3';if(v>=0.200)return'conf-4';return'conf-5'}
function wobaColor(v){if(v>=0.370)return'conf-1';if(v>=0.340)return'conf-2';if(v>=0.310)return'conf-3';if(v>=0.280)return'conf-4';return'conf-5'}
function nextMonday(){const d=new Date();const day=d.getDay();const diff=day===0?1:(8-day);d.setDate(d.getDate()+diff);return d.toISOString().split('T')[0]}
function fmtDate(s){const d=new Date(s+'T12:00:00');return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}).toUpperCase()}
function archName(clusterId){const c=DATA.clusters[clusterId];return c?(c.short_name||c.full_name||clusterId):clusterId}
function archEmoji(clusterId){const c=DATA.clusters[clusterId];return c&&c.emoji?c.emoji:''}
function sc(label,val){return '<div class="sc"><div class="sl">'+label+'</div><div class="sv">'+val+'</div></div>'}
function scC(label,val,cls){return '<div class="sc"><div class="sl">'+label+'</div><div class="sv '+(cls||'')+'">'+val+'</div></div>'}

function edgeLabel(proj, line) {
    if (line === '' || line == null || isNaN(line)) return '<span class="edge neutral">&mdash;</span>';
    const diff = proj - parseFloat(line);
    const pct = parseFloat(line) > 0 ? Math.abs(diff / parseFloat(line) * 100) : 0;
    if (diff > 0) return '<span class="edge over">OVER +' + pct.toFixed(0) + '%</span>';
    if (diff < 0) return '<span class="edge under">UNDER ' + pct.toFixed(0) + '%</span>';
    return '<span class="edge neutral">PUSH</span>';
}

function getSelectedDates() {
    if (!calRangeStart) return [];
    if (!calRangeEnd) return [calRangeStart];
    const dates = [];
    let d = new Date(calRangeStart + 'T12:00:00');
    const end = new Date(calRangeEnd + 'T12:00:00');
    while (d <= end) {
        dates.push(d.toISOString().split('T')[0]);
        d.setDate(d.getDate() + 1);
    }
    return dates;
}

function countDaysInRange() {
    if (!calRangeStart || !calRangeEnd) return calRangeStart ? 1 : 0;
    const s = new Date(calRangeStart + 'T12:00:00');
    const e = new Date(calRangeEnd + 'T12:00:00');
    return Math.round((e - s) / 86400000) + 1;
}

// ═══ CALENDAR ═══
function renderCalendar() {
    const monthNames = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
    document.getElementById('cal-month-label').textContent = monthNames[calViewMonth] + ' ' + calViewYear;
    const firstDay = new Date(calViewYear, calViewMonth, 1).getDay();
    const daysInMonth = new Date(calViewYear, calViewMonth + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];
    let html = '<div class="cal-dow">SU</div><div class="cal-dow">MO</div><div class="cal-dow">TU</div><div class="cal-dow">WE</div><div class="cal-dow">TH</div><div class="cal-dow">FR</div><div class="cal-dow">SA</div>';
    for (let i = 0; i < firstDay; i++) html += '<div class="cal-day other-month"></div>';
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = calViewYear + '-' + String(calViewMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
        let cls = 'cal-day';
        if (dateStr === todayStr) cls += ' today';
        if (dateStr === calRangeStart) cls += ' range-start';
        else if (dateStr === calRangeEnd) cls += ' range-end';
        else if (calRangeStart && calRangeEnd && dateStr > calRangeStart && dateStr < calRangeEnd) cls += ' in-range';
        html += '<div class="' + cls + '" data-date="' + dateStr + '">' + d + '</div>';
    }
    const totalCells = firstDay + daysInMonth;
    const trailing = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 0; i < trailing; i++) html += '<div class="cal-day other-month"></div>';
    document.getElementById('cal-grid').innerHTML = html;
    renderRangeLabel();
    updateCalTriggerLabel();
}

function renderRangeLabel() {
    const container = document.getElementById('cal-range-label');
    if (!calRangeStart) {
        container.innerHTML = 'Click a start date';
        return;
    }
    if (!calRangeEnd) {
        container.innerHTML = '<span class="range-accent">' + fmtDate(calRangeStart) + '</span> &rarr; <span style="opacity:0.5">click end date</span>';
        return;
    }
    const days = countDaysInRange();
    container.innerHTML = '<span class="range-accent">' + fmtDate(calRangeStart) + '</span> &rarr; <span class="range-accent">' + fmtDate(calRangeEnd) + '</span> (' + days + ' day' + (days > 1 ? 's' : '') + ')';
}

function updateCalTriggerLabel() {
    const label = document.getElementById('cal-trigger-label');
    if (!calRangeStart) {
        label.innerHTML = 'UPCOMING';
    } else if (!calRangeEnd) {
        label.innerHTML = '<span class="di-dates">' + fmtDate(calRangeStart) + '</span>';
    } else {
        label.innerHTML = '<span class="di-dates">' + fmtDate(calRangeStart) + ' \u2192 ' + fmtDate(calRangeEnd) + '</span>';
    }
}

// ═══ BASERUNS ═══
function baseRuns(teamH, teamHR, teamBB, teamTB, teamPA) {
    const A = teamH + teamBB - teamHR;
    const B = 1.02 * (1.4 * teamTB - 0.6 * teamH + 0.1 * teamBB);
    const C = (teamPA || 36) - teamH - teamBB;
    const D = teamHR;
    if (B + C === 0) return D;
    return Math.max(0, A * B / (B + C) + D);
}

// ═══ PROJECT TEAM ═══
function projectTeam(lineupIds, opposingPitcherId, paOverride) {
    const ps = DATA.pitcherSeasons
        .filter(p => p.pitcher === opposingPitcherId)
        .sort((a, b) => b.game_year - a.game_year)[0] || null;
    const cluster = ps ? ps.cluster : null;

    let teamH = 0, teamHR = 0, teamBB = 0, teamK = 0, teamTB = 0, teamPA = 0;
    let coverage = 0;
    const batterDetails = [];

    lineupIds.forEach((batterId) => {
        const assumedPA = paOverride || 4;
        let projH = 0, projHR = 0, projK = 0, projBB = 0, projTB = 0;
        let source = 'none';
        let batterName = 'Unknown';

        // Find batter name
        const batter = DATA.batters.find(b => b.batter === batterId);
        if (batter) batterName = batter.batter_name;

        // 1. Try head-to-head
        if (opposingPitcherId && DATA._hvpIndex[batterId]) {
            const allMatchups = Object.values(DATA._hvpIndex[batterId]).flat();
            const h2h = allMatchups.find(m => m.p === opposingPitcherId);
            if (h2h && h2h.pa >= 10) {
                const ba = h2h.ba || 0;
                const bbRate = h2h.pa > 0 ? (h2h.bb || 0) / h2h.pa : 0;
                const kRate = h2h.pa > 0 ? (h2h.k || 0) / h2h.pa : 0;
                const hrRate = h2h.pa > 0 ? (h2h.hr || 0) / h2h.pa : 0;
                const estAB = assumedPA * (1 - bbRate);
                projH = ba * estAB;
                projHR = hrRate * assumedPA;
                projK = kRate * assumedPA;
                projBB = bbRate * assumedPA;
                projTB = projH + projHR * 3;
                source = 'h2h';
                coverage++;
            }
        }

        // 2. Try archetype match
        if (source === 'none' && cluster !== null) {
            const archRows = DATA.hitterVsCluster.filter(r =>
                r.batter === batterId && String(r.cluster) === cluster
            );
            if (archRows.length > 0) {
                const tot = { PA: 0, H: 0, HR: 0, BB: 0, K: 0, singles: 0, doubles: 0, triples: 0 };
                archRows.forEach(r => {
                    tot.PA += r.PA || 0; tot.H += r.H || 0; tot.HR += r.HR || 0;
                    tot.BB += r.BB || 0; tot.K += r.K || 0;
                    tot.singles += r.singles || 0; tot.doubles += r.doubles || 0; tot.triples += r.triples || 0;
                });
                if (tot.PA >= 5) {
                    const baRate = (tot.PA - tot.BB) > 0 ? tot.H / (tot.PA - tot.BB) : 0;
                    const bbRate = tot.PA > 0 ? tot.BB / tot.PA : 0;
                    const kRate = tot.PA > 0 ? tot.K / tot.PA : 0;
                    const hrRate = tot.PA > 0 ? tot.HR / tot.PA : 0;
                    const tbTotal = tot.singles + (tot.doubles * 2) + (tot.triples * 3) + (tot.HR * 4);
                    const tbRate = tot.PA > 0 ? tbTotal / tot.PA : 0;
                    const estAB = assumedPA * (1 - bbRate);
                    projH = baRate * estAB;
                    projHR = hrRate * assumedPA;
                    projK = kRate * assumedPA;
                    projBB = bbRate * assumedPA;
                    projTB = tbRate * assumedPA;
                    source = 'archetype';
                    coverage++;
                }
            }
        }

        teamH += projH; teamHR += projHR; teamBB += projBB; teamK += projK; teamTB += projTB;
        teamPA += assumedPA;
        batterDetails.push({ batterId, name: batterName, projH, projHR, projK, projBB, projTB, source });
    });

    const runs = baseRuns(teamH, teamHR, teamBB, teamTB, teamPA);
    return { teamH, teamHR, teamBB, teamK, teamTB, teamPA, runs, coverage, total: lineupIds.length, batterDetails };
}

// ═══ BOOT ═══
(async function boot() {
    await loadData();

    const params = new URLSearchParams(window.location.search);
    const batterIdParam = params.get('batter');
    const pitcherIdParam = params.get('pitcher');
    let PRESELECT = null;
    if (batterIdParam) PRESELECT = DATA.batters.find(b => b.batter === parseInt(batterIdParam)) || null;

    // ═══ MODE TOGGLE ═══
    const modeHitter = document.getElementById('mode-hitter');
    const modePitcher = document.getElementById('mode-pitcher');
    const modeGame = document.getElementById('mode-game');
    const modeTeam = document.getElementById('mode-team');
    const searchInput = document.getElementById('search');

    function setMode(mode) {
        currentMode = mode;
        modeHitter.classList.toggle('active', mode === 'hitter');
        modePitcher.classList.toggle('active', mode === 'pitcher');
        modeGame.classList.toggle('active', mode === 'game');
        modeTeam.classList.toggle('active', mode === 'team');
        searchInput.value = '';
        document.getElementById('s-drop').classList.remove('visible');

        // Hide all heroes
        document.getElementById('hitter-hero').style.display = 'none';
        document.getElementById('pitcher-hero').style.display = 'none';
        document.getElementById('team-hero').style.display = 'none';
        document.getElementById('game-mode-info').style.display = 'none';
        document.getElementById('no-player').style.display = 'none';

        if (mode === 'game') {
            searchInput.placeholder = 'FILTER BY TEAM...';
            document.getElementById('slate-label').textContent = 'GAME PROJECTIONS // O/U RUNS';
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('game-mode-info').style.display = 'block';
            document.getElementById('context-stats').innerHTML = '';
            autoRunDefault('game');
        } else if (mode === 'team') {
            searchInput.placeholder = 'SEARCH TEAM...';
            document.getElementById('slate-label').textContent = 'TEAM LINEUP PROJECTIONS';
            document.getElementById('context-stats').innerHTML = '';
            if (!selectedTeam) {
                document.getElementById('empty-state').style.display = 'flex';
            } else {
                document.getElementById('team-hero').style.display = 'block';
                document.getElementById('empty-state').style.display = 'none';
            }
        } else {
            searchInput.placeholder = mode === 'hitter' ? 'SEARCH HITTER...' : 'SEARCH PITCHER...';
            document.getElementById('slate-label').textContent = mode === 'hitter'
                ? 'AVAILABLE MATCHUPS // EDITABLE PA'
                : 'OPPOSING LINEUP // MATCHUP DATA';
            if (!selectedBatter && !selectedPitcher) {
                document.getElementById('empty-state').style.display = 'flex';
            }
        }
    }
    modeHitter.addEventListener('click', () => setMode('hitter'));
    modePitcher.addEventListener('click', () => setMode('pitcher'));
    modeGame.addEventListener('click', () => setMode('game'));
    modeTeam.addEventListener('click', () => setMode('team'));

    // ═══ SEARCH ═══
    const fuseHitters = new Fuse(DATA.batters, { keys: ['batter_name'], threshold: 0.3 });

    const pitcherMap = {};
    DATA.pitcherSeasons.forEach(ps => {
        if (!pitcherMap[ps.pitcher] || ps.game_year > pitcherMap[ps.pitcher].game_year) {
            pitcherMap[ps.pitcher] = ps;
        }
    });
    const pitcherList = Object.values(pitcherMap);
    const fusePitchers = new Fuse(pitcherList, { keys: ['player_name'], threshold: 0.3 });

    // Team search index
    const teamList = Object.entries(DATA.teamRosters.teams || {})
        .filter(([a]) => !a.startsWith('WBC-'))
        .map(([abbr, info]) => ({ abbr, name: info.name, lg: info.lg, div: info.div }));
    const fuseTeams = new Fuse(teamList, { keys: ['abbr', 'name'], threshold: 0.3 });

    const sDrop = document.getElementById('s-drop');
    let sResults = [], sHighlight = 0;

    searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim();
        if (currentMode === 'game') { sDrop.classList.remove('visible'); return; }
        if (q.length < 2) { sDrop.classList.remove('visible'); sResults = []; return; }
        if (currentMode === 'team') {
            sResults = fuseTeams.search(q).slice(0, 8).map(r => r.item);
        } else if (currentMode === 'hitter') {
            sResults = fuseHitters.search(q).slice(0, 8).map(r => r.item);
        } else {
            sResults = fusePitchers.search(q).slice(0, 8).map(r => r.item);
        }
        sHighlight = 0;
        renderSearchResults();
    });
    searchInput.addEventListener('keydown', (e) => {
        if (currentMode === 'game') return;
        if (e.key === 'ArrowDown') { e.preventDefault(); sHighlight = Math.min(sHighlight + 1, sResults.length - 1); renderSearchResults(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); sHighlight = Math.max(sHighlight - 1, 0); renderSearchResults(); }
        if (e.key === 'Enter' && sResults[sHighlight]) {
            if (currentMode === 'hitter') selectBatter(sResults[sHighlight]);
            else if (currentMode === 'pitcher') selectPitcherMode(sResults[sHighlight]);
            else if (currentMode === 'team') selectTeam(sResults[sHighlight]);
            sDrop.classList.remove('visible');
        }
        if (e.key === 'Escape') sDrop.classList.remove('visible');
    });
    searchInput.addEventListener('blur', () => { setTimeout(() => sDrop.classList.remove('visible'), 150) });

    function renderSearchResults() {
        if (!sResults.length) { sDrop.classList.remove('visible'); return }
        sDrop.innerHTML = sResults.map((item, i) => {
            let name, info;
            if (currentMode === 'team') {
                name = item.abbr + ' \u2014 ' + item.name;
                info = item.lg + ' ' + item.div;
            } else if (currentMode === 'hitter') {
                name = fmtName(item.batter_name);
                info = (item.total_PA || 0).toLocaleString() + ' PA';
            } else {
                name = fmtName(item.player_name);
                info = (item.avg_velo_FF || 0).toFixed(1) + ' mph';
            }
            return '<div class="s-item' + (i === sHighlight ? ' hl' : '') + '" data-idx="' + i + '"><span>' + name + '</span><span class="pa">' + info + '</span></div>';
        }).join('');
        sDrop.classList.add('visible');
    }
    sDrop.addEventListener('mousedown', (e) => {
        const el = e.target.closest('.s-item');
        if (!el) return; e.preventDefault();
        const idx = parseInt(el.dataset.idx);
        if (currentMode === 'hitter') selectBatter(sResults[idx]);
        else if (currentMode === 'pitcher') selectPitcherMode(sResults[idx]);
        else if (currentMode === 'team') selectTeam(sResults[idx]);
        sDrop.classList.remove('visible');
    });

    // ═══ HITTER SELECTION ═══
    async function selectBatter(batter) {
        selectedBatter = batter;
        selectedPitcher = null;
        searchInput.value = '';
        sDrop.classList.remove('visible');
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('pitcher-hero').style.display = 'none';

        const rows = DATA.hitterVsCluster.filter(r => r.batter === batter.batter);
        let totalPA = 0, totalAB = 0, totalH = 0, totalHR = 0, totalBB = 0, totalK = 0, totalHBP = 0, wobaSum = 0;
        let totalSingles = 0, totalDoubles = 0, totalTriples = 0;
        rows.forEach(r => {
            totalPA += r.PA || 0; totalAB += r.AB || 0; totalH += r.H || 0;
            totalHR += r.HR || 0; totalBB += r.BB || 0; totalK += r.K || 0;
            totalHBP += r.HBP || 0; wobaSum += (r.wOBA || 0) * (r.PA || 0);
            totalSingles += r.singles || 0; totalDoubles += r.doubles || 0; totalTriples += r.triples || 0;
        });
        const careerWoba = totalPA > 0 ? (wobaSum / totalPA).toFixed(3) : '.000';
        const careerBA = totalAB > 0 ? (totalH / totalAB).toFixed(3) : '.000';
        const careerOBP = totalPA > 0 ? ((totalH + totalBB + totalHBP) / totalPA).toFixed(3) : '.000';
        const careerTB = totalSingles + totalDoubles * 2 + totalTriples * 3 + totalHR * 4;
        const careerSLG = totalAB > 0 ? (careerTB / totalAB).toFixed(3) : '.000';
        const careerKpct = totalPA > 0 ? ((totalK / totalPA) * 100).toFixed(0) : '0';
        const careerBBpct = totalPA > 0 ? ((totalBB / totalPA) * 100).toFixed(0) : '0';

        const heroEl = document.getElementById('hitter-hero');
        const nameParts = fmtName(batter.batter_name).split(' ');
        document.getElementById('hero-name').innerHTML = nameParts.length > 1
            ? nameParts.slice(-1)[0] + '<br>' + nameParts.slice(0, -1).join(' ')
            : nameParts[0];

        try {
            const res = await fetch('https://statsapi.mlb.com/api/v1/people/' + batter.batter + '?hydrate=currentTeam');
            const data = await res.json();
            if (data.people && data.people[0]) {
                const p = data.people[0];
                teamId = p.currentTeam ? p.currentTeam.id : null;
                const teamAbbr = p.currentTeam ? p.currentTeam.abbreviation : '';
                const pos = p.primaryPosition ? p.primaryPosition.abbreviation : '';
                const bat = p.batSide ? p.batSide.code : '';
                document.getElementById('hero-meta').innerHTML =
                    '<div><span class="text-accent">&gt;</span> ' + teamAbbr + '<br>' + pos + '</div>' +
                    '<div class="text-right">' + bat + ' / ' + (p.throwSide ? p.throwSide.code : '') + '</div>';
            }
        } catch (e) { console.warn('MLB API player lookup failed:', e); showBanner('Could not reach MLB API.'); }

        document.getElementById('context-stats').innerHTML =
            '<div class="section-label">CAREER vs ALL ARCHETYPES</div><div class="stat-block">' +
            '<div class="stat-row"><span>BA</span><span class="val mono">' + careerBA + '</span></div>' +
            '<div class="stat-row"><span>OBP</span><span class="val mono">' + careerOBP + '</span></div>' +
            '<div class="stat-row"><span>SLG</span><span class="val mono">' + careerSLG + '</span></div>' +
            '<div class="stat-row"><span>wOBA</span><span class="val mono">' + careerWoba + '</span></div>' +
            '<div class="stat-row"><span>K%</span><span class="val mono">' + careerKpct + '%</span></div>' +
            '<div class="stat-row"><span>BB%</span><span class="val mono">' + careerBBpct + '%</span></div>' +
            '<div class="stat-row"><span>HR</span><span class="val mono">' + totalHR + '</span></div>' +
            '<div class="stat-row"><span>PA</span><span class="val mono">' + totalPA.toLocaleString() + '</span></div>' +
            '</div>';

        heroEl.style.display = 'block';

        // Auto-run: find next 2 games and show projections instantly
        await autoRunDefault('hitter');
    }

    // ═══ PITCHER SELECTION ═══
    async function selectPitcherMode(ps) {
        selectedPitcher = ps;
        selectedBatter = null;
        searchInput.value = '';
        sDrop.classList.remove('visible');
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('hitter-hero').style.display = 'none';

        const cluster = DATA.clusters[ps.cluster] || {};
        const color = cluster.color || '#888';

        const heroEl = document.getElementById('pitcher-hero');
        const nameParts = fmtName(ps.player_name).split(' ');
        document.getElementById('pitcher-hero-name').innerHTML = nameParts.length > 1
            ? nameParts.slice(-1)[0] + '<br>' + nameParts.slice(0, -1).join(' ')
            : nameParts[0];

        let teamAbbr = '', throwHand = ps.cluster.startsWith('RHP') ? 'RHP' : 'LHP';
        try {
            const res = await fetch('https://statsapi.mlb.com/api/v1/people/' + ps.pitcher + '?hydrate=currentTeam');
            const data = await res.json();
            if (data.people && data.people[0]) {
                const p = data.people[0];
                teamId = p.currentTeam ? p.currentTeam.id : null;
                teamAbbr = p.currentTeam ? p.currentTeam.abbreviation : '';
            }
        } catch (e) { teamId = null; }

        document.getElementById('pitcher-hero-meta').innerHTML =
            '<div><span class="text-accent">&gt;</span> ' + teamAbbr + '<br>' + throwHand + '</div>' +
            '<div class="text-right">' + (ps.is_sp ? 'SP' : 'RP') + '</div>';

        document.getElementById('pitcher-archetype-badge').innerHTML =
            '<div class="archetype-badge"><span class="dot" style="background:' + color + '"></span>' +
            archEmoji(ps.cluster) + ' ' + archName(ps.cluster) + '</div>';

        document.getElementById('context-stats').innerHTML =
            '<div class="section-label">SEASON PROFILE</div><div class="stat-block">' +
            '<div class="stat-row"><span>VELO</span><span class="val mono">' + (ps.avg_velo_FF || 0).toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>WHIFF%</span><span class="val mono">' + ((ps.whiff_rate || 0) * 100).toFixed(0) + '%</span></div>' +
            '<div class="stat-row"><span>GB%</span><span class="val mono">' + ((ps.groundball_rate || 0) * 100).toFixed(0) + '%</span></div>' +
            '<div class="stat-row"><span>H-BRK</span><span class="val mono">' + ((ps.pfx_x_avg || 0) * 12).toFixed(1) + '"</span></div>' +
            '<div class="stat-row"><span>ARM</span><span class="val mono">' + (ps.arm_angle || 0).toFixed(0) + '\u00b0</span></div>' +
            '</div>';

        heroEl.style.display = 'block';

        // Auto-run: find next 2 starts and show projections instantly
        await autoRunDefault('pitcher');
    }

    // ═══ TEAM SELECTION ═══
    async function selectTeam(team) {
        selectedTeam = team;
        selectedBatter = null;
        selectedPitcher = null;
        searchInput.value = '';
        sDrop.classList.remove('visible');

        const mlbId = MLB_TEAM_IDS[team.abbr];
        if (!mlbId) { showBanner('Team ID not found for ' + team.abbr); return; }
        teamId = mlbId;
        selectedTeam.mlbId = mlbId;

        document.getElementById('no-player').style.display = 'none';
        document.getElementById('hitter-hero').style.display = 'none';
        document.getElementById('pitcher-hero').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('game-mode-info').style.display = 'none';

        const heroEl = document.getElementById('team-hero');
        document.getElementById('team-hero-name').innerHTML = team.abbr + '<br><span style="font-size:0.9rem;letter-spacing:1px">' + team.name + '</span>';
        document.getElementById('team-hero-meta').innerHTML =
            '<div><span class="text-accent">&gt;</span> ' + team.lg + ' ' + team.div + '</div>' +
            '<div class="text-right">26-MAN</div>';
        heroEl.style.display = 'block';
        document.getElementById('context-stats').innerHTML = '';

        await autoRunDefault('team');
    }

    // ═══ CLEAR HANDLERS ═══
    document.getElementById('hc-clear').addEventListener('click', () => {
        selectedBatter = null; teamId = null; schedule = []; projections = [];
        document.getElementById('hitter-hero').style.display = 'none';
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('empty-state').style.display = 'flex';
        document.getElementById('context-stats').innerHTML = '';
        document.getElementById('slate').innerHTML = '';
        document.getElementById('totals-dock').style.display = 'none';
        calRangeStart = null; calRangeEnd = null; updateCalTriggerLabel();
        hideBanner();
    });
    document.getElementById('pc-clear').addEventListener('click', () => {
        selectedPitcher = null; teamId = null; schedule = []; projections = [];
        document.getElementById('pitcher-hero').style.display = 'none';
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('empty-state').style.display = 'flex';
        document.getElementById('context-stats').innerHTML = '';
        document.getElementById('slate').innerHTML = '';
        document.getElementById('totals-dock').style.display = 'none';
        calRangeStart = null; calRangeEnd = null; updateCalTriggerLabel();
        hideBanner();
    });
    document.getElementById('tc-clear').addEventListener('click', () => {
        selectedTeam = null; teamId = null; schedule = []; projections = [];
        document.getElementById('team-hero').style.display = 'none';
        document.getElementById('no-player').style.display = 'none';
        document.getElementById('empty-state').style.display = 'flex';
        document.getElementById('context-stats').innerHTML = '';
        document.getElementById('slate').innerHTML = '';
        document.getElementById('totals-dock').style.display = 'none';
        calRangeStart = null; calRangeEnd = null; updateCalTriggerLabel();
        hideBanner();
    });

    // ═══ CALENDAR INIT ═══
    calRangeStart = null;
    calRangeEnd = null;
    const initDate = new Date();
    calViewMonth = initDate.getMonth();
    calViewYear = initDate.getFullYear();

    document.getElementById('cal-trigger').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('cal-dropdown').classList.toggle('visible');
        renderCalendar();
    });
    document.getElementById('cal-prev').addEventListener('click', () => {
        calViewMonth--;
        if (calViewMonth < 0) { calViewMonth = 11; calViewYear--; }
        renderCalendar();
    });
    document.getElementById('cal-next').addEventListener('click', () => {
        calViewMonth++;
        if (calViewMonth > 11) { calViewMonth = 0; calViewYear++; }
        renderCalendar();
    });
    document.getElementById('cal-grid').addEventListener('click', (e) => {
        const cell = e.target.closest('.cal-day');
        if (!cell || cell.classList.contains('other-month') || !cell.dataset.date) return;
        const dateStr = cell.dataset.date;
        if (!calRangeStart || (calRangeStart && calRangeEnd)) {
            calRangeStart = dateStr;
            calRangeEnd = null;
        } else {
            if (dateStr < calRangeStart) {
                calRangeEnd = calRangeStart;
                calRangeStart = dateStr;
            } else if (dateStr === calRangeStart) {
                calRangeEnd = null;
            } else {
                calRangeEnd = dateStr;
            }
        }
        renderCalendar();
    });
    document.getElementById('cal-clear').addEventListener('click', () => { calRangeStart = null; calRangeEnd = null; renderCalendar(); });
    document.getElementById('cal-done').addEventListener('click', () => {
        document.getElementById('cal-dropdown').classList.remove('visible');
        // Auto-run on APPLY if dates are set
        if (calRangeStart) { runSlate(); }
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('#cal-wrap')) document.getElementById('cal-dropdown').classList.remove('visible');
    });
    updateCalTriggerLabel();

    // ═══ RUN SLATE ═══
    document.getElementById('btn-run').addEventListener('click', runSlate);

    async function runSlate() {
        const selectedDates = getSelectedDates();
        if (selectedDates.length === 0) { showBanner('Select at least one date.'); return; }
        if (currentMode === 'hitter' && !selectedBatter) return;
        if (currentMode === 'pitcher' && !selectedPitcher) return;
        if (currentMode === 'team' && !selectedTeam) return;

        // Hide empty state
        document.getElementById('empty-state').style.display = 'none';

        const sorted = [...selectedDates].sort();
        const startDate = sorted[0];
        const endDate = sorted[sorted.length - 1];
        hideBanner();
        schedule = [];

        if (currentMode === 'game') {
            await runGameSlate(startDate, endDate, sorted);
        } else if (currentMode === 'team') {
            await runTeamSlate(startDate, endDate, sorted);
        } else if (currentMode === 'hitter') {
            await runHitterSlate(startDate, endDate, sorted);
        } else {
            await runPitcherSlate(startDate, endDate, sorted);
        }
    }

    // ═══ AUTO-RUN DEFAULT ═══
    async function autoRunDefault(mode) {
        const thisRunId = ++_autoRunId;
        _autoScheduleCache = null;

        // Show loading banner
        const banner = document.getElementById('status-banner');
        banner.textContent = 'LOADING UPCOMING GAMES...';
        banner.classList.add('loading');
        banner.classList.add('visible');

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        try {
            if (mode === 'hitter') {
                if (!teamId) { hideBanner(); banner.classList.remove('loading'); return; }
                // Look 14 days ahead for next 2 games
                const endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 14);
                const endStr = endDate.toISOString().split('T')[0];

                const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + todayStr + '&endDate=' + endStr + '&hydrate=probablePitcher';
                const data = await (await fetch(url)).json();
                _autoScheduleCache = data;

                if (thisRunId !== _autoRunId) return; // Race guard

                const gameDates = [];
                (data.dates || []).forEach(dateObj => {
                    dateObj.games.forEach(game => {
                        const gDate = game.officialDate || dateObj.date;
                        if (!gameDates.includes(gDate)) gameDates.push(gDate);
                    });
                });
                gameDates.sort();

                if (gameDates.length === 0) {
                    banner.textContent = 'NO UPCOMING GAMES FOUND IN NEXT 14 DAYS';
                    banner.classList.remove('loading');
                    banner.classList.add('visible');
                    return;
                }

                // Take next 2 game dates
                const selectedGameDates = gameDates.slice(0, 2);
                calRangeStart = selectedGameDates[0];
                calRangeEnd = selectedGameDates.length > 1 ? selectedGameDates[selectedGameDates.length - 1] : null;
                updateCalTriggerLabel();

            } else if (mode === 'pitcher') {
                if (!teamId || !selectedPitcher) { hideBanner(); banner.classList.remove('loading'); return; }
                // Look 30 days ahead for pitcher starts
                const endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 30);
                const endStr = endDate.toISOString().split('T')[0];

                const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + todayStr + '&endDate=' + endStr + '&hydrate=probablePitcher';
                const data = await (await fetch(url)).json();
                _autoScheduleCache = data;

                if (thisRunId !== _autoRunId) return; // Race guard

                const startDates = [];
                (data.dates || []).forEach(dateObj => {
                    dateObj.games.forEach(game => {
                        const isHome = game.teams.home.team.id === teamId;
                        const myTeam = isHome ? game.teams.home : game.teams.away;
                        const myPP = myTeam.probablePitcher || null;
                        if (myPP && myPP.id === selectedPitcher.pitcher) {
                            const gDate = game.officialDate || dateObj.date;
                            if (!startDates.includes(gDate)) startDates.push(gDate);
                        }
                    });
                });
                startDates.sort();

                if (startDates.length === 0) {
                    banner.textContent = 'NO SCHEDULED STARTS IN NEXT 30 DAYS';
                    banner.classList.remove('loading');
                    banner.classList.add('visible');
                    return;
                }

                const selectedStartDates = startDates.slice(0, 2);
                calRangeStart = selectedStartDates[0];
                calRangeEnd = selectedStartDates.length > 1 ? selectedStartDates[selectedStartDates.length - 1] : null;
                updateCalTriggerLabel();

            } else if (mode === 'team') {
                if (!teamId) { hideBanner(); banner.classList.remove('loading'); return; }
                const endDate = new Date(today);
                endDate.setDate(endDate.getDate() + 14);
                const endStr = endDate.toISOString().split('T')[0];

                const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + todayStr + '&endDate=' + endStr + '&hydrate=probablePitcher,lineups';
                const data = await (await fetch(url)).json();
                _autoScheduleCache = data;

                if (thisRunId !== _autoRunId) return;

                const gameDates = [];
                (data.dates || []).forEach(dateObj => {
                    dateObj.games.forEach(game => {
                        const gDate = game.officialDate || dateObj.date;
                        if (!gameDates.includes(gDate)) gameDates.push(gDate);
                    });
                });
                gameDates.sort();

                if (gameDates.length === 0) {
                    banner.textContent = 'NO UPCOMING GAMES FOUND IN NEXT 14 DAYS';
                    banner.classList.remove('loading');
                    banner.classList.add('visible');
                    return;
                }

                const selectedGameDates = gameDates.slice(0, 2);
                calRangeStart = selectedGameDates[0];
                calRangeEnd = selectedGameDates.length > 1 ? selectedGameDates[selectedGameDates.length - 1] : null;
                updateCalTriggerLabel();

            } else if (mode === 'game') {
                // Find today's games, or scan forward up to 3 days
                let foundDate = null;
                for (let i = 0; i <= 3; i++) {
                    const checkDate = new Date(today);
                    checkDate.setDate(checkDate.getDate() + i);
                    const checkStr = checkDate.toISOString().split('T')[0];
                    const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&startDate=' + checkStr + '&endDate=' + checkStr;
                    const data = await (await fetch(url)).json();

                    if (thisRunId !== _autoRunId) return; // Race guard

                    const hasGames = (data.dates || []).some(d => d.games && d.games.length > 0);
                    if (hasGames) {
                        foundDate = checkStr;
                        break;
                    }
                }

                if (!foundDate) {
                    banner.textContent = 'NO GAMES FOUND IN NEXT 3 DAYS';
                    banner.classList.remove('loading');
                    banner.classList.add('visible');
                    return;
                }

                calRangeStart = foundDate;
                calRangeEnd = null;
                updateCalTriggerLabel();
            }
        } catch (e) {
            console.warn('Auto-run schedule fetch failed:', e);
            banner.textContent = 'COULD NOT FETCH SCHEDULE';
            banner.classList.remove('loading');
            banner.classList.add('visible');
            return;
        }

        // Clear loading banner
        banner.classList.remove('loading');
        hideBanner();

        if (thisRunId !== _autoRunId) return; // Final race guard

        // Run the slate
        await runSlate();
    }

    // ═══ HITTER SLATE ═══
    async function runHitterSlate(startDate, endDate, filterDates) {
        if (teamId) {
            try {
                let data;
                if (_autoScheduleCache) {
                    data = _autoScheduleCache;
                    _autoScheduleCache = null;
                } else {
                    const res = await fetch('https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher');
                    data = await res.json();
                }
                if (data.dates) {
                    data.dates.forEach(dateObj => {
                        dateObj.games.forEach(game => {
                            const isHome = game.teams.home.team.id === teamId;
                            const opp = isHome ? game.teams.away : game.teams.home;
                            const oppPitcher = opp.probablePitcher || null;
                            schedule.push({
                                date: game.officialDate || dateObj.date,
                                oppTeam: opp.team.abbreviation || opp.team.name,
                                pitcher: oppPitcher ? { id: oppPitcher.id, name: oppPitcher.fullName } : null,
                                originalPitcher: oppPitcher ? { id: oppPitcher.id, name: oppPitcher.fullName } : null,
                                overridden: false
                            });
                        });
                    });
                }
            } catch (e) { showBanner('Could not fetch MLB schedule.'); }
        } else {
            showBanner('Team not found. Add pitcher matchups manually.');
        }

        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];
        const days = filterDates;

        days.forEach(day => {
            const games = schedule.filter(g => g.date === day);
            html += '<div class="day-hdr">' + fmtDate(day) + '</div>';
            if (games.length === 0) { html += '<div class="off-day">OFF DAY</div>'; return; }
            games.forEach(game => {
                const schedIdx = schedule.indexOf(game);
                const proj = buildGameCard(game, day, schedIdx);
                html += proj.html;
                projections.push(proj.data);
            });
        });

        if (projections.length > 0) {
            updateTotalsDock();
        }

        slateEl.innerHTML = html;
        bindPAEdits();
        bindLineInputs();
        bindPitcherOverrides();
        renderQuickScan('hitter');

        // Show archetype context for first matchup in sidebar
        if (projections.length > 0 && projections[0].cluster) {
            updateArchetypeContext(projections[0].cluster);
        }
    }

    // ═══ QUICK SCAN ENGINE ═══
    const DEFAULT_LINES = { h: 1.5, hr: 0.5, tb: 1.5, k: 1.5 };

    function renderQuickScan(mode) {
        const slateEl = document.getElementById('slate');
        const existing = document.getElementById('quick-scan-box');
        if (existing) existing.remove();

        if (projections.length === 0) return;

        const edges = [];

        if (mode === 'hitter') {
            // Scan hitter projections vs default player prop lines
            projections.forEach((p, i) => {
                if (p.source === 'insufficient data') return;
                const pitcher = p.pitcher || 'Unknown';
                // Hits edge
                if (p.h > 0) {
                    const hEdge = ((p.h - DEFAULT_LINES.h) / DEFAULT_LINES.h * 100);
                    edges.push({ stat: 'HITS', proj: p.h.toFixed(2), line: DEFAULT_LINES.h, edge: hEdge, dir: hEdge > 0 ? 'over' : 'under', player: fmtName(selectedBatter.batter_name), vs: pitcher, src: p.source, cat: 'hitter' });
                }
                // HR edge
                if (p.hr > 0) {
                    const hrEdge = ((p.hr - DEFAULT_LINES.hr) / DEFAULT_LINES.hr * 100);
                    edges.push({ stat: 'HR', proj: p.hr.toFixed(2), line: DEFAULT_LINES.hr, edge: hrEdge, dir: hrEdge > 0 ? 'over' : 'under', player: fmtName(selectedBatter.batter_name), vs: pitcher, src: p.source, cat: 'hitter' });
                }
                // TB edge
                if (p.tb > 0) {
                    const tbEdge = ((p.tb - DEFAULT_LINES.tb) / DEFAULT_LINES.tb * 100);
                    edges.push({ stat: 'TB', proj: p.tb.toFixed(2), line: DEFAULT_LINES.tb, edge: tbEdge, dir: tbEdge > 0 ? 'over' : 'under', player: fmtName(selectedBatter.batter_name), vs: pitcher, src: p.source, cat: 'hitter' });
                }
                // K edge
                if (p.k > 0) {
                    const kEdge = ((p.k - DEFAULT_LINES.k) / DEFAULT_LINES.k * 100);
                    edges.push({ stat: 'K', proj: p.k.toFixed(2), line: DEFAULT_LINES.k, edge: kEdge, dir: kEdge > 0 ? 'over' : 'under', player: fmtName(selectedBatter.batter_name), vs: pitcher, src: p.source, cat: 'hitter' });
                }
            });
        } else if (mode === 'game') {
            // Scan game totals for spread + O/U edges
            projections.forEach((p, i) => {
                if (!p.hasLineups) return;
                const spread = p.homeRuns - p.awayRuns;
                const f5Scale = 5 / 9;
                const f5Away = p.awayRuns * f5Scale;
                const f5Home = p.homeRuns * f5Scale;
                const f5Spread = f5Home - f5Away;
                const f5Total = f5Away + f5Home;

                edges.push({ stat: 'TOTAL', proj: p.totalRuns.toFixed(1), line: 8.5, edge: ((p.totalRuns - 8.5) / 8.5 * 100), dir: p.totalRuns > 8.5 ? 'over' : 'under', player: p.awayTeam + ' @ ' + p.homeTeam, vs: '', src: 'lineup', cat: 'game' });
                edges.push({ stat: 'SPREAD', proj: (spread > 0 ? '+' : '') + spread.toFixed(1), line: 1.5, edge: Math.abs(spread) > 1.5 ? Math.abs(spread - 1.5) / 1.5 * 100 : -(1.5 - Math.abs(spread)) / 1.5 * 100, dir: Math.abs(spread) > 1.5 ? 'over' : 'under', player: (spread > 0 ? p.homeTeam : p.awayTeam) + ' -1.5', vs: '', src: 'lineup', cat: 'game' });
                edges.push({ stat: 'F5 TOTAL', proj: f5Total.toFixed(1), line: 4.5, edge: ((f5Total - 4.5) / 4.5 * 100), dir: f5Total > 4.5 ? 'over' : 'under', player: p.awayTeam + ' @ ' + p.homeTeam, vs: '', src: 'lineup', cat: 'game' });
                edges.push({ stat: 'F5 SPREAD', proj: (f5Spread > 0 ? '+' : '') + f5Spread.toFixed(1), line: 0.5, edge: Math.abs(f5Spread) > 0.5 ? Math.abs(f5Spread - 0.5) / 0.5 * 100 : -(0.5 - Math.abs(f5Spread)) / 0.5 * 100, dir: Math.abs(f5Spread) > 0.5 ? 'over' : 'under', player: (f5Spread > 0 ? p.homeTeam : p.awayTeam) + ' -0.5', vs: '', src: 'lineup', cat: 'game' });
            });
        } else if (mode === 'team') {
            // Scan team projections for runs O/U
            projections.forEach((p, i) => {
                if (!p.hasLineup) return;
                edges.push({ stat: 'TEAM RUNS', proj: p.runs.toFixed(1), line: 4.5, edge: ((p.runs - 4.5) / 4.5 * 100), dir: p.runs > 4.5 ? 'over' : 'under', player: p.teamAbbr + ' vs ' + p.oppTeam, vs: '', src: 'lineup', cat: 'team' });
            });
        }

        // Sort: H2H edges rank higher (1.5x weight), then by absolute edge size
        edges.sort((a, b) => {
            const wA = Math.abs(a.edge) * (a.src === 'head-to-head' || (a.src && a.src.startsWith('h2h')) ? 1.5 : 1);
            const wB = Math.abs(b.edge) * (b.src === 'head-to-head' || (b.src && b.src.startsWith('h2h')) ? 1.5 : 1);
            return wB - wA;
        });

        if (edges.length === 0) return;

        // Take top 8 edges
        const topEdges = edges.slice(0, 8);

        let html = '<div class="quick-scan" id="quick-scan-box">';
        html += '<div class="qs-title">QUICK SCAN</div>';
        html += '<div class="qs-grid">';

        topEdges.forEach(e => {
            const edgePct = Math.abs(e.edge).toFixed(0);
            const dirLabel = e.dir === 'over' ? 'O +' + edgePct + '%' : 'U -' + edgePct + '%';
            const absE = Math.abs(e.edge);
            const eClass = absE >= 25 ? 'edge-strong' : absE >= 15 ? 'edge-good' : absE >= 8 ? 'edge-mild' : absE >= 3 ? 'edge-slim' : 'edge-neg';
            html += '<div class="qs-item">';
            html += '<div class="qs-edge ' + e.dir + ' ' + eClass + '">' + dirLabel + '</div>';
            html += '<div class="qs-detail">';
            html += '<div class="qs-player">' + e.stat + ' ' + e.proj + ' (line ' + e.line + ')</div>';
            const srcTag = e.src && (e.src.startsWith('head') || e.src.startsWith('h2h')) ? ' \u00b7 H2H' : (e.src === 'archetype' ? ' \u00b7 ARCH' : '');
            html += '<div class="qs-info">' + e.player + (e.vs ? ' vs ' + e.vs : '') + srcTag + '</div>';
            html += '</div></div>';
        });

        html += '</div></div>';

        slateEl.insertAdjacentHTML('afterbegin', html);
    }

    // ═══ ARCHETYPE CONTEXT (sidebar) ═══
    function updateArchetypeContext(clusterId) {
        const ctx = document.getElementById('context-stats');
        const cluster = DATA.clusters[clusterId];
        if (!cluster || !ctx) return;

        const kings = DATA.archetypeKings[clusterId] || [];
        const topKing = kings[0] || null;

        let html = ctx.innerHTML;
        html += '<div class="archetype-context">';
        html += '<div class="section-label">OPPOSING ARCHETYPE</div>';
        html += '<div class="arch-title"><span class="dot" style="background:' + (cluster.color || '#888') + '"></span>' + (cluster.short_name || cluster.full_name || clusterId) + '</div>';
        if (cluster.top_pitches) html += '<div class="arch-detail">PITCHES: ' + cluster.top_pitches + '</div>';
        html += '<div class="arch-detail">';
        html += 'VELO: ' + (cluster.avg_velo_FF || 0).toFixed(1) + ' mph';
        html += ' \u00b7 WHIFF: ' + ((cluster.whiff_rate || 0) * 100).toFixed(0) + '%';
        html += ' \u00b7 GB: ' + ((cluster.groundball_rate || 0) * 100).toFixed(0) + '%';
        html += '</div>';
        if (topKing) {
            html += '<div class="arch-detail" style="margin-top:6px;color:var(--accent)">KING: ' + topKing.name + '</div>';
        }
        html += '</div>';
        ctx.innerHTML = html;
    }

    // ═══ PITCHER SLATE ═══
    async function runPitcherSlate(startDate, endDate, filterDates) {
        if (teamId) {
            try {
                let data;
                if (_autoScheduleCache) {
                    data = _autoScheduleCache;
                    _autoScheduleCache = null;
                } else {
                    const res = await fetch('https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher');
                    data = await res.json();
                }
                if (data.dates) {
                    data.dates.forEach(dateObj => {
                        dateObj.games.forEach(game => {
                            const isHome = game.teams.home.team.id === teamId;
                            const opp = isHome ? game.teams.away : game.teams.home;
                            const myTeam = isHome ? game.teams.home : game.teams.away;
                            const myPP = myTeam.probablePitcher || null;
                            if (myPP && myPP.id === selectedPitcher.pitcher) {
                                schedule.push({
                                    date: game.officialDate || dateObj.date,
                                    oppTeam: opp.team.abbreviation || opp.team.name,
                                    oppTeamId: opp.team.id
                                });
                            }
                        });
                    });
                }
            } catch (e) { showBanner('Could not fetch MLB schedule.'); }
        }

        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];

        const filteredSchedule = schedule.filter(g => filterDates.includes(g.date));

        if (filteredSchedule.length === 0) {
            html = '<div class="off-day">No scheduled starts found for this pitcher on selected dates.</div>';
            slateEl.innerHTML = html;
            return;
        }

        for (const game of filteredSchedule) {
            html += '<div class="day-hdr">' + fmtDate(game.date) + ' vs ' + game.oppTeam + '</div>';

            const matchedBatters = [];
            Object.entries(DATA._hvpIndex).forEach(([batterId, clusters]) => {
                Object.values(clusters).flat().forEach(m => {
                    if (m.p === selectedPitcher.pitcher) {
                        const batter = DATA.batters.find(b => b.batter === parseInt(batterId));
                        if (batter && !matchedBatters.find(x => x.batter.batter === batter.batter)) {
                            matchedBatters.push({ batter, matchup: m });
                        }
                    }
                });
            });

            if (matchedBatters.length === 0) {
                html += '<div class="off-day">No head-to-head data for opposing batters.</div>';
                continue;
            }

            matchedBatters.sort((a, b) => (b.matchup.pa || 0) - (a.matchup.pa || 0));

            let totalK = 0, totalH = 0, totalHR = 0, totalPA = 0;
            matchedBatters.slice(0, 9).forEach(mb => {
                const m = mb.matchup;
                const pa = m.pa || 0;
                totalPA += pa;
                totalK += m.k || 0;
                totalH += (m.ba || 0) * pa;
                totalHR += m.hr || 0;

                html += '<div class="game-card">';
                html += '<div class="card-spine"><div class="vs-label">AB</div><div class="opp-team">' + pa + '</div></div>';
                html += '<div class="card-content">';
                html += '<div class="matchup-header"><span>' + fmtName(mb.batter.batter_name) + '</span></div>';
                html += '<div class="stat-chips">';
                html += scC('BA', m.ba != null ? m.ba.toFixed(3) : '\u2014', baColor(m.ba || 0));
                html += scC('wOBA', m.w != null ? m.w.toFixed(3) : '\u2014', wobaColor(m.w || 0));
                html += sc('HR', m.hr || 0);
                html += sc('K', m.k || 0);
                html += sc('BB', m.bb || 0);
                html += '</div></div></div>';
            });

            const kRate = totalPA > 0 ? (totalK / totalPA) : 0;
            const hRate = totalPA > 0 ? (totalH / totalPA) : 0;
            projections.push({
                pa: totalPA, k: totalK, h: totalH, hr: totalHR, tb: totalH + totalHR * 3,
                k_rate: kRate, h_rate: hRate,
                pitcher: fmtName(selectedPitcher.player_name),
                opp: game.oppTeam
            });
        }

        slateEl.innerHTML = html;
    }

    // ═══ TEAM SLATE ═══
    async function runTeamSlate(startDate, endDate, filterDates) {
        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];
        document.getElementById('totals-dock').style.display = 'none';

        let data;
        if (_autoScheduleCache) {
            data = _autoScheduleCache;
            _autoScheduleCache = null;
        } else {
            const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&teamId=' + teamId + '&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher,lineups';
            data = await (await fetch(url)).json();
        }

        // Fetch active roster (position players only)
        let rosterPlayers = [];
        try {
            const rosterData = await (await fetch('https://statsapi.mlb.com/api/v1/teams/' + teamId + '/roster?rosterType=active')).json();
            rosterPlayers = (rosterData.roster || []).filter(p => {
                const posCode = p.position ? parseInt(p.position.code) : 1;
                return posCode >= 2 && posCode <= 10;
            }).map(p => ({
                id: p.person.id,
                name: p.person.fullName,
                position: p.position.abbreviation,
                jerseyNumber: p.jerseyNumber
            }));
        } catch (e) { console.warn('Could not fetch roster:', e); }

        // Process each game
        const allGames = [];
        (data.dates || []).forEach(dateObj => {
            dateObj.games.forEach(game => {
                const gDate = game.officialDate || dateObj.date;
                if (filterDates.includes(gDate)) {
                    allGames.push({ ...game, displayDate: gDate });
                }
            });
        });

        if (allGames.length === 0) {
            html = '<div class="off-day">No games found for selected dates.</div>';
            slateEl.innerHTML = html;
            return;
        }

        allGames.forEach((game, gameIdx) => {
            const isHome = game.teams.home.team.id === teamId;
            const oppTeam = isHome ? game.teams.away : game.teams.home;
            const oppPP = oppTeam.probablePitcher || null;
            const oppTeamAbbr = oppTeam.team.abbreviation || oppTeam.team.name;

            // Get opposing pitcher archetype
            const oppPS = oppPP ? DATA.pitcherSeasons.filter(p => p.pitcher === oppPP.id).sort((a, b) => b.game_year - a.game_year)[0] : null;
            const oppCluster = oppPS ? DATA.clusters[oppPS.cluster] : null;

            // Extract lineup (starting 9)
            const lineupKey = isHome ? 'homePlayers' : 'awayPlayers';
            let starterIds = [];
            if (game.lineups && game.lineups[lineupKey]) {
                starterIds = game.lineups[lineupKey].map(p => p.id).filter(Boolean);
            }

            const hasLineup = starterIds.length > 0;

            // Identify bench = roster position players NOT in starting lineup
            const starterIdSet = new Set(starterIds);
            const benchPlayersList = rosterPlayers.filter(p => !starterIdSet.has(p.id));

            // Project starters (4 PA)
            let starterProj = null;
            if (hasLineup) {
                starterProj = projectTeam(starterIds, oppPP ? oppPP.id : null);
            }

            // Project bench (1 PA)
            let benchProj = null;
            if (benchPlayersList.length > 0) {
                benchProj = projectTeam(benchPlayersList.map(p => p.id), oppPP ? oppPP.id : null, 1);
            }

            // Combined totals
            let totalH = 0, totalHR = 0, totalK = 0, totalTB = 0, totalBB = 0, totalPA = 0;
            if (starterProj) {
                totalH += starterProj.teamH; totalHR += starterProj.teamHR;
                totalK += starterProj.teamK; totalTB += starterProj.teamTB;
                totalBB += starterProj.teamBB; totalPA += starterProj.teamPA;
            }
            if (benchProj) {
                totalH += benchProj.teamH; totalHR += benchProj.teamHR;
                totalK += benchProj.teamK; totalTB += benchProj.teamTB;
                totalBB += benchProj.teamBB; totalPA += benchProj.teamPA;
            }
            const combinedRuns = baseRuns(totalH, totalHR, totalBB, totalTB, totalPA);

            html += buildTeamGameCard({
                game, gameIdx, isHome, oppTeamAbbr, oppPP, oppPS, oppCluster,
                hasLineup, starterProj, benchPlayersList, benchProj,
                combinedRuns, totalH, totalHR, totalK, totalTB
            });

            projections.push({
                teamAbbr: selectedTeam.abbr, oppTeam: oppTeamAbbr, date: game.displayDate,
                runs: combinedRuns, totalH, totalHR, totalK, totalTB, hasLineup,
                starterProj, benchProj
            });
        });

        slateEl.innerHTML = html;
        bindBenchToggles();
        bindTeamLineInputs();
        updateTeamContext(projections);
        renderQuickScan('team');
    }

    function buildTeamGameCard(opts) {
        const { game, gameIdx, isHome, oppTeamAbbr, oppPP, oppPS, oppCluster,
            hasLineup, starterProj, benchPlayersList, benchProj,
            combinedRuns, totalH, totalHR, totalK, totalTB } = opts;

        let card = '<div class="team-game-card">';

        // Header
        card += '<div class="tg-header">';
        card += '<span>' + selectedTeam.abbr + (isHome ? ' vs ' : ' @ ') + oppTeamAbbr + '</span>';
        card += '<span style="font-size:0.6rem;color:var(--text-muted);font-weight:400">' + fmtDate(game.displayDate) + '</span>';
        card += '</div>';

        // Opposing pitcher info
        const oppName = oppPP ? oppPP.fullName : 'TBD';
        const oppArchName = oppPS ? archName(oppPS.cluster) : 'Unknown';
        const oppColor = oppCluster ? oppCluster.color : '#888';
        card += '<div class="tg-pitcher-info">';
        card += 'OPP SP: <span class="sp-name">' + fmtName(oppName) + '</span>';
        card += ' <span style="color:' + oppColor + ';font-size:0.6rem">(' + oppArchName + ')</span>';
        if (oppPS) {
            card += ' \u00b7 VELO: ' + (oppPS.avg_velo_FF || 0).toFixed(1);
            card += ' \u00b7 WHIFF: ' + ((oppPS.whiff_rate || 0) * 100).toFixed(0) + '%';
        }
        card += '</div>';

        if (!hasLineup) {
            card += '<div class="gt-tbd">LINEUPS TBD \u2014 RUN CLOSER TO GAME TIME</div>';
            card += '</div>';
            return card;
        }

        // Column headers
        card += '<div class="tg-lineup-header">';
        card += '<span>#</span><span>BATTER</span><span>H</span><span>HR</span><span>K</span><span>TB</span><span>SRC</span>';
        card += '</div>';

        // Starter rows
        starterProj.batterDetails.forEach((bd, i) => {
            card += '<div class="tg-batter">';
            card += '<span class="order">' + (i + 1) + '</span>';
            card += '<span class="name">' + fmtName(bd.name) + '</span>';
            card += '<span class="stat">' + bd.projH.toFixed(2) + '</span>';
            card += '<span class="stat">' + bd.projHR.toFixed(2) + '</span>';
            card += '<span class="stat">' + bd.projK.toFixed(2) + '</span>';
            card += '<span class="stat">' + bd.projTB.toFixed(2) + '</span>';
            card += '<span class="src">' + bd.source + '</span>';
            card += '</div>';
        });

        // Bench toggle
        if (benchPlayersList.length > 0 && benchProj) {
            card += '<div class="tg-bench-toggle" data-gidx="' + gameIdx + '">';
            card += '\u25B6 BENCH (' + benchPlayersList.length + ' PLAYERS \u00b7 1 PA EACH)';
            card += '</div>';
            card += '<div class="tg-bench-section" id="bench-section-' + gameIdx + '">';
            benchProj.batterDetails.forEach(bd => {
                card += '<div class="tg-batter bench">';
                card += '<span class="order"><span class="tg-bench-tag">BN</span></span>';
                card += '<span class="name">' + fmtName(bd.name) + '</span>';
                card += '<span class="stat">' + bd.projH.toFixed(2) + '</span>';
                card += '<span class="stat">' + bd.projHR.toFixed(2) + '</span>';
                card += '<span class="stat">' + bd.projK.toFixed(2) + '</span>';
                card += '<span class="stat">' + bd.projTB.toFixed(2) + '</span>';
                card += '<span class="src">' + bd.source + '</span>';
                card += '</div>';
            });
            card += '</div>';
        }

        // Totals row
        card += '<div class="tg-totals">';
        card += '<div class="tg-runs-badge">' + combinedRuns.toFixed(1) + '<div class="tg-runs-label">RUNS</div></div>';
        card += sc('H', totalH.toFixed(1));
        card += sc('HR', totalHR.toFixed(1));
        card += sc('K', totalK.toFixed(1));
        card += sc('TB', totalTB.toFixed(1));
        card += '<div class="sc"><div class="sl">COV</div><div class="sv">' + starterProj.coverage + '/' + starterProj.total + '</div></div>';
        card += '</div>';

        // O/U line input
        card += '<div class="gt-line-row" style="padding:8px 1.2rem">';
        card += '<label>TEAM RUNS O/U</label>';
        card += '<input class="line-input team-ou-input" data-game-idx="' + gameIdx + '" placeholder="4.5">';
        card += '<div class="edge-display" id="team-edge-' + gameIdx + '"></div>';
        card += '</div>';

        card += '</div>';
        return card;
    }

    function bindBenchToggles() {
        document.querySelectorAll('.tg-bench-toggle').forEach(el => {
            el.addEventListener('click', () => {
                const idx = el.dataset.gidx;
                const section = document.getElementById('bench-section-' + idx);
                section.classList.toggle('visible');
                const count = section.querySelectorAll('.tg-batter').length;
                el.textContent = section.classList.contains('visible')
                    ? '\u25BC BENCH (' + count + ' PLAYERS \u00b7 1 PA EACH)'
                    : '\u25B6 BENCH (' + count + ' PLAYERS \u00b7 1 PA EACH)';
            });
        });
    }

    function bindTeamLineInputs() {
        document.querySelectorAll('.team-ou-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const proj = projections[idx];
                if (!proj || !proj.hasLineup) return;
                const display = document.getElementById('team-edge-' + idx);
                if (display) display.innerHTML = edgeLabel(proj.runs, el.value);
            });
        });
    }

    function updateTeamContext(teamProjections) {
        const ctx = document.getElementById('context-stats');
        if (!teamProjections || teamProjections.length === 0) { ctx.innerHTML = ''; return; }
        const gamesWithLineups = teamProjections.filter(p => p.hasLineup);
        const avgRuns = gamesWithLineups.length > 0
            ? gamesWithLineups.reduce((s, p) => s + p.runs, 0) / gamesWithLineups.length : 0;
        const avgH = gamesWithLineups.length > 0
            ? gamesWithLineups.reduce((s, p) => s + p.totalH, 0) / gamesWithLineups.length : 0;
        const avgHR = gamesWithLineups.length > 0
            ? gamesWithLineups.reduce((s, p) => s + p.totalHR, 0) / gamesWithLineups.length : 0;
        ctx.innerHTML =
            '<div class="section-label">TEAM PROJECTION AVG</div><div class="stat-block">' +
            '<div class="stat-row"><span>RUNS</span><span class="val mono text-accent" style="font-size:1.1rem">' + avgRuns.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>HITS</span><span class="val mono">' + avgH.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>HR</span><span class="val mono">' + avgHR.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>GAMES</span><span class="val mono">' + gamesWithLineups.length + '/' + teamProjections.length + '</span></div>' +
            '</div>';
    }

    // ═══ GAME SLATE ═══
    async function runGameSlate(startDate, endDate, filterDates) {
        const slateEl = document.getElementById('slate');
        let html = '';
        projections = [];
        document.getElementById('totals-dock').style.display = 'none';

        const url = 'https://statsapi.mlb.com/api/v1/schedule?sportId=1&startDate=' + startDate + '&endDate=' + endDate + '&hydrate=probablePitcher,lineups';

        let allGames = [];
        try {
            const data = await (await fetch(url)).json();
            (data.dates || []).forEach(dateObj => {
                dateObj.games.forEach(game => {
                    if (filterDates.includes(game.officialDate || dateObj.date)) {
                        allGames.push({ ...game, displayDate: game.officialDate || dateObj.date });
                    }
                });
            });
        } catch(e) { showBanner('Could not fetch MLB schedule.'); return; }

        // Team filter from search bar
        const teamFilter = searchInput.value.trim().toUpperCase();
        if (teamFilter.length >= 2) {
            allGames = allGames.filter(g =>
                (g.teams.away.team.abbreviation || '').toUpperCase().includes(teamFilter) ||
                (g.teams.home.team.abbreviation || '').toUpperCase().includes(teamFilter)
            );
        }

        if (allGames.length === 0) {
            html = '<div class="off-day">No games found for selected dates.</div>';
            slateEl.innerHTML = html;
            return;
        }

        // Group by date
        const byDate = {};
        allGames.forEach(g => {
            const d = g.displayDate;
            if (!byDate[d]) byDate[d] = [];
            byDate[d].push(g);
        });

        let gameIdx = 0;
        Object.keys(byDate).sort().forEach(day => {
            html += '<div class="day-hdr">' + fmtDate(day) + ' \u2014 ' + byDate[day].length + ' GAME' + (byDate[day].length > 1 ? 'S' : '') + '</div>';
            byDate[day].forEach(game => {
                const result = buildGameTotalCard(game, day, gameIdx);
                html += result.html;
                projections.push(result.data);
                gameIdx++;
            });
        });

        slateEl.innerHTML = html;
        bindGameLineInputs();
        bindLineupToggles();
        updateGameSummary();
        renderQuickScan('game');
    }

    // ═══ GAME TOTAL CARD BUILDER ═══
    function buildGameTotalCard(game, day, idx) {
        const awayTeam = game.teams.away.team.abbreviation || game.teams.away.team.name;
        const homeTeam = game.teams.home.team.abbreviation || game.teams.home.team.name;
        const awayPP = game.teams.away.probablePitcher || null;
        const homePP = game.teams.home.probablePitcher || null;

        // Get pitcher archetypes
        const awayPS = awayPP ? DATA.pitcherSeasons.filter(p => p.pitcher === awayPP.id).sort((a, b) => b.game_year - a.game_year)[0] : null;
        const homePS = homePP ? DATA.pitcherSeasons.filter(p => p.pitcher === homePP.id).sort((a, b) => b.game_year - a.game_year)[0] : null;
        const awayCluster = awayPS ? (DATA.clusters[awayPS.cluster] || {}) : {};
        const homeCluster = homePS ? (DATA.clusters[homePS.cluster] || {}) : {};

        // Get lineups
        const awayLineup = [];
        const homeLineup = [];
        if (game.lineups) {
            if (game.lineups.awayPlayers) game.lineups.awayPlayers.forEach(p => { if (p.id) awayLineup.push(p.id); });
            if (game.lineups.homePlayers) game.lineups.homePlayers.forEach(p => { if (p.id) homeLineup.push(p.id); });
        }

        const hasLineups = awayLineup.length > 0 && homeLineup.length > 0;

        // Project teams
        let awayProj = null, homeProj = null, totalRuns = 0;
        if (hasLineups) {
            awayProj = projectTeam(awayLineup, homePP ? homePP.id : null);
            homeProj = projectTeam(homeLineup, awayPP ? awayPP.id : null);
            totalRuns = awayProj.runs + homeProj.runs;
        }

        const _awayR = awayProj ? awayProj.runs : 0;
        const _homeR = homeProj ? homeProj.runs : 0;
        const _f5s = 5 / 9;
        const gameData = {
            awayTeam, homeTeam, totalRuns, hasLineups,
            awayRuns: _awayR,
            homeRuns: _homeR,
            spread: _homeR - _awayR,
            f5Total: totalRuns * _f5s,
            f5Spread: (_homeR - _awayR) * _f5s,
            awayProj, homeProj,
            awayPP: awayPP ? awayPP.fullName : 'TBD',
            homePP: homePP ? homePP.fullName : 'TBD'
        };

        let card = '<div class="game-total-card">';

        // Spine
        card += '<div class="gt-spine">';
        if (hasLineups) {
            card += '<div class="gt-total">' + totalRuns.toFixed(1) + '</div>';
            card += '<div class="gt-label">TOTAL<br>RUNS</div>';
        } else {
            card += '<div class="gt-total" style="font-size:1rem;color:var(--text-muted)">TBD</div>';
            card += '<div class="gt-label">LINEUP<br>PENDING</div>';
        }
        card += '</div>';

        // Content
        card += '<div class="gt-content">';

        // Matchup header
        card += '<div class="gt-matchup"><span>' + awayTeam + ' @ ' + homeTeam + '</span><span style="font-size:0.6rem;color:var(--text-muted);font-weight:400">' + fmtDate(day) + '</span></div>';

        // Pitchers
        card += '<div class="gt-pitchers">';
        const awayPName = awayPP ? awayPP.fullName : 'TBD';
        const homePName = homePP ? homePP.fullName : 'TBD';
        const awayArch = awayPS ? archName(awayPS.cluster) : '';
        const homeArch = homePS ? archName(homePS.cluster) : '';
        const awayColor = awayCluster.color || '#888';
        const homeColor = homeCluster.color || '#888';
        card += awayTeam + ' SP: <span class="sp-name">' + fmtName(awayPName) + '</span>';
        if (awayArch) card += ' <span style="color:' + awayColor + ';font-size:0.6rem">(' + awayArch + ')</span>';
        card += '<br>' + homeTeam + ' SP: <span class="sp-name">' + fmtName(homePName) + '</span>';
        if (homeArch) card += ' <span style="color:' + homeColor + ';font-size:0.6rem">(' + homeArch + ')</span>';
        card += '</div>';

        if (hasLineups) {
            // Side-by-side projections
            card += '<div class="gt-sides">';

            // Away offense
            card += '<div class="gt-side">';
            card += '<div class="gt-side-label">' + awayTeam + ' OFFENSE</div>';
            card += '<div class="gt-side-runs">' + awayProj.runs.toFixed(1) + '</div>';
            card += '<div class="gt-side-stats">';
            card += '<div class="mini-stat">H <span>' + awayProj.teamH.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">HR <span>' + awayProj.teamHR.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">TB <span>' + awayProj.teamTB.toFixed(1) + '</span></div>';
            card += '</div></div>';

            // Home offense
            card += '<div class="gt-side">';
            card += '<div class="gt-side-label">' + homeTeam + ' OFFENSE</div>';
            card += '<div class="gt-side-runs">' + homeProj.runs.toFixed(1) + '</div>';
            card += '<div class="gt-side-stats">';
            card += '<div class="mini-stat">H <span>' + homeProj.teamH.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">HR <span>' + homeProj.teamHR.toFixed(1) + '</span></div>';
            card += '<div class="mini-stat">TB <span>' + homeProj.teamTB.toFixed(1) + '</span></div>';
            card += '</div></div>';

            card += '</div>';

            // Game Lines: O/U, Spread, F5 O/U, F5 Spread
            const projSpread = homeProj.runs - awayProj.runs;
            const f5Scale = 5 / 9;
            const f5Total = (awayProj.runs + homeProj.runs) * f5Scale;
            const f5Spread = (homeProj.runs - awayProj.runs) * f5Scale;

            card += '<div class="lines-grid" style="margin-top:10px;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.15)">';
            card += '<div class="line-item"><label>O/U</label><input class="line-input game-ou-input" data-game-idx="' + idx + '" data-type="ou" placeholder="8.5"><div class="edge-display" id="game-edge-' + idx + '"></div></div>';
            card += '<div class="line-item"><label>SPREAD</label><input class="line-input game-spread-input" data-game-idx="' + idx + '" data-type="spread" placeholder="-1.5"><div class="edge-display" id="game-spread-' + idx + '"></div></div>';
            card += '<div class="line-item"><label>F5 O/U</label><input class="line-input game-f5ou-input" data-game-idx="' + idx + '" data-type="f5ou" placeholder="4.5"><div class="edge-display" id="game-f5ou-' + idx + '"></div></div>';
            card += '<div class="line-item"><label>F5 SPREAD</label><input class="line-input game-f5spread-input" data-game-idx="' + idx + '" data-type="f5spread" placeholder="-0.5"><div class="edge-display" id="game-f5spread-' + idx + '"></div></div>';
            card += '</div>';

            // Coverage
            const awayCov = awayProj.coverage + '/' + awayProj.total;
            const homeCov = homeProj.coverage + '/' + homeProj.total;
            const awayPct = awayProj.total > 0 ? awayProj.coverage / awayProj.total : 0;
            const homePct = homeProj.total > 0 ? homeProj.coverage / homeProj.total : 0;
            const awayClass = awayPct >= 0.7 ? 'cov-good' : 'cov-warn';
            const homeClass = homePct >= 0.7 ? 'cov-good' : 'cov-warn';
            card += '<div class="gt-coverage">COVERAGE: <span class="' + awayClass + '">' + awayCov + '</span> ' + awayTeam + ' \u00b7 <span class="' + homeClass + '">' + homeCov + '</span> ' + homeTeam + '</div>';

            // Lineup toggle
            card += '<div class="gt-lineup-toggle" data-gidx="' + idx + '">\u25B6 LINEUP DETAILS</div>';
            card += '<div class="gt-lineup-detail" id="lineup-detail-' + idx + '">';

            // Away lineup
            card += '<div class="gt-lineup-section">' + awayTeam + ' vs ' + (homeArch || 'Unknown') + '</div>';
            awayProj.batterDetails.forEach((bd, i) => {
                const lastName = fmtName(bd.name).split(' ').pop();
                card += '<div class="gt-batter-row">';
                card += '<span class="batter-name">' + (i + 1) + '. ' + lastName + '</span>';
                card += '<span class="batter-stats">H <span>' + bd.projH.toFixed(2) + '</span> TB <span>' + bd.projTB.toFixed(2) + '</span></span>';
                card += '<span class="batter-src">' + bd.source + '</span>';
                card += '</div>';
            });

            // Home lineup
            card += '<div class="gt-lineup-section">' + homeTeam + ' vs ' + (awayArch || 'Unknown') + '</div>';
            homeProj.batterDetails.forEach((bd, i) => {
                const lastName = fmtName(bd.name).split(' ').pop();
                card += '<div class="gt-batter-row">';
                card += '<span class="batter-name">' + (i + 1) + '. ' + lastName + '</span>';
                card += '<span class="batter-stats">H <span>' + bd.projH.toFixed(2) + '</span> TB <span>' + bd.projTB.toFixed(2) + '</span></span>';
                card += '<span class="batter-src">' + bd.source + '</span>';
                card += '</div>';
            });

            card += '</div>';
        } else {
            card += '<div class="gt-tbd">LINEUPS TBD &mdash; RUN CLOSER TO GAME TIME</div>';
        }

        card += '</div></div>';

        return { html: card, data: gameData };
    }

    function bindGameLineInputs() {
        document.querySelectorAll('.game-ou-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const proj = projections[idx];
                if (!proj || !proj.hasLineups) return;
                const display = document.getElementById('game-edge-' + idx);
                if (display) display.innerHTML = edgeLabel(proj.totalRuns, el.value);
            });
        });
        document.querySelectorAll('.game-spread-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const proj = projections[idx];
                if (!proj || !proj.hasLineups) return;
                const line = parseFloat(el.value);
                if (isNaN(line)) return;
                const spread = proj.spread || 0;
                const diff = spread - line;
                const display = document.getElementById('game-spread-' + idx);
                if (display) {
                    const fav = spread > 0 ? proj.homeTeam : proj.awayTeam;
                    display.innerHTML = diff > 0 ? '<span class="edge over">' + fav + ' COVERS</span>' : '<span class="edge under">NO COVER</span>';
                }
            });
        });
        document.querySelectorAll('.game-f5ou-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const proj = projections[idx];
                if (!proj || !proj.hasLineups) return;
                const display = document.getElementById('game-f5ou-' + idx);
                if (display) display.innerHTML = edgeLabel(proj.f5Total || 0, el.value);
            });
        });
        document.querySelectorAll('.game-f5spread-input').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.gameIdx);
                const proj = projections[idx];
                if (!proj || !proj.hasLineups) return;
                const line = parseFloat(el.value);
                if (isNaN(line)) return;
                const f5Spread = proj.f5Spread || 0;
                const diff = f5Spread - line;
                const display = document.getElementById('game-f5spread-' + idx);
                if (display) {
                    const fav = f5Spread > 0 ? proj.homeTeam : proj.awayTeam;
                    display.innerHTML = diff > 0 ? '<span class="edge over">' + fav + ' COVERS F5</span>' : '<span class="edge under">NO COVER F5</span>';
                }
            });
        });
    }

    function bindLineupToggles() {
        document.querySelectorAll('.gt-lineup-toggle').forEach(el => {
            el.addEventListener('click', () => {
                const idx = el.dataset.gidx;
                const detail = document.getElementById('lineup-detail-' + idx);
                detail.classList.toggle('visible');
                el.textContent = detail.classList.contains('visible') ? '\u25BC LINEUP DETAILS' : '\u25B6 LINEUP DETAILS';
            });
        });
    }

    function updateGameSummary() {
        const summary = document.getElementById('game-mode-summary');
        const stats = document.getElementById('game-summary-stats');
        if (projections.length === 0) { summary.style.display = 'none'; return; }

        const gamesWithLineups = projections.filter(p => p.hasLineups);
        const avgTotal = gamesWithLineups.length > 0
            ? gamesWithLineups.reduce((s, p) => s + p.totalRuns, 0) / gamesWithLineups.length : 0;

        summary.style.display = 'block';
        stats.innerHTML =
            '<div class="stat-row"><span>GAMES</span><span class="val mono">' + projections.length + '</span></div>' +
            '<div class="stat-row"><span>W/ LINEUPS</span><span class="val mono">' + gamesWithLineups.length + '</span></div>' +
            '<div class="stat-row"><span>AVG TOTAL</span><span class="val mono text-accent" style="font-size:1.1rem">' + avgTotal.toFixed(1) + '</span></div>';
    }

    // ═══ HITTER GAME CARD BUILDER ═══
    function buildGameCard(game, day, scheduleIdx) {
        let ps = null, cluster = null, cent = null;
        if (game.pitcher) {
            const allSeasons = DATA.pitcherSeasons.filter(p => p.pitcher === game.pitcher.id);
            if (allSeasons.length > 0) {
                ps = allSeasons.sort((a, b) => b.game_year - a.game_year)[0];
                cluster = DATA.clusters[ps.cluster] || null;
                cent = cluster || {};
            }
        }
        const clusterName = cluster ? archName(ps.cluster) : 'Unknown';
        const clusterColor = cluster ? cluster.color : '#666';
        const pitcherName = game.pitcher ? game.pitcher.name : 'TBD';
        const role = ps ? (ps.is_sp ? 'SP' : 'RP') : 'SP';

        let h2h = null;
        if (game.pitcher && selectedBatter) {
            const allMatchups = Object.values(DATA._hvpIndex[selectedBatter.batter] || {}).flat();
            h2h = allMatchups.find(m => m.p === game.pitcher.id) || null;
        }

        let archMatch = null;
        let recentArch = null; // Current season split
        if (ps && selectedBatter) {
            const archRows = DATA.hitterVsCluster.filter(r => r.batter === selectedBatter.batter && String(r.cluster) === ps.cluster);
            if (archRows.length > 0) {
                const _agg = (rows) => {
                    const t = { PA: 0, AB: 0, H: 0, HR: 0, BB: 0, K: 0, HBP: 0, woba_sum: 0, singles: 0, doubles: 0, triples: 0, pitches_seen: 0, whiff_weighted: 0 };
                    rows.forEach(r => { t.PA += r.PA || 0; t.AB += r.AB || 0; t.H += r.H || 0; t.HR += r.HR || 0; t.BB += r.BB || 0; t.K += r.K || 0; t.HBP += r.HBP || 0; t.woba_sum += (r.wOBA || 0) * (r.PA || 0); t.singles += r.singles || 0; t.doubles += r.doubles || 0; t.triples += r.triples || 0; t.pitches_seen += r.pitches_seen || 0; t.whiff_weighted += (r.whiff_rate_vs || 0) * (r.PA || 0) });
                    const tb = t.singles + (t.doubles * 2) + (t.triples * 3) + (t.HR * 4);
                    const ba = t.AB > 0 ? t.H / t.AB : 0;
                    const obp = t.PA > 0 ? (t.H + t.BB + t.HBP) / t.PA : 0;
                    const slg = t.AB > 0 ? tb / t.AB : 0;
                    return { PA: t.PA, BA: ba, OBP: obp, SLG: slg, ISO: slg - ba, wOBA: t.PA > 0 ? t.woba_sum / t.PA : 0, HR: t.HR, K: t.K, BB: t.BB, K_pct: t.PA > 0 ? t.K / t.PA : 0, BB_pct: t.PA > 0 ? t.BB / t.PA : 0, TB: tb, TB_rate: t.PA > 0 ? tb / t.PA : 0, whiff_vs: t.PA > 0 ? t.whiff_weighted / t.PA : 0 };
                };
                archMatch = _agg(archRows);

                // Recent season split (most recent year in data)
                const years = archRows.map(r => r.game_year).filter(Boolean);
                if (years.length > 0) {
                    const maxYear = Math.max(...years);
                    const recentRows = archRows.filter(r => r.game_year === maxYear);
                    if (recentRows.length > 0) {
                        const ra = _agg(recentRows);
                        if (ra.PA >= 3) { ra.year = maxYear; recentArch = ra; }
                    }
                }
            }
        }

        const assumedPA = role === 'SP' ? 4 : 1.5;
        let projBA = 0, projWOBA = 0, projHRrate = 0, projKrate = 0, projBBrate = 0, projTBrate = 0, projSource = '';
        if (h2h && h2h.pa >= 10) {
            projBA = h2h.ba || 0; projWOBA = h2h.w || 0; projHRrate = h2h.pa > 0 ? (h2h.hr || 0) / h2h.pa : 0;
            projKrate = h2h.pa > 0 ? (h2h.k || 0) / h2h.pa : 0; projBBrate = h2h.pa > 0 ? (h2h.bb || 0) / h2h.pa : 0;
            const estH = (h2h.ba || 0) * (h2h.pa - (h2h.bb || 0));
            projTBrate = h2h.pa > 0 ? (estH + (h2h.hr || 0) * 3) / h2h.pa : 0;
            projSource = 'head-to-head (' + h2h.pa + ' PA)';
        } else if (archMatch && archMatch.PA >= 5) {
            projBA = archMatch.BA; projWOBA = archMatch.wOBA; projHRrate = archMatch.PA > 0 ? archMatch.HR / archMatch.PA : 0;
            projKrate = archMatch.K_pct; projBBrate = archMatch.BB_pct;
            projTBrate = archMatch.TB_rate;
            projSource = h2h ? 'archetype avg (<10 PA direct)' : 'archetype avg (no direct history)';
        } else {
            projSource = 'insufficient data';
        }
        const projAB = assumedPA * (1 - projBBrate);
        const projH = projAB * projBA;
        const projHR = assumedPA * projHRrate;
        const projK = assumedPA * projKrate;
        const projBB = assumedPA * projBBrate;
        const projTB = assumedPA * projTBrate;
        const gameData = { pa: assumedPA, ab: projAB, h: projH, hr: projHR, k: projK, bb: projBB, tb: projTB, ba: projBA, woba: projWOBA, pitcher: pitcherName, cluster: ps ? ps.cluster : '', source: projSource, scheduleIdx: scheduleIdx };

        const idx = projections.length;
        let card = '<div class="game-card">';
        card += '<div class="card-spine"><div class="vs-label">VS</div><div class="opp-team">' + game.oppTeam + '</div>';
        card += '<div class="spine-mark"></div></div>';
        card += '<div class="card-content">';

        card += '<div class="matchup-header">';
        card += '<span class="pitcher-name-wrap"><span class="pitcher-name-text" id="pname-' + idx + '">' + pitcherName + '</span>';
        card += ' <span class="pitcher-edit-icon" data-idx="' + idx + '" title="Change pitcher">&#9998;</span></span>';
        card += '<span style="color:' + clusterColor + '" id="pcluster-' + idx + '">' + clusterName + '</span>';
        card += '</div>';

        if (game.overridden) {
            card += '<div class="pitcher-override-badge"><span>MANUAL OVERRIDE</span><span class="pitcher-reset" data-idx="' + idx + '">RESET</span></div>';
        }

        card += '<div class="pitcher-override-search" id="poverride-' + idx + '" style="display:none">';
        card += '<input type="text" class="po-search-input" id="psearch-' + idx + '" placeholder="SEARCH PITCHER..." autocomplete="off">';
        card += '<div class="po-drop" id="pdrop-' + idx + '"></div>';
        card += '</div>';

        card += '<div class="pitcher-info">';
        card += 'VELO: ' + (ps ? (ps.avg_velo_FF || 0).toFixed(1) : '\u2014') + ' \u00b7 ';
        card += 'WHIFF: ' + (ps ? ((ps.whiff_rate || 0) * 100).toFixed(0) + '%' : '\u2014') + ' \u00b7 ';
        card += 'GB: ' + (ps ? ((ps.groundball_rate || 0) * 100).toFixed(0) + '%' : '\u2014') + ' \u00b7 ';
        card += role;
        card += '</div>';

        // Source badge + matchup quality
        const isH2H = h2h && h2h.pa >= 10;
        const isArch = !isH2H && archMatch && archMatch.PA >= 5;
        let srcClass = 'src-none', srcText = 'NO DATA';
        if (isH2H) { srcClass = 'src-h2h'; srcText = 'H2H: ' + h2h.pa + ' PA'; }
        else if (isArch) { srcClass = 'src-archetype'; srcText = 'ARCHETYPE: ' + archMatch.PA + ' PA'; }
        else if (h2h && h2h.pa >= 1) { srcClass = 'src-archetype'; srcText = 'H2H: ' + h2h.pa + ' PA (LOW)'; }

        let mqClass = 'mq-3', mqText = '\u2014';
        const displayWOBA = isH2H ? (h2h.w || 0) : (archMatch ? archMatch.wOBA : 0);
        if (displayWOBA >= 0.370) { mqClass = 'mq-1'; mqText = '\u25cf\u25cf\u25cf HOT'; }
        else if (displayWOBA >= 0.340) { mqClass = 'mq-2'; mqText = '\u25cf\u25cf WARM'; }
        else if (displayWOBA >= 0.310) { mqClass = 'mq-3'; mqText = '\u25cf FAIR'; }
        else if (displayWOBA >= 0.270) { mqClass = 'mq-4'; mqText = '\u25cb COOL'; }
        else if (displayWOBA > 0) { mqClass = 'mq-5'; mqText = '\u25cb COLD'; }

        card += '<div class="gc-source-row">';
        card += '<div class="source-badge ' + srcClass + '">' + srcText + '</div>';
        if (displayWOBA > 0) card += '<div class="matchup-quality ' + mqClass + '">' + mqText + '</div>';
        card += '</div>';

        // H2H stats (show if any PA exist)
        if (h2h && h2h.pa >= 1) {
            const h2hOBP = h2h.pa > 0 ? ((h2h.h || 0) + (h2h.bb || 0)) / h2h.pa : 0;
            const h2hKpct = h2h.pa > 0 ? (h2h.k || 0) / h2h.pa : 0;
            const h2hBBpct = h2h.pa > 0 ? (h2h.bb || 0) / h2h.pa : 0;
            card += '<div class="gc-section">HEAD-TO-HEAD (' + h2h.pa + ' PA)</div>';
            card += '<div class="gc-stat-bar">';
            card += scC('BA', h2h.ba != null ? h2h.ba.toFixed(3) : '\u2014', baColor(h2h.ba || 0));
            card += scC('OBP', h2hOBP.toFixed(3), '');
            card += scC('wOBA', h2h.w != null ? h2h.w.toFixed(3) : '\u2014', wobaColor(h2h.w || 0));
            card += sc('HR', h2h.hr || 0);
            card += sc('K', h2h.k || 0);
            card += sc('BB', h2h.bb || 0);
            card += '</div>';
        }

        // Archetype stats (show alongside H2H if both exist)
        if (archMatch && archMatch.PA >= 5) {
            const archLabel = h2h && h2h.pa >= 1
                ? 'vs ARCHETYPE (' + archMatch.PA + ' PA CAREER)'
                : 'vs ' + clusterName.toUpperCase() + ' (' + archMatch.PA + ' PA CAREER)';
            card += '<div class="gc-section">' + archLabel + '</div>';
            card += '<div class="gc-stat-bar">';
            card += scC('BA', '~' + archMatch.BA.toFixed(3), baColor(archMatch.BA));
            card += scC('OBP', '~' + archMatch.OBP.toFixed(3), '');
            card += scC('SLG', '~' + archMatch.SLG.toFixed(3), '');
            card += scC('wOBA', '~' + archMatch.wOBA.toFixed(3), wobaColor(archMatch.wOBA));
            card += '</div>';
            card += '<div class="gc-stat-bar">';
            card += sc('K%', (archMatch.K_pct * 100).toFixed(0) + '%');
            card += sc('BB%', (archMatch.BB_pct * 100).toFixed(0) + '%');
            card += sc('ISO', archMatch.ISO.toFixed(3));
            if (archMatch.whiff_vs > 0) card += sc('WHIFF', (archMatch.whiff_vs * 100).toFixed(0) + '%');
            card += '</div>';

            // Recency split: current season vs career
            if (recentArch && recentArch.PA >= 3 && recentArch.year) {
                const rWoba = recentArch.wOBA;
                const cWoba = archMatch.wOBA;
                const trending = rWoba > cWoba + 0.030 ? 'rc-hot' : (rWoba < cWoba - 0.030 ? 'rc-cold' : '');
                card += '<div class="recency-row">';
                card += '<div class="recency-chip ' + trending + '"><span class="rc-label">' + recentArch.year + ': </span><span class="rc-val">' + recentArch.wOBA.toFixed(3) + ' wOBA</span></div>';
                card += '<div class="recency-chip"><span class="rc-label">BA </span><span class="rc-val">' + recentArch.BA.toFixed(3) + '</span></div>';
                card += '<div class="recency-chip"><span class="rc-label">SLG </span><span class="rc-val">' + recentArch.SLG.toFixed(3) + '</span></div>';
                card += '<div class="recency-chip"><span class="rc-label">' + recentArch.PA + ' PA</span></div>';
                card += '</div>';
            }
        }

        if (!h2h && (!archMatch || archMatch.PA < 5)) {
            card += '<div style="font-size:0.7rem;color:var(--text-muted);padding:8px 0">No matchup data available</div>';
        }

        // Projection
        card += '<div class="gc-section" style="color:var(--accent);margin-top:10px">PROJECTION</div>';
        card += '<div class="gc-stat-bar">';
        card += '<div class="sc"><div class="sl">PA</div><div class="sv"><input class="pa-edit" type="number" value="' + assumedPA + '" min="1" max="9" step="0.5" data-idx="' + idx + '"></div></div>';
        card += sc('H', projH.toFixed(2));
        card += sc('HR', projHR.toFixed(2));
        card += sc('K', projK.toFixed(2));
        card += sc('TB', projTB.toFixed(2));
        card += '</div>';

        // Player Props (always visible)
        card += '<div class="props-label">PLAYER PROPS</div>';
        card += '<div class="lines-panel" id="lines-' + idx + '">';
        card += '<div class="lines-grid">';
        card += '<div class="line-item"><label>O/U HITS</label><input class="line-input" data-idx="' + idx + '" data-stat="h" placeholder="1.5"><div class="edge-display" id="edge-h-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U HR</label><input class="line-input" data-idx="' + idx + '" data-stat="hr" placeholder="0.5"><div class="edge-display" id="edge-hr-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U K</label><input class="line-input" data-idx="' + idx + '" data-stat="k" placeholder="1.5"><div class="edge-display" id="edge-k-' + idx + '"></div></div>';
        card += '<div class="line-item"><label>O/U TB</label><input class="line-input" data-idx="' + idx + '" data-stat="tb" placeholder="1.5"><div class="edge-display" id="edge-tb-' + idx + '"></div></div>';
        card += '</div></div>';

        card += '</div></div>';
        return { html: card, data: gameData };
    }

    function bindPAEdits() {
        document.querySelectorAll('.pa-edit').forEach(el => {
            el.addEventListener('change', () => {
                const idx = parseInt(el.dataset.idx);
                const newPA = parseFloat(el.value) || 4;
                recalcGame(idx, newPA);
            });
        });
    }

    function bindLineInputs() {
        document.querySelectorAll('.line-input:not(.game-ou-input)').forEach(el => {
            el.addEventListener('input', () => {
                const idx = parseInt(el.dataset.idx);
                const stat = el.dataset.stat;
                const line = el.value;
                const proj = projections[idx];
                if (!proj) return;
                const projVal = proj[stat] || 0;
                const display = document.getElementById('edge-' + stat + '-' + idx);
                if (display) display.innerHTML = edgeLabel(projVal, line);
            });
        });
    }

    // ═══ PITCHER OVERRIDE ═══
    function bindPitcherOverrides() {
        document.querySelectorAll('.pitcher-edit-icon').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.idx);
                const searchPanel = document.getElementById('poverride-' + idx);
                searchPanel.style.display = searchPanel.style.display === 'none' ? 'block' : 'none';
                if (searchPanel.style.display === 'block') {
                    document.getElementById('psearch-' + idx).focus();
                }
            });
        });

        document.querySelectorAll('.pitcher-reset').forEach(el => {
            el.addEventListener('click', () => {
                const idx = parseInt(el.dataset.idx);
                const p = projections[idx];
                if (!p) return;
                const schedIdx = p.scheduleIdx;
                const game = schedule[schedIdx];
                if (!game) return;
                game.pitcher = game.originalPitcher ? { ...game.originalPitcher } : null;
                game.overridden = false;
                rebuildSingleCard(idx, schedIdx);
            });
        });

        document.querySelectorAll('.po-search-input').forEach(el => {
            const idx = parseInt(el.id.replace('psearch-', ''));
            const drop = document.getElementById('pdrop-' + idx);
            let results = [];

            el.addEventListener('input', () => {
                const q = el.value.trim();
                if (q.length < 2) { drop.classList.remove('visible'); return; }
                results = fusePitchers.search(q).slice(0, 6).map(r => r.item);
                drop.innerHTML = results.map((item, i) => {
                    const cl = DATA.clusters[item.cluster] || {};
                    return '<div class="s-item" data-pidx="' + i + '"><span>' + fmtName(item.player_name) + '</span><span class="pa" style="color:' + (cl.color || '#888') + '">' + archName(item.cluster) + '</span></div>';
                }).join('');
                drop.classList.add('visible');
            });

            drop.addEventListener('mousedown', (e) => {
                e.preventDefault();
                const item = e.target.closest('.s-item');
                if (!item) return;
                const pitcherSeason = results[parseInt(item.dataset.pidx)];
                applyPitcherOverride(idx, pitcherSeason);
                drop.classList.remove('visible');
                el.value = '';
                document.getElementById('poverride-' + idx).style.display = 'none';
            });

            el.addEventListener('blur', () => { setTimeout(() => drop.classList.remove('visible'), 150); });
        });
    }

    function applyPitcherOverride(cardIdx, pitcherSeason) {
        const p = projections[cardIdx];
        if (!p) return;
        const schedIdx = p.scheduleIdx;
        schedule[schedIdx].pitcher = { id: pitcherSeason.pitcher, name: pitcherSeason.player_name };
        schedule[schedIdx].overridden = true;
        rebuildSingleCard(cardIdx, schedIdx);
    }

    function rebuildSingleCard(cardIdx, schedIdx) {
        const game = schedule[schedIdx];
        const day = game.date;
        const proj = buildGameCard(game, day, schedIdx);
        projections[cardIdx] = proj.data;

        const cards = document.querySelectorAll('.game-card');
        if (cards[cardIdx]) {
            cards[cardIdx].outerHTML = proj.html;
        }

        bindPAEdits();
        bindLineInputs();
        bindPitcherOverrides();
        updateTotalsDock();
    }

    function recalcGame(idx, newPA) {
        const p = projections[idx];
        if (!p) return;
        const oldPA = p.pa;
        p.pa = newPA;
        p.ab = newPA * (1 - (p.ba > 0 ? (p.bb / (p.bb + p.ab + p.h)) : 0));
        p.h = p.ab * p.ba;
        p.hr = newPA * (oldPA > 0 ? p.hr / oldPA : 0);
        p.k = newPA * (oldPA > 0 ? p.k / oldPA : 0);
        p.bb = newPA * (oldPA > 0 ? p.bb / oldPA : 0);
        p.tb = newPA * (oldPA > 0 ? p.tb / oldPA : 0);
        updateTotalsDock();
    }

    function updateTotalsDock() {
        const dock = document.getElementById('totals-dock');
        if (projections.length === 0 || currentMode === 'game') { dock.style.display = 'none'; return; }
        dock.style.display = 'block';
        let tPA = 0, tH = 0, tHR = 0, tK = 0, tBB = 0, tTB = 0;
        projections.forEach(p => { tPA += p.pa; tH += p.h || 0; tHR += p.hr || 0; tK += p.k || 0; tBB += p.bb || 0; tTB += p.tb || 0 });

        document.getElementById('dock-stats').innerHTML =
            '<div class="stat-row"><span>PA</span><span class="val mono">' + tPA.toFixed(0) + '</span></div>' +
            '<div class="stat-row"><span>HITS</span><span class="val mono">' + tH.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>HR</span><span class="val mono">' + tHR.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>K</span><span class="val mono">' + tK.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>BB</span><span class="val mono">' + tBB.toFixed(1) + '</span></div>' +
            '<div class="stat-row"><span>TB</span><span class="val mono text-accent" style="font-size:1.1rem">' + tTB.toFixed(1) + '</span></div>';
    }

    // ═══ SAVE/LOAD PROJECTIONS ═══
    let savedProjections = JSON.parse(localStorage.getItem('pfx_sim_projections') || '[]');
    renderSaved();

    document.getElementById('btn-save-dock').addEventListener('click', saveProjection);

    function saveProjection() {
        if (projections.length === 0) return;
        let playerName;
        if (currentMode === 'team') {
            playerName = selectedTeam ? selectedTeam.abbr + ' TEAM' : 'Unknown';
        } else if (currentMode === 'hitter') {
            playerName = selectedBatter ? selectedBatter.batter_name : 'Unknown';
        } else {
            playerName = selectedPitcher ? selectedPitcher.player_name : 'Unknown';
        }
        let tPA = 0, tAB = 0, tH = 0, tHR = 0, tK = 0, tBB = 0, tTB = 0, tWS = 0;
        if (currentMode === 'team') {
            projections.forEach(p => { tH += p.totalH || 0; tHR += p.totalHR || 0; tK += p.totalK || 0; tTB += p.totalTB || 0; });
        } else {
            projections.forEach(p => { tPA += p.pa; tAB += p.ab || 0; tH += p.h || 0; tHR += p.hr || 0; tK += p.k || 0; tBB += p.bb || 0; tTB += p.tb || 0; tWS += (p.woba || 0) * p.pa });
        }
        const selectedDates = getSelectedDates();
        savedProjections.push({
            hitter_name: playerName, hitter_id: selectedBatter ? selectedBatter.batter : (selectedPitcher ? selectedPitcher.pitcher : 0),
            mode: currentMode,
            selected_dates: [...selectedDates].sort(),
            week_start: [...selectedDates].sort()[0],
            pa: +tPA.toFixed(0), ab: +tAB.toFixed(0), h: +tH.toFixed(1),
            hr: +tHR.toFixed(1), k: +tK.toFixed(1), bb: +tBB.toFixed(1),
            tb: +tTB.toFixed(1),
            ba: tAB > 0 ? +(tH / tAB).toFixed(3) : 0, woba: tPA > 0 ? +(tWS / tPA).toFixed(3) : 0,
            timestamp: Date.now()
        });
        localStorage.setItem('pfx_sim_projections', JSON.stringify(savedProjections));
        renderSaved();
    }

    function renderSaved() {
        const rows = document.getElementById('saved-rows');
        const empty = document.getElementById('empty-msg');
        if (!savedProjections.length) { rows.innerHTML = ''; empty.style.display = 'block'; return }
        empty.style.display = 'none';
        rows.innerHTML = savedProjections.map((s, i) => {
            const dates = s.selected_dates
                ? s.selected_dates.length + 'd'
                : new Date(s.week_start + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const tb = s.tb != null ? s.tb : ((s.h || 0) + (s.hr || 0) * 3);
            const lastName = fmtName(s.hitter_name).split(' ').pop();
            return '<tr><td title="' + fmtName(s.hitter_name) + '">' + lastName + '</td>' +
                '<td>' + dates + '</td>' +
                '<td>' + (s.h || 0).toFixed(1) + '</td>' +
                '<td>' + (s.hr || 0).toFixed(1) + '</td>' +
                '<td>' + (s.k || 0).toFixed(1) + '</td>' +
                '<td style="color:var(--accent);font-weight:700">' + (+tb).toFixed(1) + '</td>' +
                '<td class="del" data-del="' + i + '">\u00d7</td></tr>';
        }).join('');
    }
    document.getElementById('saved-rows').addEventListener('click', (e) => {
        const del = e.target.closest('.del');
        if (!del) return;
        savedProjections.splice(parseInt(del.dataset.del), 1);
        localStorage.setItem('pfx_sim_projections', JSON.stringify(savedProjections));
        renderSaved();
    });
    document.getElementById('btn-clear-all').addEventListener('click', () => {
        if (!confirm('Clear all saved projections?')) return;
        savedProjections = []; localStorage.removeItem('pfx_sim_projections'); renderSaved();
    });
    document.getElementById('btn-export').addEventListener('click', () => {
        if (!savedProjections.length) return;
        let csv = 'Player,Mode,Dates,PA,AB,H,HR,K,BB,TB,BA,wOBA\n';
        savedProjections.forEach(s => {
            const dates = s.selected_dates ? s.selected_dates.join(';') : s.week_start;
            const tb = s.tb != null ? s.tb : ((s.h || 0) + (s.hr || 0) * 3);
            csv += fmtName(s.hitter_name) + ',' + (s.mode || 'hitter') + ',' + dates + ',' + s.pa + ',' + s.ab + ',' + s.h + ',' + s.hr + ',' + s.k + ',' + s.bb + ',' + (+tb).toFixed(1) + ',' + s.ba + ',' + s.woba + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'projections_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
    });

    // ═══ RESEARCH PAD ═══
    const pad = document.getElementById('pad');
    pad.value = localStorage.getItem('pfx_sim_notes') || '';
    let padDirty = false;
    pad.addEventListener('input', () => { padDirty = true });
    setInterval(() => { if (padDirty) { localStorage.setItem('pfx_sim_notes', pad.value); padDirty = false } }, 5000);
    document.getElementById('pad-save').addEventListener('click', () => { localStorage.setItem('pfx_sim_notes', pad.value); flash('flash-save') });
    document.getElementById('pad-copy').addEventListener('click', () => { navigator.clipboard.writeText(pad.value).then(() => flash('flash-copy')) });
    document.getElementById('pad-clear').addEventListener('click', () => { if (confirm('Clear all notes?')) { pad.value = ''; localStorage.removeItem('pfx_sim_notes') } });
    function flash(id) { const el = document.getElementById(id); el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 1500) }

    // ═══ UI HELPERS ═══
    function showBanner(msg) { const b = document.getElementById('status-banner'); b.textContent = msg; b.classList.add('visible') }
    function hideBanner() { const b = document.getElementById('status-banner'); b.classList.remove('visible'); b.classList.remove('loading') }

    // ═══ INIT ═══
    document.getElementById('loading-overlay').remove();
    document.getElementById('no-player').style.display = 'none';
    document.getElementById('empty-state').style.display = 'flex';
    searchInput.focus();
    if (PRESELECT) selectBatter(PRESELECT);
})();
</script>
</body>
</html>
