<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ARCHETYPE//ATLAS.MLB</title>
<style>
:root {
    --bg: #0a0a0a;
    --panel: #111111;
    --card: #1a1a1a;
    --accent: #ff4400;
    --accent-dark: #cc3600;
    --text: #f0f0f0;
    --text-sec: #e0e0e0;
    --text-label: #888;
    --text-dim: #666;
    --text-muted: #444;
    --border: #2a2a2a;
    --border-lt: #333;
    --green: #2a9d8f;
    --teal: #a8dadc;
    --yellow: #f4a261;
    --orange: #e76f51;
    --red: #e63946;
    --font-tech: 'Courier New', Courier, monospace;
    --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --topbar-h: 52px;
    --tabbar-h: 56px;
}
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }
body {
    background: var(--bg); color: var(--text); font-family: var(--font-ui);
    width: 100vw; min-height: 100vh; overflow-x: hidden;
    overscroll-behavior: contain; -webkit-text-size-adjust: 100%;
    padding-top: var(--topbar-h);
    padding-bottom: var(--tabbar-h);
}
/* â•â•â• TOPBAR â•â•â• */
.topbar {
    position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h);
    background: var(--bg); border-bottom: 1px solid #222;
    display: flex; align-items: center; padding: 0 12px; gap: 10px; z-index: 100;
}
.logo { font-size: 14px; font-weight: 800; color: var(--accent); font-family: var(--font-ui); white-space: nowrap; }
.search-box { position: relative; flex: 1; min-width: 0; }
.search-box input {
    width: 100%; height: 34px; background: #141414; border: 1px solid var(--border-lt);
    border-radius: 4px; color: var(--text); font-family: var(--font-tech);
    font-size: 12px; padding: 0 10px; outline: none;
}
.search-box input:focus { border-color: var(--accent); }
.search-box input::placeholder { color: #666; }
.search-dropdown {
    position: absolute; top: 100%; left: 0; width: 100%; max-height: 240px;
    overflow-y: auto; background: #141414; border: 1px solid var(--border-lt);
    border-top: none; z-index: 200; display: none; border-radius: 0 0 4px 4px;
}
.search-dropdown.visible { display: block; }
.search-result {
    padding: 10px 12px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #1a1a1a; font-size: 12px; color: #e0e0e0;
    font-family: var(--font-tech); font-weight: 600; min-height: 44px;
}
.search-result.highlighted { background: #1e1e1e; color: #fff; }
.search-result .pa-label { color: #888; font-size: 10px; }
.filter-toggle {
    width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
    background: var(--card); border: 1px solid var(--border-lt); border-radius: 4px;
    color: var(--text-label); font-size: 16px; cursor: pointer; flex-shrink: 0;
}
.filter-toggle.active { border-color: var(--accent); color: var(--accent); }

/* â•â•â• BATTER CHIP â•â•â• */
.batter-chip-bar {
    display: none; padding: 6px 12px; background: var(--bg); border-bottom: 1px solid #1a1a1a;
    overflow-x: auto; white-space: nowrap; gap: 6px;
}
.batter-chip-bar.visible { display: flex; }
.batter-chip {
    display: inline-flex; align-items: center; gap: 4px; background: var(--card);
    border: 1px solid var(--border-lt); color: var(--text); padding: 4px 10px;
    border-radius: 16px; font-size: 11px; font-family: var(--font-tech); font-weight: 700;
    white-space: nowrap; flex-shrink: 0;
}
.batter-chip .remove { color: #666; font-size: 14px; margin-left: 2px; padding: 0 2px; }

/* â•â•â• FILTER BAR â•â•â• */
.filter-bar {
    display: flex; padding: 8px 12px; overflow-x: auto; white-space: nowrap;
    gap: 6px; background: var(--bg); border-bottom: 1px solid #1a1a1a;
    -webkit-overflow-scrolling: touch;
}
.pill {
    display: inline-flex; align-items: center; justify-content: center;
    height: 32px; padding: 0 12px; background: var(--card); border: 1px solid var(--border-lt);
    border-radius: 16px; font-size: 11px; font-weight: 600; color: var(--text-label);
    font-family: var(--font-ui); white-space: nowrap; flex-shrink: 0; cursor: pointer;
    transition: all 0.15s; min-width: 44px;
}
.pill.active { border-color: var(--accent); color: var(--accent); }
.pill-sep { width: 1px; height: 20px; background: var(--border); flex-shrink: 0; margin: 0 2px; }
.filter-bar select {
    height: 32px; background: var(--card); border: 1px solid var(--border-lt);
    border-radius: 16px; color: var(--text-label); font-size: 11px; padding: 0 8px;
    font-family: var(--font-ui); outline: none; -webkit-appearance: none;
}
.filter-bar .pa-wrap {
    display: flex; align-items: center; gap: 4px; flex-shrink: 0;
}
.filter-bar .pa-wrap span { font-size: 9px; color: var(--text-label); font-weight: 700; white-space: nowrap; }
.filter-bar input[type=range] {
    -webkit-appearance: none; width: 60px; height: 2px; background: #555; border-radius: 1px;
}
.filter-bar input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent);
    border-radius: 50%; cursor: pointer;
}

/* â•â•â• CANVAS â•â•â• */
.canvas-wrap {
    width: 100%; height: 0; position: relative; background: var(--bg);
    touch-action: auto; overflow: hidden; display: none;
}
.canvas-wrap canvas { display: block; width: 100%; height: 100%; }
.batter-badge {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    background: rgba(30,33,36,0.92); border: 1px solid #333;
    color: #fff; padding: 5px 14px; border-radius: 16px;
    font-family: var(--font-tech); font-size: 11px; font-weight: 700;
    z-index: 10; white-space: nowrap; opacity: 0; transition: opacity 0.3s;
    pointer-events: none;
}
.batter-badge.visible { opacity: 1; }

/* â•â•â• ARCHETYPE SPREAD â•â•â• */
.archetype-spread {
    padding: 8px 8px 4px; background: var(--bg);
    border-bottom: 1px solid #222;
}
.spread-label {
    font-size: 8px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; color: #555; font-family: var(--font-tech);
    margin-bottom: 2px; text-align: center;
}
.spread-row {
    display: flex; gap: 2px; margin-bottom: 2px;
}
.spread-row.stagger-row {
    padding-left: 37px;
}
.spread-hand-label {
    font-size: 7px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; color: #444; font-family: var(--font-tech);
    margin: 4px 0 2px 2px;
}
.spread-chip {
    width: 74px; height: 62px; border-radius: 8px;
    background: rgba(255,255,255,0.04); border: 1px solid transparent;
    border-bottom: 3px solid #666;
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; gap: 2px; cursor: pointer;
    transition: background 0.15s, transform 0.1s, border-color 0.15s;
    flex-shrink: 0;
}
.spread-chip:active { transform: scale(0.92); }
.spread-chip.selected { border-color: var(--accent); background: rgba(255,68,0,0.08); }
.spread-chip.dimmed { opacity: 0.2; }
.spread-chip .chip-emoji { font-size: 36px; line-height: 1; }
.spread-chip .chip-label {
    font-size: 9px; font-weight: 800; color: #bbb;
    font-family: var(--font-tech); text-transform: uppercase;
    letter-spacing: 0; line-height: 1;
}
.spread-chip .chip-stat {
    font-size: 10px; font-weight: 800; font-family: var(--font-tech);
    line-height: 1;
}

/* â•â•â• ARCHETYPE LIST â•â•â• */
.arch-list { background: var(--bg); }
.arch-group-hdr {
    font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px;
    padding: 16px 16px 8px; color: #777; border-top: 1px solid #222;
    margin-top: 4px;
}

/* â•â•â• ARCHETYPE CARDS â•â•â• */
.arch-card {
    padding: 14px 16px; background: #131313; border-left: 3px solid #666;
    margin: 6px 10px; border-radius: 8px; cursor: pointer;
    transition: background 0.2s, border-color 0.2s, transform 0.1s;
}
.arch-card:active { background: rgba(255,255,255,0.04); transform: scale(0.99); }
.arch-card.selected { background: #1a1a1a; border-left-color: var(--accent) !important; }
.arch-card.dimmed { opacity: 0.15; }
.card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.card-name { font-weight: 800; font-size: 15px; letter-spacing: 0.3px; }
.card-count { font-size: 11px; color: #999; font-family: var(--font-tech); font-weight: 700; }
.card-profile { font-size: 12px; color: #999; font-family: var(--font-tech); margin-bottom: 3px; }
.card-matchup { font-size: 13px; font-family: var(--font-tech); font-weight: 800; margin-bottom: 3px; }
.card-roles { display: flex; gap: 10px; margin-top: 5px; }
.role-tag { font-size: 11px; font-family: var(--font-tech); font-weight: 700; color: var(--text-label); }
.role-tag.sp { color: #f4a261; }
.role-tag.rp { color: #a8dadc; }

.arch-stat {
    font-size: 12px; font-weight: 800; font-family: var(--font-tech);
    width: 48px; text-align: center; flex-shrink: 0; padding: 2px 4px; border-radius: 3px;
}
.arch-stat.perf-great { background: rgba(42,157,143,0.15); color: var(--green); }
.arch-stat.perf-good { background: rgba(168,218,220,0.12); color: var(--teal); }
.arch-stat.perf-avg { color: var(--text-sec); }
.arch-stat.perf-poor { background: rgba(231,111,81,0.12); color: var(--orange); }
.arch-stat.perf-bad { background: rgba(230,57,70,0.15); color: var(--red); }
.arch-stat.empty { color: var(--text-muted); font-weight: 400; }
.arch-count { font-size: 11px; color: var(--text-label); font-family: var(--font-tech); font-weight: 700; }

/* â•â•â• ARCHETYPE KEY â•â•â• */
.key-item { padding: 10px 0; border-bottom: 1px solid #1a1a1a; }
.key-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.key-emoji { font-size: 20px; }
.key-name { font-size: 13px; font-weight: 800; letter-spacing: 0.5px; }
.key-desc { font-size: 11px; color: #999; font-family: var(--font-tech); line-height: 1.4; padding-left: 28px; }
.key-clusters { font-size: 10px; font-family: var(--font-tech); padding-left: 28px; margin-top: 2px; }
.key-examples { font-size: 10px; color: #666; font-family: var(--font-tech); padding-left: 28px; margin-top: 2px; font-style: italic; }

/* â•â•â• HUNT FEED â•â•â• */
.hunt-row { display: flex; align-items: baseline; gap: 8px; padding: 8px 0; border-bottom: 1px solid #1a1a1a; }
.hunt-ba { font-size: 18px; font-weight: 800; font-family: var(--font-tech); width: 50px; flex-shrink: 0; }
.hunt-arch { font-size: 12px; font-weight: 700; flex: 1; }
.hunt-meta { font-size: 10px; color: #888; font-family: var(--font-tech); white-space: nowrap; }

.tags-placeholder { opacity: 0.5; }

/* â•â•â• BOTTOM SHEET â•â•â• */
.sheet-backdrop {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5); z-index: 199; opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
}
.sheet-backdrop.visible { opacity: 1; pointer-events: auto; }
.bottom-sheet {
    position: fixed; left: 0; right: 0; bottom: 0;
    background: #0d0d0d; border-top-left-radius: 16px; border-top-right-radius: 16px;
    z-index: 200; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.19,1,0.22,1);
    max-height: 88vh; display: flex; flex-direction: column;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
}
.bottom-sheet.peek { transform: translateY(calc(100% - 140px)); }
.bottom-sheet.full { transform: translateY(0); }
.sheet-handle {
    display: flex; justify-content: center; padding: 10px 0 6px; cursor: grab; flex-shrink: 0; position: relative;
}
.sheet-handle-bar { width: 40px; height: 4px; background: #444; border-radius: 2px; }
#sheet-close {
    position: absolute; right: 12px; top: 6px;
    width: 32px; height: 32px; border: none; background: #222; color: #888;
    font-size: 20px; line-height: 1; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}
#sheet-close:active { background: #333; color: #fff; }
.sheet-content {
    flex: 1; overflow-y: auto; padding: 0 16px 80px; -webkit-overflow-scrolling: touch;
}
/* Stat panel styles inside sheet */
.sheet-content .stat-header { font-weight: 700; font-size: 18px; color: #fff; margin-bottom: 2px; }
.sheet-content .stat-sub {
    font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
    font-weight: 700; margin-bottom: 12px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border-lt); display: inline-block;
}
.sheet-content .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-bottom: 12px; }
.sheet-content .stat-cell {
    background: #1e2124; border-radius: 4px; padding: 8px 6px; text-align: center;
}
.sheet-content .s-label { font-size: 9px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; font-weight: 600; }
.sheet-content .s-val { font-size: 17px; font-weight: 800; color: #fff; font-family: var(--font-tech); }
.sheet-content .section-hdr {
    font-size: 10px; color: #aaa; text-transform: uppercase;
    letter-spacing: 1px; margin: 14px 0 6px; border-bottom: 1px solid var(--border-lt);
    padding-bottom: 3px; font-weight: 700;
}
.sheet-content .profile-row {
    display: flex; justify-content: space-between; font-size: 12px;
    padding: 5px 0; color: #ccc; font-family: var(--font-tech); font-weight: 600;
}
.sheet-content .profile-row .pval { font-weight: 800; color: #fff; }
.sheet-content .matchup-bar {
    display: flex; align-items: center; gap: 6px; margin-bottom: 4px;
    font-size: 11px; font-family: var(--font-tech); color: #ddd; font-weight: 600;
}
.sheet-content .matchup-bar .yr { width: 30px; color: #999; font-weight: 700; }
.sheet-content .matchup-bar .bar-track { flex: 1; height: 7px; background: #1a1a1a; overflow: hidden; border-radius: 2px; }
.sheet-content .matchup-bar .bar-fill { height: 100%; border-radius: 2px; }
.sheet-content .matchup-bar .woba-val { width: 38px; text-align: right; font-weight: 700; }
.sheet-content .matchup-bar .pa-val { width: 36px; text-align: right; color: #888; font-size: 10px; }
.sheet-content .king-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 4px 0; font-size: 11px; border-bottom: 1px solid #1a1a1a;
    color: #e0e0e0; font-family: var(--font-tech); font-weight: 600;
}
.sheet-content .king-row .k-name { flex: 1; }
.sheet-content .king-row .k-stat { width: 32px; text-align: right; font-weight: 800; }
.sheet-content .roster-head {
    display: grid; grid-template-columns: 1fr 32px 38px 28px 28px 38px;
    padding: 4px 4px; font-size: 9px; color: #888; text-transform: uppercase;
    letter-spacing: 0.5px; border-bottom: 1px solid var(--border-lt); gap: 2px; font-weight: 700;
}
.sheet-content .roster-head span { text-align: right; }
.sheet-content .roster-head span:first-child { text-align: left; }
.sheet-content .roster-list { max-height: 300px; overflow-y: auto; margin-bottom: 8px; }
.sheet-content .roster-row {
    display: grid; grid-template-columns: 1fr 32px 38px 28px 28px 38px;
    align-items: center; padding: 5px 4px; font-size: 11px;
    font-family: var(--font-tech); color: #ccc;
    border-bottom: 1px solid #1a1a1a; gap: 2px; font-weight: 600;
}
.sheet-content .roster-row .r-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #eee; font-weight: 700; }
.sheet-content .roster-row .r-val { text-align: right; font-size: 10px; }
.sheet-content .roster-row .r-val.highlight { font-weight: 800; }
.sheet-content .roster-sort { display: flex; gap: 2px; }
.sheet-content .sort-btn {
    background: #1a1a1a; border: 1px solid #2a2a2a; color: #666;
    font-size: 9px; padding: 3px 6px; font-family: var(--font-tech);
    text-transform: uppercase; border-radius: 2px; min-height: 28px;
}
.sheet-content .sort-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
.sheet-content .arch-link {
    cursor: pointer; padding: 8px 10px; background: #1a1a1a; border: 1px solid #2a2a2a;
    border-radius: 4px; display: flex; align-items: center; gap: 8px; margin-top: 8px;
}
.sheet-content .roster-empty { font-size: 10px; color: #444; font-family: var(--font-tech); padding: 8px 0; text-align: center; }

/* â•â•â• TAB BAR â•â•â• */
.tabbar {
    position: fixed; bottom: 0; left: 0; right: 0; height: var(--tabbar-h);
    background: var(--bg); border-top: 1px solid #222;
    display: flex; z-index: 300;
    padding-bottom: env(safe-area-inset-bottom);
}
.tab {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    justify-content: center; gap: 2px; color: var(--text-dim);
    font-size: 9px; font-weight: 600; cursor: pointer; transition: color 0.15s;
    min-height: 44px;
}
.tab.active { color: var(--accent); }
.tab-icon { font-size: 20px; line-height: 1; }

/* â•â•â• LOADER â•â•â• */
#loader {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg); z-index: 500;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    transition: opacity 0.8s;
}
.loader-brand { font-size: 18px; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 10px; }
.loader-icon { width: 20px; height: 20px; background: var(--accent); border-radius: 3px; }
.loader-status { font-size: 10px; color: var(--text-label); font-family: var(--font-tech); margin-top: 12px; letter-spacing: 1px; }

/* Scrollbar */
::-webkit-scrollbar { width: 2px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #555; border-radius: 1px; }
</style>
</head>
<body>

<div id="loader">
    <div class="loader-brand"><div class="loader-icon"></div>ARCHETYPE//ATLAS.MLB</div>
    <div class="loader-status" id="loader-status">INITIALIZING...</div>
</div>

<!-- TOPBAR -->
<div class="topbar">
    <div class="logo">A//A</div>
    <div class="search-box">
        <input type="text" id="batter-search" placeholder="SEARCH BATTER..." autocomplete="off">
        <div class="search-dropdown" id="search-dropdown"></div>
    </div>
</div>

<!-- BATTER CHIPS -->
<div class="batter-chip-bar" id="batter-chip-bar"></div>

<!-- FILTER BAR -->
<div class="filter-bar" id="filter-bar">
    <div class="pill active" data-stat="wOBA">wOBA</div>
    <div class="pill" data-stat="BA">BA</div>
    <div class="pill" data-stat="SLG">SLG</div>
    <div class="pill" data-stat="K_pct">K%</div>
    <div class="pill" data-stat="BB_pct">BB%</div>
    <div class="pill-sep"></div>
    <div class="pill active" data-filter="all">ALL</div>
    <div class="pill" data-filter="RHP">RHP</div>
    <div class="pill" data-filter="LHP">LHP</div>
    <div class="pill-sep"></div>
    <select id="team-select"><option value="">ALL TEAMS</option></select>
    <select id="year-select"><option value="all">ALL YEARS</option></select>
    <div class="pa-wrap">
        <span>PA:<span id="pa-val">10</span></span>
        <input type="range" min="1" max="200" value="10" id="pa-slider">
    </div>
    <div class="pill-sep"></div>
    <div class="pill" data-role="all" style="background:#f4a261;color:#111;">ALL</div>
    <div class="pill" data-role="SP">SP</div>
    <div class="pill" data-role="RP">RP</div>
</div>

<!-- CANVAS -->
<div class="canvas-wrap" id="canvas-wrap">
    <canvas id="plot"></canvas>
    <div class="batter-badge" id="batter-badge">
        <strong id="badge-name"></strong> <span id="badge-stat"></span>
    </div>
</div>

<!-- ARCHETYPE SPREAD -->
<div class="archetype-spread" id="archetype-spread"></div>

<!-- ARCHETYPE LIST -->
<div class="arch-list" id="archetype-list"></div>

<!-- BOTTOM SHEET -->
<div class="sheet-backdrop" id="sheet-backdrop"></div>
<div class="bottom-sheet" id="bottom-sheet">
    <div class="sheet-handle" id="sheet-handle"><div class="sheet-handle-bar"></div><button id="sheet-close" aria-label="Close">&times;</button></div>
    <div class="sheet-content" id="sheet-content"></div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
    <div class="tab active" data-tab="home"><div class="tab-icon">â—‰</div>Home</div>
    <div class="tab" data-tab="key"><div class="tab-icon">ğŸ”‘</div>Key</div>
    <div class="tab" data-tab="hunt"><div class="tab-icon">ğŸ¯</div>Hunt</div>
    <div class="tab" data-tab="sim"><div class="tab-icon">âš¡</div>SIM</div>
    <div class="tab" data-tab="more"><div class="tab-icon">â‹¯</div>More</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
<script>
(function() {
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA = { clusters: {}, batters: [], pitcherSeasons: [], hitterVsCluster: [], hitterVsPitcher: [], archetypeKings: {}, teamRosters: {} };

const ARCHETYPE_MAP = {
    // RHP
    'R_0': { name: 'Cut & Curved',   emoji: '\u2702\uFE0F' },    // FF:34% CU:20% FC:18%
    'R_1': { name: 'Boomerang',      emoji: '\u{1FA83}' },       // SV:20% SI:24% FF:28%
    'R_2': { name: 'Ghost Baller',   emoji: '\u{1F47B}' },       // FF:39% CH:29% â€” changeup dominant
    'R_3': { name: 'Triple Threat',  emoji: '\u2694\uFE0F' },    // FF:42% SL:20% CU:14%
    'R_4': { name: 'Earthworm',      emoji: '\u{1FAB1}' },       // SI:44% SL:25% 50%GB
    'R_5': { name: 'Side-Sweeper',   emoji: '\u{1F9F9}' },       // ST:31% FF:29% SI:18%
    'R_6': { name: 'Firestarter',    emoji: '\u{1F525}' },       // FF:49% SL:35% 94.9mph
    'R_7': { name: 'Big Hooker',     emoji: '\u{1FA9D}' },       // FF:39% KC:27%
    'R_8': { name: 'Snakey',         emoji: '\u{1F40D}' },       // SI:38% FC:22% SL:18% â€” no 4-seam
    'R_9': { name: 'Splitter Demon', emoji: '\u{1F479}' },       // FF:39% FS:28%
    // LHP
    'L_0': { name: 'Undertow',       emoji: '\u{1F30A}' },       // SI:55% â€” pure sinker
    'L_1': { name: 'Craftsman',      emoji: '\u{1FAB5}' },       // FF:32% FC:26% CH:17% â€” cutter finesse
    'L_2': { name: 'Firestarter',    emoji: '\u{1F525}' },       // FF:48% SL:32% â€” gas+slider
    'L_3': { name: 'Big Hooker',     emoji: '\u{1FA9D}' },       // FF:34% KC:25% 89mph
    'L_4': { name: 'Earthworm',      emoji: '\u{1FAB1}' },       // SI:46% SL:19% 54%GB
    'L_5': { name: 'Uncle Charlie',  emoji: '\u{1F3B2}' },       // FF:43% CU:19% CH:13%
    'L_6': { name: 'Splitter Demon', emoji: '\u{1F479}' },       // FF:43% FS:29%
    'L_7': { name: 'Boomerang',      emoji: '\u{1FA83}' },       // SV:25% FF:43%
    'L_8': { name: 'Side-Sweeper',   emoji: '\u{1F9F9}' },       // ST:32% FF:31%
};
function archName(id)  { const a = ARCHETYPE_MAP[id]; return a ? a.emoji + ' ' + a.name : id; }
function archEmoji(id) { return ARCHETYPE_MAP[id]?.emoji || ''; }
function archNameOnly(id) { return ARCHETYPE_MAP[id]?.name || id; }

const ARCHETYPE_SPREAD_ORDER = {
    rhp: ['R_4','R_8','R_1','R_5','R_0','R_3','R_2','R_9','R_7','R_6'],
    lhp: ['L_2','L_3','L_6','L_5','L_1','L_7','L_8','L_4','L_0']
};

const ARCHETYPE_ABBREV = {
    'R_0':'C&C','R_1':'BOOM','R_2':'GHST','R_3':'TRIP','R_4':'WORM',
    'R_5':'SIDE','R_6':'FIRE','R_7':'HOOK','R_8':'SNKY','R_9':'SPLT',
    'L_0':'UNDR','L_1':'CRFT','L_2':'FIRE','L_3':'HOOK','L_4':'WORM',
    'L_5':'UNCL','L_6':'SPLT','L_7':'BOOM','L_8':'SIDE'
};

const ARCHETYPE_DESC = {
    'Firestarter':    'Fastball-slider gas combo, high velo power arm',
    'Earthworm':      'Heavy sinker, elite ground ball rate',
    'Splitter Demon': 'Splitter/forkball tunneled off the fastball',
    'Boomerang':      'Sweeping pitch that wraps back across the zone',
    'Side-Sweeper':   'Sweeper-dominant with extreme horizontal break',
    'Big Hooker':     'Knuckle-curve as the primary breaking weapon',
    'Cut & Curved':   'Cutter-curveball combination pitch mix',
    'Ghost Baller':   'Changeup-dominant, the pitch vanishes on hitters',
    'Triple Threat':  'Balanced fastball + slider + curveball arsenal',
    'Snakey':         'Sinker-cutter with no four-seam fastball',
    'Undertow':       'Pure sinker LHP, heavy sink and ground balls',
    'Craftsman':      'Cutter-based LHP finesse, command over velocity',
    'Uncle Charlie':  'Curveball-led balanced lefty, old-school arsenal',
};

const STATE = {
    activeBatters: [],
    selectedStat: 'wOBA',
    selectedYear: 'all',
    minPA: 10,
    visibleClusters: new Set(),
    highlightedCluster: null,
    savedSearches: JSON.parse(localStorage.getItem('pfx_saved') || '[]'),
    sheetState: 'hidden', // hidden, peek, full
    teamFilter: null,
    pitcherFilters: { veloMin: null, veloMax: null, hBreakMin: null, hBreakMax: null, roleFilter: null },
};

let _teamPitcherIds = null;
let _teamClusterIds = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING (identical to desktop)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadJSON(url, label, setStatus) {
    setStatus('Loading ' + label + '...');
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Failed: ' + label);
    const text = await resp.text();
    setStatus('Parsing ' + label + ' (' + (text.length / 1e6).toFixed(1) + 'MB)...');
    return JSON.parse(text);
}

async function loadAllData() {
    const setStatus = (msg) => { const el = document.getElementById('loader-status'); if (el) el.textContent = msg; };
    DATA.clusters = await loadJSON('clusters.json', 'cluster profiles', setStatus);
    DATA.batters = await loadJSON('batters.json', 'batter index', setStatus);
    DATA.pitcherSeasons = await loadJSON('pitcher_seasons.json', 'pitcher seasons', setStatus);
    DATA.hitterVsCluster = await loadJSON('hitter_vs_cluster.json', 'hitter matchups', setStatus);
    try { DATA.hitterVsPitcher = await loadJSON('hitter_vs_pitcher.json', 'pitcher matchups', setStatus); }
    catch(e) { DATA.hitterVsPitcher = []; }
    try { DATA.archetypeKings = await loadJSON('archetype_kings.json', 'archetype kings', setStatus); }
    catch(e) { DATA.archetypeKings = {}; }
    try { DATA.teamRosters = await loadJSON('teams_2026.json', 'team rosters', setStatus); }
    catch(e) { DATA.teamRosters = { teams: {}, rosters: {} }; }

    // Fix centroids with missing velo
    Object.entries(DATA.clusters).forEach(([cid, cluster]) => {
        const cent = cluster.centroid || {};
        if (!cent.avg_velo_FF || cent.avg_velo_FF === 0) {
            const members = DATA.pitcherSeasons.filter(p => p.cluster === cid && p.avg_velo_FF > 0);
            if (members.length > 0) cent.avg_velo_FF = members.reduce((s, p) => s + p.avg_velo_FF, 0) / members.length;
        }
        if (cent.pfx_x_avg == null) {
            const members = DATA.pitcherSeasons.filter(p => p.cluster === cid && p.pfx_x_avg != null);
            if (members.length > 0) cent.pfx_x_avg = members.reduce((s, p) => s + p.pfx_x_avg, 0) / members.length;
        }
    });

    // Build batter->pitcher matchup index
    DATA._hvpIndex = {};
    DATA.hitterVsPitcher.forEach(r => {
        if (!DATA._hvpIndex[r.b]) DATA._hvpIndex[r.b] = {};
        if (!DATA._hvpIndex[r.b][r.c]) DATA._hvpIndex[r.b][r.c] = [];
        DATA._hvpIndex[r.b][r.c].push(r);
    });

    STATE.visibleClusters = new Set(Object.keys(DATA.clusters));

    const years = [...new Set(DATA.hitterVsCluster.map(r => r.game_year))].sort();
    const sel = document.getElementById('year-select');
    years.forEach(y => { const o = document.createElement('option'); o.value = y; o.textContent = y; sel.appendChild(o); });

    // Populate team dropdown
    const teamSel = document.getElementById('team-select');
    const DIV_ORDER = [
        { label: 'AL East', teams: ['BAL','BOS','NYY','TB','TOR'] },
        { label: 'AL Central', teams: ['CLE','CWS','DET','KC','MIN'] },
        { label: 'AL West', teams: ['HOU','LAA','OAK','SEA','TEX'] },
        { label: 'NL East', teams: ['ATL','MIA','NYM','PHI','WSH'] },
        { label: 'NL Central', teams: ['CHC','CIN','MIL','PIT','STL'] },
        { label: 'NL West', teams: ['ARI','COL','LAD','SD','SF'] },
    ];
    DIV_ORDER.forEach(div => {
        const grp = document.createElement('optgroup');
        grp.label = div.label;
        div.teams.forEach(abbr => {
            const t = DATA.teamRosters.teams?.[abbr];
            if (!t) return;
            const o = document.createElement('option');
            o.value = abbr;
            o.textContent = abbr;
            grp.appendChild(o);
        });
        teamSel.appendChild(grp);
    });
    // WBC teams
    if (DATA.teamRosters.teams) {
        const wbc = Object.keys(DATA.teamRosters.teams).filter(k => !DIV_ORDER.some(d => d.teams.includes(k)));
        if (wbc.length > 0) {
            const grp = document.createElement('optgroup');
            grp.label = 'WBC';
            wbc.forEach(abbr => {
                const o = document.createElement('option');
                o.value = abbr;
                o.textContent = abbr + ' â€” ' + DATA.teamRosters.teams[abbr].name;
                grp.appendChild(o);
            });
            teamSel.appendChild(grp);
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('plot');
const ctx = canvas.getContext('2d');
const canvasWrap = document.getElementById('canvas-wrap');

// PCA axes â€” the true archetype space
const PCA_X_MIN = -14, PCA_X_MAX = 12;
const PCA_Y_MIN = -8,  PCA_Y_MAX = 8;
const MARGIN = { top: 30, right: 16, bottom: 30, left: 36 };

let viewOffset = { x: 0, y: 0 };
let viewZoom = 1.0;

function cssW() { return canvas.getBoundingClientRect().width; }
function cssH() { return canvas.getBoundingClientRect().height; }

function plotArea() {
    return { x: MARGIN.left, y: MARGIN.top, w: cssW() - MARGIN.left - MARGIN.right, h: cssH() - MARGIN.top - MARGIN.bottom };
}

function d2c(pcaX, pcaY) {
    const p = plotArea();
    const nx = (pcaX - PCA_X_MIN) / (PCA_X_MAX - PCA_X_MIN);
    const ny = 1 - (pcaY - PCA_Y_MIN) / (PCA_Y_MAX - PCA_Y_MIN);
    const cx = p.x + nx * p.w, cy = p.y + ny * p.h;
    const cw = cssW(), ch = cssH();
    return { x: (cx - cw/2) * viewZoom + cw/2 + viewOffset.x, y: (cy - ch/2) * viewZoom + ch/2 + viewOffset.y };
}

function c2d(sx, sy) {
    const cw = cssW(), ch = cssH();
    const ux = (sx - viewOffset.x - cw/2) / viewZoom + cw/2;
    const uy = (sy - viewOffset.y - ch/2) / viewZoom + ch/2;
    const p = plotArea();
    const nx = (ux - p.x) / p.w, ny = (uy - p.y) / p.h;
    return { pcaX: PCA_X_MIN + nx * (PCA_X_MAX - PCA_X_MIN), pcaY: PCA_Y_MAX - ny * (PCA_Y_MAX - PCA_Y_MIN) };
}

function resizeCanvas() {
    const dpr = Math.min(window.devicePixelRatio, 2);
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDERING (same logic as desktop)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render() {
    const w = cssW(), h = cssH();
    ctx.clearRect(0, 0, w, h);
    drawGrid(w, h);
    drawDots();
    drawCentroids();
    drawBatterLines();
}

function drawGrid(w, h) {
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, w, h);
    ctx.strokeStyle = '#151515'; ctx.lineWidth = 0.5;
    for (let x = -14; x <= 12; x += 2) {
        const a = d2c(x, PCA_Y_MIN), b = d2c(x, PCA_Y_MAX);
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
    }
    for (let y = -8; y <= 8; y += 2) {
        const a = d2c(PCA_X_MIN, y), b = d2c(PCA_X_MAX, y);
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
    }
    // Center divider at x=0 (RHP/LHP boundary)
    const c0a = d2c(0, PCA_Y_MIN), c0b = d2c(0, PCA_Y_MAX);
    ctx.strokeStyle = '#2a2a2a'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(c0a.x, c0a.y); ctx.lineTo(c0b.x, c0b.y); ctx.stroke();
    // Horizontal center at y=0
    const h0a = d2c(PCA_X_MIN, 0), h0b = d2c(PCA_X_MAX, 0);
    ctx.strokeStyle = '#1a1a1a'; ctx.lineWidth = 0.8;
    ctx.beginPath(); ctx.moveTo(h0a.x, h0a.y); ctx.lineTo(h0b.x, h0b.y); ctx.stroke();

    // X-axis tick marks
    ctx.font = '7px "Courier New", monospace'; ctx.fillStyle = '#2a2a2a'; ctx.textAlign = 'center';
    for (let x = -12; x <= 10; x += 4) {
        const p = d2c(x, PCA_Y_MIN);
        ctx.fillText(x, p.x, p.y + 12);
    }
    // Y-axis tick marks
    ctx.textAlign = 'right';
    for (let y = -6; y <= 6; y += 2) {
        if (y === 0) continue;
        const p = d2c(PCA_X_MIN, y);
        ctx.fillText(y, p.x - 3, p.y + 3);
    }

    // Chart title
    ctx.fillStyle = '#444'; ctx.font = 'bold 9px -apple-system, sans-serif'; ctx.textAlign = 'center';
    const mb = d2c((PCA_X_MIN + PCA_X_MAX) / 2, PCA_Y_MIN);
    ctx.fillText('PREDICTIVE PITCHER ATLAS', mb.x, mb.y + 22);

    // Zone labels
    ctx.font = 'bold 9px -apple-system, sans-serif'; ctx.fillStyle = '#2a2a2a';
    ctx.textAlign = 'left';
    const tl = d2c(PCA_X_MIN, PCA_Y_MAX); ctx.fillText('LHP', tl.x + 4, tl.y + 12);
    ctx.textAlign = 'right';
    const tr = d2c(PCA_X_MAX, PCA_Y_MAX); ctx.fillText('RHP', tr.x - 4, tr.y + 12);

    // Year watermark
    if (STATE.selectedYear !== 'all') {
        ctx.font = 'bold 40px -apple-system, sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.04)';
        ctx.textAlign = 'center';
        const center = d2c((PCA_X_MIN + PCA_X_MAX) / 2, (PCA_Y_MIN + PCA_Y_MAX) / 2);
        ctx.fillText(STATE.selectedYear, center.x, center.y + 14);
    }
}

function hexRgb(hex) {
    hex = hex.replace('#', '');
    return { r: parseInt(hex.substring(0,2),16), g: parseInt(hex.substring(2,4),16), b: parseInt(hex.substring(4,6),16) };
}

function passesPitcherFilters(ps) {
    const f = STATE.pitcherFilters;
    if (f.veloMin != null && (ps.avg_velo_FF || 0) < f.veloMin) return false;
    if (f.veloMax != null && (ps.avg_velo_FF || 0) > f.veloMax) return false;
    if (f.hBreakMin != null && ((ps.pfx_x_avg || 0) * 12) < f.hBreakMin) return false;
    if (f.hBreakMax != null && ((ps.pfx_x_avg || 0) * 12) > f.hBreakMax) return false;
    if (f.roleFilter === 'SP' && !ps.is_sp) return false;
    if (f.roleFilter === 'RP' && ps.is_sp) return false;
    return true;
}

function drawDots() {
    const hl = STATE.highlightedCluster;
    const yearFilter = STATE.selectedYear !== 'all' ? parseInt(STATE.selectedYear) : null;
    for (let i = 0; i < DATA.pitcherSeasons.length; i++) {
        const ps = DATA.pitcherSeasons[i];
        const cluster = DATA.clusters[ps.cluster];
        if (!cluster || !STATE.visibleClusters.has(ps.cluster)) continue;
        if (_teamPitcherIds && !_teamPitcherIds.has(ps.pitcher)) continue;
        const _velo = ps.avg_velo_FF || 0;
        if (_velo > 0 && _velo < 80) continue;
        if (yearFilter && ps.game_year !== yearFilter) continue;
        if (!passesPitcherFilters(ps)) continue;
        const px = ps.pca_x, py = ps.pca_y;
        if (px == null || py == null) continue;
        const pos = d2c(px, py);
        const rgb = hexRgb(cluster.color);
        let alpha = 0.45, radius = 2.5;
        if (hl) {
            if (ps.cluster === hl) { alpha = 0.9; radius = 3.5; }
            else { alpha = 0.05; radius = 1.5; }
        }
        ctx.beginPath(); ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + alpha + ')';
        ctx.fill();
    }
}

function computeYearCentroids(year) {
    const sums = {};
    const yearInt = parseInt(year);
    DATA.pitcherSeasons.forEach(ps => {
        if (ps.game_year !== yearInt) return;
        if (!STATE.visibleClusters.has(ps.cluster)) return;
        if (_teamPitcherIds && !_teamPitcherIds.has(ps.pitcher)) return;
        if (!passesPitcherFilters(ps)) return;
        if (ps.pca_x == null || ps.pca_y == null) return;
        if (!sums[ps.cluster]) sums[ps.cluster] = { sx: 0, sy: 0, n: 0 };
        sums[ps.cluster].sx += ps.pca_x;
        sums[ps.cluster].sy += ps.pca_y;
        sums[ps.cluster].n++;
    });
    const result = {};
    Object.entries(sums).forEach(([cid, s]) => {
        if (s.n >= 1) result[cid] = { x: s.sx / s.n, y: s.sy / s.n, n: s.n };
    });
    return result;
}

function drawCentroids() {
    const yearFilter = STATE.selectedYear !== 'all' ? STATE.selectedYear : null;
    const yearCentroids = yearFilter ? computeYearCentroids(yearFilter) : null;

    Object.entries(DATA.clusters).forEach(([id, cluster]) => {
        if (!STATE.visibleClusters.has(id)) return;

        let px, py, yearCount = null;
        if (yearCentroids) {
            const yc = yearCentroids[id];
            if (!yc) return;
            px = yc.x; py = yc.y; yearCount = yc.n;
        } else {
            px = cluster.pca_x; py = cluster.pca_y;
            if (px == null || py == null) return;
        }

        const pos = d2c(px, py);
        const hl = STATE.highlightedCluster;
        const isHl = hl === id;
        const dim = hl && !isHl;
        const rgb = hexRgb(cluster.color);
        const alpha = dim ? 0.10 : 1;
        const outerR = isHl ? 22 : 16;
        const innerR = isHl ? 5 : 4;

        if (!dim) {
            ctx.beginPath(); ctx.arc(pos.x, pos.y, outerR + 5, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',0.06)'; ctx.fill();
        }
        ctx.beginPath(); ctx.arc(pos.x, pos.y, outerR, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + alpha + ')';
        ctx.lineWidth = isHl ? 3 : 2; ctx.stroke();
        ctx.beginPath(); ctx.arc(pos.x, pos.y, innerR, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + alpha + ')'; ctx.fill();

        if (!dim) {
            const label = archNameOnly(id);
            ctx.font = 'bold 10px -apple-system, sans-serif';
            const nameW = ctx.measureText(label).width;
            const pillW = nameW + 8;
            ctx.fillStyle = 'rgba(10,10,10,0.75)';
            const pillX = pos.x - pillW/2, pillY = pos.y + outerR + 2, pillH = 16;
            ctx.fillRect(pillX, pillY, pillW, pillH);
            ctx.fillStyle = 'rgba(' + rgb.r + ',' + rgb.g + ',' + rgb.b + ',' + (alpha * 0.95) + ')';
            ctx.textAlign = 'center';
            ctx.fillText(label, pos.x, pos.y + outerR + 14);

            if (STATE.activeBatters.length > 0) {
                const batter = STATE.activeBatters[STATE.activeBatters.length - 1];
                const matchups = getMatchupData(batter);
                const m = matchups.find(x => String(x.cluster) === id);
                if (m && (m.PA || 0) >= STATE.minPA) {
                    const val = m[STATE.selectedStat] || 0;
                    const display = (STATE.selectedStat === 'K_pct' || STATE.selectedStat === 'BB_pct')
                        ? (val * 100).toFixed(0) + '%' : val.toFixed(3);
                    ctx.font = 'bold 11px "Courier New", monospace';
                    ctx.fillStyle = perfHex(STATE.selectedStat, val);
                    ctx.textAlign = 'center';
                    ctx.fillText(display, pos.x, pos.y - outerR - 4);
                }
            }
        }
    });
}

function wobaColor(w) {
    if (w >= 0.370) return '#2a9d8f';
    if (w >= 0.330) return '#a8dadc';
    if (w >= 0.290) return '#f4a261';
    if (w >= 0.250) return '#e76f51';
    return '#e63946';
}

// Dynamic stat helpers
function statLabel(stat) {
    return { wOBA:'wOBA', BA:'BA', SLG:'SLG', OBP:'OBP', K_pct:'K%', BB_pct:'BB%' }[stat] || stat;
}
function statBarMax(stat) {
    return { wOBA:0.450, BA:0.400, SLG:0.700, OBP:0.450, K_pct:0.40, BB_pct:0.20 }[stat] || 0.450;
}
function statBarColor(stat, val) {
    if (stat === 'K_pct') return val < 0.15 ? '#2a9d8f' : val < 0.20 ? '#a8dadc' : val > 0.30 ? '#e63946' : val > 0.25 ? '#e76f51' : '#f4a261';
    if (stat === 'BB_pct') return val > 0.12 ? '#2a9d8f' : val > 0.10 ? '#a8dadc' : val < 0.05 ? '#e63946' : val < 0.07 ? '#e76f51' : '#f4a261';
    if (stat === 'BA') return val >= 0.300 ? '#2a9d8f' : val >= 0.270 ? '#a8dadc' : val >= 0.240 ? '#f4a261' : val >= 0.210 ? '#e76f51' : '#e63946';
    if (stat === 'SLG') return val >= 0.500 ? '#2a9d8f' : val >= 0.430 ? '#a8dadc' : val >= 0.370 ? '#f4a261' : val >= 0.300 ? '#e76f51' : '#e63946';
    if (stat === 'OBP') return val >= 0.370 ? '#2a9d8f' : val >= 0.330 ? '#a8dadc' : val >= 0.300 ? '#f4a261' : val >= 0.270 ? '#e76f51' : '#e63946';
    return val >= 0.370 ? '#2a9d8f' : val >= 0.330 ? '#a8dadc' : val >= 0.290 ? '#f4a261' : val >= 0.250 ? '#e76f51' : '#e63946';
}
function getStatFromRow(r, stat) {
    const pa=r.PA||0, ab=r.AB||0, h=r.H||0, hr=r.HR||0, bb=r.BB||0, k=r.K||0, hbp=r.HBP||0;
    const s=r.singles||0, d=r.doubles||0, t=r.triples||0;
    if (stat==='wOBA') return r.wOBA||0;
    if (stat==='BA') return ab>0?h/ab:0;
    if (stat==='OBP') return pa>0?(h+bb+hbp)/pa:0;
    if (stat==='SLG') return ab>0?(s+2*d+3*t+4*hr)/ab:0;
    if (stat==='K_pct') return pa>0?k/pa:0;
    if (stat==='BB_pct') return pa>0?bb/pa:0;
    return r[stat]||0;
}
function fmtStatVal(stat, val) {
    return (stat==='K_pct'||stat==='BB_pct') ? (val*100).toFixed(1)+'%' : val.toFixed(3);
}

function drawBatterLines() {
    if (STATE.activeBatters.length === 0) return;
    const batter = STATE.activeBatters[STATE.activeBatters.length - 1];
    const matchups = getMatchupData(batter);
    const badge = document.getElementById('batter-badge');
    const bRect = badge.getBoundingClientRect();
    const cRect = canvasWrap.getBoundingClientRect();
    const bx = bRect.left + bRect.width / 2 - cRect.left;
    const by = bRect.bottom - cRect.top + 2;

    const yearFilter = STATE.selectedYear !== 'all' ? STATE.selectedYear : null;
    const yearCentroids = yearFilter ? computeYearCentroids(yearFilter) : null;

    Object.entries(DATA.clusters).forEach(([cid, cluster]) => {
        if (!STATE.visibleClusters.has(cid)) return;

        let cpx, cpy;
        if (yearCentroids) {
            const yc = yearCentroids[cid];
            if (!yc) return;
            cpx = yc.x; cpy = yc.y;
        } else {
            cpx = cluster.pca_x; cpy = cluster.pca_y;
            if (cpx == null || cpy == null) return;
        }

        const hl = STATE.highlightedCluster;
        if (hl && cid !== hl) return;
        const pos = d2c(cpx, cpy);
        const m = matchups.find(x => String(x.cluster) === cid);
        const pa = m ? m.PA || 0 : 0;
        const statVal = m ? (m[STATE.selectedStat] || 0) : 0;

        if (pa < STATE.minPA) {
            ctx.beginPath(); ctx.setLineDash([4,6]);
            ctx.moveTo(bx, by); ctx.lineTo(pos.x, pos.y);
            ctx.strokeStyle = 'rgba(60,60,60,0.3)'; ctx.lineWidth = 0.5;
            ctx.stroke(); ctx.setLineDash([]);
            return;
        }
        const color = perfHex(STATE.selectedStat, statVal);
        const thickness = Math.max(1.5, Math.min(5, pa / 80));
        ctx.beginPath(); ctx.moveTo(bx, by); ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = color; ctx.lineWidth = thickness + 5;
        ctx.globalAlpha = 0.12; ctx.stroke(); ctx.globalAlpha = 1;
        ctx.beginPath(); ctx.moveTo(bx, by); ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = color; ctx.lineWidth = thickness;
        ctx.globalAlpha = 0.9; ctx.stroke(); ctx.globalAlpha = 1;
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BATTER SYSTEM (same logic as desktop)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function deriveStats(r) {
    const pa=r.PA||0, ab=r.AB||0, h=r.H||0, hr=r.HR||0, bb=r.BB||0, k=r.K||0, hbp=r.HBP||0;
    const s=r.singles||0, d=r.doubles||0, t=r.triples||0;
    r.BA = ab>0 ? h/ab : 0; r.OBP = pa>0 ? (h+bb+hbp)/pa : 0;
    r.SLG = ab>0 ? (s+2*d+3*t+4*hr)/ab : 0; r.K_pct = pa>0 ? k/pa : 0; r.BB_pct = pa>0 ? bb/pa : 0;
    return r;
}

function updateTeamFilter(abbr) {
    STATE.teamFilter = abbr;
    if (abbr && DATA.teamRosters.rosters && DATA.teamRosters.rosters[abbr]) {
        _teamPitcherIds = new Set(DATA.teamRosters.rosters[abbr]);
        _teamClusterIds = new Set();
        DATA.pitcherSeasons.forEach(ps => {
            if (_teamPitcherIds.has(ps.pitcher)) _teamClusterIds.add(ps.cluster);
        });
    } else {
        _teamPitcherIds = null;
        _teamClusterIds = null;
    }
    render(); refreshData(); buildArchetypeCards(); buildArchetypeSpread();
}

function getMatchupData(batter) {
    // When team filter active, aggregate from individual pitcher matchups
    if (_teamPitcherIds && DATA._hvpIndex && DATA._hvpIndex[batter.batter]) {
        const hvp = DATA._hvpIndex[batter.batter];
        const grouped = {};
        Object.entries(hvp).forEach(([cid, arr]) => {
            arr.forEach(m => {
                if (!_teamPitcherIds.has(m.p)) return;
                if (!grouped[cid]) grouped[cid] = { cluster: cid, PA: 0, H: 0, HR: 0, K: 0, BB: 0, woba_sum: 0 };
                const g = grouped[cid];
                const pa = m.pa || 0;
                g.PA += pa; g.H += m.h || 0; g.HR += m.hr || 0;
                g.K += m.k || 0; g.BB += m.bb || 0;
                g.woba_sum += (m.w || 0) * pa;
            });
        });
        return Object.values(grouped).map(g => {
            g.AB = g.PA - g.BB; g.HBP = 0;
            g.singles = g.H - g.HR; g.doubles = 0; g.triples = 0;
            g.wOBA = g.PA > 0 ? g.woba_sum / g.PA : 0;
            return deriveStats(g);
        });
    }

    // Default: cluster-level data (no team filter)
    let rows = DATA.hitterVsCluster.filter(r => r.batter === batter.batter);
    if (STATE.selectedYear !== 'all') rows = rows.filter(r => r.game_year === parseInt(STATE.selectedYear));
    if (STATE.selectedYear === 'all' && rows.length > 0) {
        const grouped = {};
        rows.forEach(r => {
            const k = r.cluster;
            if (!grouped[k]) grouped[k] = { cluster:k, PA:0, AB:0, H:0, HR:0, BB:0, K:0, HBP:0, singles:0, doubles:0, triples:0, woba_sum:0 };
            const g = grouped[k];
            g.PA+=r.PA||0; g.AB+=r.AB||0; g.H+=r.H||0; g.HR+=r.HR||0; g.BB+=r.BB||0; g.K+=r.K||0;
            g.HBP+=r.HBP||0; g.singles+=r.singles||0; g.doubles+=r.doubles||0; g.triples+=r.triples||0;
            g.woba_sum+=(r.wOBA||0)*(r.PA||0);
        });
        return Object.values(grouped).map(g => { g.wOBA = g.PA>0 ? g.woba_sum/g.PA : 0; return deriveStats(g); });
    }
    return rows.map(r => deriveStats({...r}));
}

function spawnBatter(batter) {
    const matchups = getMatchupData(batter);
    const totalPA = matchups.reduce((s,r)=>s+(r.PA||0),0);
    const stat = STATE.selectedStat;
    const totalStatWeighted = matchups.reduce((s,r)=>s+(r[stat]||0)*(r.PA||0),0);
    const avgStat = totalPA > 0 ? totalStatWeighted/totalPA : 0;
    document.getElementById('badge-name').textContent = fmtName(batter.batter_name);
    document.getElementById('badge-stat').textContent = fmtStatVal(stat, avgStat) + ' ' + statLabel(stat) + ' \u00b7 ' + totalPA.toLocaleString() + ' PA';
    document.getElementById('batter-badge').classList.add('visible');
    saveSearch(batter);
    buildArchetypeCards(); buildArchetypeSpread();
    render();
}

function clearBatter() {
    document.getElementById('batter-badge').classList.remove('visible');
    render();
}

function refreshData() {
    if (STATE.activeBatters.length === 0) return;
    // Update badge to reflect current stat
    const b = STATE.activeBatters[STATE.activeBatters.length-1];
    const matchups = getMatchupData(b);
    const totalPA = matchups.reduce((s,r)=>s+(r.PA||0),0);
    const stat = STATE.selectedStat;
    const totalStatWeighted = matchups.reduce((s,r)=>s+(r[stat]||0)*(r.PA||0),0);
    const avgStat = totalPA > 0 ? totalStatWeighted/totalPA : 0;
    document.getElementById('badge-stat').textContent = fmtStatVal(stat, avgStat) + ' ' + statLabel(stat) + ' \u00b7 ' + totalPA.toLocaleString() + ' PA';
    render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERFORMANCE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function perfClass(stat, val) {
    if (stat === 'K_pct') return val < 0.15 ? 'perf-great' : val < 0.20 ? 'perf-good' : val > 0.30 ? 'perf-bad' : val > 0.25 ? 'perf-poor' : 'perf-avg';
    if (stat === 'BB_pct') return val > 0.12 ? 'perf-great' : val > 0.10 ? 'perf-good' : val < 0.05 ? 'perf-bad' : val < 0.07 ? 'perf-poor' : 'perf-avg';
    if (stat === 'BA') return val >= 0.300 ? 'perf-great' : val >= 0.270 ? 'perf-good' : val >= 0.240 ? 'perf-avg' : val >= 0.210 ? 'perf-poor' : 'perf-bad';
    if (stat === 'SLG') return val >= 0.500 ? 'perf-great' : val >= 0.430 ? 'perf-good' : val >= 0.370 ? 'perf-avg' : val >= 0.300 ? 'perf-poor' : 'perf-bad';
    if (stat === 'OBP') return val >= 0.370 ? 'perf-great' : val >= 0.330 ? 'perf-good' : val >= 0.300 ? 'perf-avg' : val >= 0.270 ? 'perf-poor' : 'perf-bad';
    return val >= 0.370 ? 'perf-great' : val >= 0.330 ? 'perf-good' : val >= 0.290 ? 'perf-avg' : val >= 0.250 ? 'perf-poor' : 'perf-bad';
}

function perfHex(stat, val) {
    if (stat === 'K_pct') return val < 0.15 ? '#2a9d8f' : val < 0.20 ? '#6bbe8a' : val > 0.30 ? '#e63946' : val > 0.25 ? '#e76f51' : '#f4a261';
    if (stat === 'BB_pct') return val > 0.12 ? '#2a9d8f' : val > 0.10 ? '#6bbe8a' : val < 0.05 ? '#e63946' : val < 0.07 ? '#e76f51' : '#f4a261';
    if (stat === 'BA') return val >= 0.300 ? '#2a9d8f' : val >= 0.270 ? '#6bbe8a' : val >= 0.240 ? '#f4a261' : val >= 0.210 ? '#e76f51' : '#e63946';
    if (stat === 'SLG') return val >= 0.500 ? '#2a9d8f' : val >= 0.430 ? '#6bbe8a' : val >= 0.370 ? '#f4a261' : val >= 0.300 ? '#e76f51' : '#e63946';
    if (stat === 'OBP') return val >= 0.370 ? '#2a9d8f' : val >= 0.330 ? '#6bbe8a' : val >= 0.300 ? '#f4a261' : val >= 0.270 ? '#e76f51' : '#e63946';
    return val >= 0.370 ? '#2a9d8f' : val >= 0.330 ? '#6bbe8a' : val >= 0.290 ? '#f4a261' : val >= 0.250 ? '#e76f51' : '#e63946';
}

function fmtName(name) {
    if (!name) return 'Unknown';
    return name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

function statCell(label, val) {
    return '<div class="stat-cell"><div class="s-label">'+label+'</div><div class="s-val">'+val+'</div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOTTOM SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sheet = document.getElementById('bottom-sheet');
const sheetContent = document.getElementById('sheet-content');
const backdrop = document.getElementById('sheet-backdrop');
let sheetTouchStartY = 0, sheetStartTranslate = 0;

function openSheet(state) {
    STATE.sheetState = state;
    sheet.className = 'bottom-sheet ' + state;
    backdrop.classList.toggle('visible', state === 'full');
}

function closeSheet() {
    STATE.sheetState = 'hidden';
    sheet.className = 'bottom-sheet';
    backdrop.classList.remove('visible');
}

backdrop.addEventListener('click', () => { STATE.highlightedCluster = null; closeSheet(); render(); buildArchetypeCards(); buildArchetypeSpread(); });
document.getElementById('sheet-close').addEventListener('click', () => { STATE.highlightedCluster = null; closeSheet(); render(); buildArchetypeCards(); buildArchetypeSpread(); });

// Sheet drag
const sheetHandle = document.getElementById('sheet-handle');
sheetHandle.addEventListener('touchstart', (e) => {
    sheetTouchStartY = e.touches[0].clientY;
}, { passive: true });
sheetHandle.addEventListener('touchmove', (e) => {
    const dy = e.touches[0].clientY - sheetTouchStartY;
    if (STATE.sheetState === 'full' && dy > 40) { openSheet('peek'); sheetTouchStartY = e.touches[0].clientY; }
    else if (STATE.sheetState === 'peek' && dy > 40) { closeSheet(); }
    else if (STATE.sheetState === 'peek' && dy < -40) { openSheet('full'); sheetTouchStartY = e.touches[0].clientY; }
}, { passive: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAT PANEL (in bottom sheet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showStatPanel(batterObj, clusterId) {
    const cluster = DATA.clusters[clusterId];
    if (!cluster) return;
    const cent = cluster.centroid || {};
    const role = cent.is_sp > 0.5 ? 'SP' : 'RP';
    let html = '';

    if (batterObj) {
        const yearRows = DATA.hitterVsCluster.filter(r => r.batter === batterObj.batter && String(r.cluster) === clusterId).sort((a,b)=>a.game_year-b.game_year);
        const tot = { PA:0,AB:0,H:0,HR:0,BB:0,K:0,HBP:0,singles:0,doubles:0,triples:0 };
        yearRows.forEach(r => { tot.PA+=r.PA||0; tot.AB+=r.AB||0; tot.H+=r.H||0; tot.HR+=r.HR||0; tot.BB+=r.BB||0; tot.K+=r.K||0; tot.HBP+=r.HBP||0; tot.singles+=r.singles||0; tot.doubles+=r.doubles||0; tot.triples+=r.triples||0; });
        const ba = tot.AB>0?(tot.H/tot.AB).toFixed(3):'.000';
        const obp = tot.PA>0?((tot.H+tot.BB+tot.HBP)/tot.PA).toFixed(3):'.000';
        const slg = tot.AB>0?((tot.singles+2*tot.doubles+3*tot.triples+4*tot.HR)/tot.AB).toFixed(3):'.000';
        const kp = tot.PA>0?((tot.K/tot.PA)*100).toFixed(1)+'%':'0%';
        const bbp = tot.PA>0?((tot.BB/tot.PA)*100).toFixed(1)+'%':'0%';

        html += '<div class="stat-header">'+fmtName(batterObj.batter_name)+'</div>';
        html += '<div class="stat-sub" style="color:'+cluster.color+'">vs '+archName(clusterId)+' ('+cluster.hand+' '+role+')</div>';
        html += '<div class="stat-grid">';
        html += statCell('PA',tot.PA)+statCell('BA',ba)+statCell('OBP',obp);
        html += statCell('SLG',slg)+statCell('HR',tot.HR)+statCell('K%',kp);
        html += statCell('BB%',bbp)+statCell('H',tot.H)+statCell('2B',tot.doubles);
        html += '</div>';

        if (yearRows.length > 1) {
            const ss = STATE.selectedStat;
            html += '<div class="section-hdr">Year-by-Year '+statLabel(ss)+'</div>';
            yearRows.forEach(r => {
                const v = getStatFromRow(r, ss);
                const bw = Math.min(100,Math.max(5,(v/statBarMax(ss))*100));
                html += '<div class="matchup-bar"><span class="yr">'+r.game_year+'</span><div class="bar-track"><div class="bar-fill" style="width:'+bw+'%;background:'+statBarColor(ss,v)+';"></div></div><span class="woba-val">'+fmtStatVal(ss,v)+'</span><span class="pa-val">'+r.PA+' PA</span></div>';
            });
        }

        // TAGS placeholder
        html += '<div style="font-size:10px;color:#555;font-style:italic;font-family:var(--font-tech);padding:6px 0;margin-top:8px;border-top:1px solid #1a1a1a;">\u{1F3F7}\uFE0F TAGGED: Coming Soon</div>';

        // Pitcher roster
        let pitcherMatchups = (DATA._hvpIndex[batterObj.batter] || {})[clusterId] || [];
        if (_teamPitcherIds) pitcherMatchups = pitcherMatchups.filter(m => _teamPitcherIds.has(m.p));
        if (pitcherMatchups.length > 0) {
            html += '<div style="display:flex;align-items:center;justify-content:space-between;margin:14px 0 6px;padding-bottom:4px;border-bottom:1px solid #222;">';
            html += '<span class="section-hdr" style="margin:0;border:0;padding:0;">Pitchers ('+pitcherMatchups.length+')</span>';
            html += '<div class="roster-sort">';
            html += '<span class="sort-btn active" data-sort="pa">PA</span>';
            html += '<span class="sort-btn" data-sort="ba">BA</span>';
            html += '<span class="sort-btn" data-sort="hr">HR</span>';
            html += '<span class="sort-btn" data-sort="k">K</span>';
            html += '</div></div>';
            html += '<div class="roster-head"><span>PITCHER</span><span>PA</span><span>BA</span><span>HR</span><span>K</span><span>WHIFF</span></div>';
            html += '<div class="roster-list" id="m-roster-list" data-cluster="'+clusterId+'" data-batter="'+batterObj.batter+'">';
            const sorted = [...pitcherMatchups].sort((a,b) => (b.pa||0) - (a.pa||0));
            sorted.forEach(m => {
                const baVal = m.ba != null ? m.ba.toFixed(3) : '\u2014';
                const whiff = m.w != null ? (m.w*100).toFixed(0)+'%' : '\u2014';
                const baColor = m.ba != null ? (m.ba >= 0.300 ? 'color:var(--green)' : m.ba <= 0.180 ? 'color:var(--red)' : '') : '';
                html += '<div class="roster-row"><span class="r-name">'+fmtName(m.pn)+'</span><span class="r-val">'+(m.pa||0)+'</span><span class="r-val highlight" style="'+baColor+'">'+baVal+'</span><span class="r-val">'+(m.hr||0)+'</span><span class="r-val">'+(m.k||0)+'</span><span class="r-val">'+whiff+'</span></div>';
            });
            html += '</div>';
        } else {
            html += '<div class="section-hdr">Pitchers in Group</div>';
            html += '<div class="roster-empty">No individual matchup data</div>';
        }
    } else {
        html += '<div class="stat-header" style="color:'+cluster.color+'">'+archName(clusterId)+'</div>';
        html += '<div class="stat-sub" style="color:'+cluster.color+'">'+cluster.hand+' '+role+' \u2014 '+cluster.pitcher_count+' pitchers</div>';
        html += '<div class="section-hdr">Cluster Profile</div>';
        if (cent.avg_velo_FF>0) html += '<div class="profile-row"><span>Avg Fastball</span><span class="pval">'+(cent.avg_velo_FF).toFixed(1)+' mph</span></div>';
        html += '<div class="profile-row"><span>Whiff Rate</span><span class="pval">'+((cent.whiff_rate||0)*100).toFixed(1)+'%</span></div>';
        html += '<div class="profile-row"><span>Zone Rate</span><span class="pval">'+((cent.zone_rate||0)*100).toFixed(1)+'%</span></div>';
        html += '<div class="profile-row"><span>GB Rate</span><span class="pval">'+((cent.groundball_rate||0)*100).toFixed(1)+'%</span></div>';
        html += '<div class="profile-row"><span>Arm Angle</span><span class="pval">'+(cent.arm_angle||0).toFixed(1)+'\u00b0</span></div>';
        if (cent.pfx_x_avg!=null) html += '<div class="profile-row"><span>H-Break</span><span class="pval">'+((cent.pfx_x_avg)*12).toFixed(1)+'"</span></div>';
        if (cent.pfx_z_avg!=null) html += '<div class="profile-row"><span>V-Break</span><span class="pval">'+((cent.pfx_z_avg)*12).toFixed(1)+'"</span></div>';
        const pitches = ['FF','SI','FC','SL','CH','CU','FS','KC','ST','SV','KN'].map(p=>({p,v:cent['pct_'+p]||0})).filter(x=>x.v>0.05).sort((a,b)=>b.v-a.v);
        html += '<div class="profile-row"><span>Top Pitches</span><span class="pval">'+pitches.map(x=>x.p+' '+((x.v)*100).toFixed(0)+'%').join(', ')+'</span></div>';

        // Pitcher roster (no batter)
        const members = DATA.pitcherSeasons.filter(p => p.cluster === clusterId && (!_teamPitcherIds || _teamPitcherIds.has(p.pitcher)));
        const seen = {};
        members.forEach(p => { if (!seen[p.pitcher] || p.game_year > seen[p.pitcher].game_year) seen[p.pitcher] = p; });
        const uniquePitchers = Object.values(seen).sort((a,b) => (b.avg_velo_FF||0) - (a.avg_velo_FF||0));
        if (uniquePitchers.length > 0) {
            html += '<div class="section-hdr">Pitchers ('+uniquePitchers.length+' unique)</div>';
            html += '<div class="roster-head"><span>PITCHER</span><span>YR</span><span>VELO</span><span></span><span></span><span>WHIFF</span></div>';
            html += '<div class="roster-list">';
            uniquePitchers.slice(0,50).forEach(p => {
                html += '<div class="roster-row"><span class="r-name">'+fmtName(p.player_name)+'</span><span class="r-val">'+p.game_year+'</span><span class="r-val highlight">'+(p.avg_velo_FF||0).toFixed(1)+'</span><span class="r-val"></span><span class="r-val"></span><span class="r-val">'+((p.whiff_rate||0)*100).toFixed(0)+'%</span></div>';
            });
            if (uniquePitchers.length > 50) html += '<div class="roster-empty">+'+(uniquePitchers.length-50)+' more</div>';
            html += '</div>';
        }
    }

    // Kings
    const kings = DATA.archetypeKings[clusterId] || [];
    if (kings.length > 0) {
        html += '<div class="section-hdr">Kings of '+archName(clusterId)+'</div>';
        kings.slice(0,8).forEach(k => {
            html += '<div class="king-row"><span class="k-name">'+k.name+'</span><span class="k-stat" style="width:24px;">'+k.seasons+'yr</span><span class="k-stat" style="color:var(--green);">'+(k.avg_velo>0?k.avg_velo.toFixed(0):'\u2014')+'</span><span class="k-stat" style="color:var(--red);">'+((k.avg_whiff||0)*100).toFixed(0)+'%</span></div>';
        });
    }

    // Examples
    html += '<div class="section-hdr">Examples</div><div style="font-size:10px;color:#666;font-family:var(--font-tech);">';
    (cluster.example_pitchers||[]).forEach(p => { html += '<div style="margin-bottom:2px;">'+p+'</div>'; });
    html += '</div>';

    sheetContent.innerHTML = html;
    STATE.highlightedCluster = clusterId;
    openSheet('full');
    render();
    buildArchetypeCards(); buildArchetypeSpread();

    // Sort button handlers
    sheetContent.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const rosterList = document.getElementById('m-roster-list');
            if (!rosterList) return;
            const cId = rosterList.dataset.cluster;
            const bId = parseInt(rosterList.dataset.batter);
            const sortKey = btn.dataset.sort;
            btn.parentElement.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const pm = (DATA._hvpIndex[bId] || {})[cId] || [];
            let s;
            if (sortKey==='pa') s=[...pm].sort((a,b)=>(b.pa||0)-(a.pa||0));
            else if (sortKey==='ba') s=[...pm].sort((a,b)=>(b.ba||0)-(a.ba||0));
            else if (sortKey==='hr') s=[...pm].sort((a,b)=>(b.hr||0)-(a.hr||0));
            else if (sortKey==='k') s=[...pm].sort((a,b)=>(b.k||0)-(a.k||0));
            else s=pm;
            rosterList.innerHTML = s.map(m => {
                const baVal=m.ba!=null?m.ba.toFixed(3):'\u2014';
                const whiff=m.w!=null?(m.w*100).toFixed(0)+'%':'\u2014';
                const baColor=m.ba!=null?(m.ba>=0.300?'color:var(--green)':m.ba<=0.180?'color:var(--red)':''):'';
                return '<div class="roster-row"><span class="r-name">'+fmtName(m.pn)+'</span><span class="r-val">'+(m.pa||0)+'</span><span class="r-val highlight" style="'+baColor+'">'+baVal+'</span><span class="r-val">'+(m.hr||0)+'</span><span class="r-val">'+(m.k||0)+'</span><span class="r-val">'+whiff+'</span></div>';
            }).join('');
        });
    });
}

function showPitcherStatPanel(ps, batterObj) {
    const cluster = DATA.clusters[ps.cluster];
    if (!cluster) return;
    const role = ps.is_sp ? 'SP' : 'RP';
    let html = '';
    html += '<div class="stat-header">'+fmtName(ps.player_name)+'</div>';
    html += '<div class="stat-sub" style="color:'+cluster.color+'">'+ps.game_year+' // '+archName(ps.cluster)+'</div>';
    html += '<div class="section-hdr">Pitcher Profile</div>';
    html += '<div class="stat-grid">';
    html += statCell('VELO', (ps.avg_velo_FF||0).toFixed(1));
    html += statCell('WHIFF', ((ps.whiff_rate||0)*100).toFixed(0)+'%');
    html += statCell('ARM', (ps.arm_angle||0).toFixed(0)+'\u00b0');
    html += '</div>';
    html += '<div class="profile-row"><span>Hand</span><span class="pval">'+(ps.is_rhp ? 'Right' : 'Left')+'</span></div>';
    html += '<div class="profile-row"><span>Role</span><span class="pval">'+role+'</span></div>';
    html += '<div class="profile-row"><span>H-Break</span><span class="pval">'+((ps.pfx_x_avg||0)*12).toFixed(1)+'"</span></div>';
    html += '<div class="profile-row"><span>V-Break</span><span class="pval">'+((ps.pfx_z_avg||0)*12).toFixed(1)+'"</span></div>';

    if (batterObj) {
        const hvpData = (DATA._hvpIndex[batterObj.batter] || {})[ps.cluster] || [];
        const matchup = hvpData.find(m => m.p === ps.pitcher);
        if (matchup) {
            const ss = STATE.selectedStat;
            const pa = matchup.pa||0;
            let featVal = 0;
            if (ss==='wOBA') featVal = matchup.w||0;
            else if (ss==='BA') featVal = matchup.ba||0;
            else if (ss==='K_pct') featVal = pa>0 ? (matchup.k||0)/pa : 0;
            else if (ss==='BB_pct') featVal = pa>0 ? (matchup.bb||0)/pa : 0;
            else featVal = matchup.w||0;
            html += '<div class="section-hdr">vs '+fmtName(batterObj.batter_name)+'</div>';
            html += '<div class="stat-grid">';
            html += statCell('PA', pa);
            html += statCell('BA', matchup.ba != null ? matchup.ba.toFixed(3) : '\u2014');
            html += statCell(statLabel(ss), fmtStatVal(ss, featVal));
            html += statCell('HR', matchup.hr||0);
            html += statCell('K', matchup.k||0);
            html += statCell('BB', matchup.bb||0);
            html += '</div>';
            // TAGS placeholder
            html += '<div style="font-size:10px;color:#555;font-style:italic;font-family:var(--font-tech);padding:6px 0;margin-top:8px;border-top:1px solid #1a1a1a;">\u{1F3F7}\uFE0F TAGGED: Coming Soon</div>';
        } else {
            html += '<div class="section-hdr">vs '+fmtName(batterObj.batter_name)+'</div>';
            html += '<div style="font-size:11px;color:#666;font-family:var(--font-tech);padding:4px 0;">No direct matchup data</div>';
        }
    }

    // Archetype link
    html += '<div class="section-hdr">Archetype</div>';
    html += '<div class="arch-link" data-cluster="'+ps.cluster+'">';
    html += '<span style="width:8px;height:8px;border-radius:50%;background:'+cluster.color+';flex-shrink:0;"></span>';
    html += '<span style="font-size:11px;font-weight:700;color:#eee;font-family:var(--font-tech);">'+archName(ps.cluster)+'</span>';
    html += '<span style="font-size:9px;color:#888;margin-left:auto;">'+cluster.hand+' '+role+' \u2022 '+cluster.pitcher_count+' pitchers \u2192</span>';
    html += '</div>';

    sheetContent.innerHTML = html;
    STATE.highlightedCluster = ps.cluster;
    openSheet('full');
    render(); buildArchetypeCards(); buildArchetypeSpread();

    const archLink = sheetContent.querySelector('.arch-link');
    if (archLink) {
        archLink.addEventListener('click', () => {
            showStatPanel(batterObj, ps.cluster);
        });
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCHETYPE SPREAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildArchetypeSpread() {
    const el = document.getElementById('archetype-spread');
    if (!el) return;
    const batters = STATE.activeBatters;
    const hasBatters = batters.length > 0;
    const matchups = hasBatters ? getMatchupData(batters[batters.length - 1]) : [];

    const renderRow = (ids, cssClass) => {
        let html = '<div class="spread-row ' + cssClass + '">';
        ids.forEach(id => {
            const c = DATA.clusters[id];
            if (!c) return;
            const vis = STATE.visibleClusters.has(id);
            const sel = STATE.highlightedCluster === id;
            const m = matchups.find(x => String(x.cluster) === id);
            const hasStat = hasBatters && m && (m.PA || 0) >= STATE.minPA;
            const dimmed = !vis || (hasBatters && !hasStat);

            let cls = 'spread-chip';
            if (sel) cls += ' selected';
            if (dimmed && hasBatters) cls += ' dimmed';

            html += '<div class="' + cls + '" data-cluster="' + id + '" style="border-bottom-color:' + c.color + ';">';
            html += '<span class="chip-emoji">' + archEmoji(id) + '</span>';

            if (hasStat) {
                const val = m[STATE.selectedStat] || 0;
                const display = (STATE.selectedStat === 'K_pct' || STATE.selectedStat === 'BB_pct')
                    ? (val * 100).toFixed(0) + '%' : val.toFixed(3).slice(1);
                html += '<span class="chip-stat" style="color:' + perfHex(STATE.selectedStat, val) + ';">' + display + '</span>';
            } else {
                html += '<span class="chip-label">' + ARCHETYPE_ABBREV[id] + '</span>';
            }
            html += '</div>';
        });
        html += '</div>';
        return html;
    };

    const rhp = ARCHETYPE_SPREAD_ORDER.rhp;
    const lhp = ARCHETYPE_SPREAD_ORDER.lhp;

    let html = '<div class="spread-label"><span>ARCHETYPE SPREAD</span></div>';
    html += '<div class="spread-hand-label">â–¸ RHP</div>';
    html += renderRow(rhp.slice(0, 5), '');
    html += renderRow(rhp.slice(5), 'stagger-row');
    html += '<div class="spread-hand-label">â–¸ LHP</div>';
    html += renderRow(lhp.slice(0, 5), '');
    html += renderRow(lhp.slice(5), 'stagger-row');
    el.innerHTML = html;

    // Bind tap handlers
    el.querySelectorAll('.spread-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const id = chip.dataset.cluster;
            if (STATE.highlightedCluster === id) {
                STATE.highlightedCluster = null;
                closeSheet();
                buildArchetypeSpread(); buildArchetypeCards();
                return;
            }
            const ab = batters.length > 0 ? batters[batters.length - 1] : null;
            showStatPanel(ab, id);
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCHETYPE CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildArchetypeCards() {
    const dir = document.getElementById('archetype-list');
    const ids = Object.keys(DATA.clusters);
    const rhp = ids.filter(id => DATA.clusters[id].hand === 'RHP').sort();
    const lhp = ids.filter(id => DATA.clusters[id].hand === 'LHP').sort();
    const batters = STATE.activeBatters;
    const hasBatters = batters.length > 0;
    const allMatchups = batters.map(b => getMatchupData(b));
    let html = '';

    // Pre-compute team pitcher counts
    let _teamCounts = null;
    if (_teamPitcherIds) {
        _teamCounts = {};
        DATA.pitcherSeasons.forEach(ps => {
            if (!_teamPitcherIds.has(ps.pitcher)) return;
            if (!_teamCounts[ps.cluster]) _teamCounts[ps.cluster] = new Set();
            _teamCounts[ps.cluster].add(ps.pitcher);
        });
    }

    const renderGroup = (group, label) => {
        html += '<div class="arch-group-hdr">' + label + '</div>';
        group.forEach(id => {
            const c = DATA.clusters[id];
            const cent = c.centroid || {};
            const vis = STATE.visibleClusters.has(id);
            const sel = STATE.highlightedCluster === id;
            const cls = 'arch-card' + (sel ? ' selected' : '') + (!vis ? ' dimmed' : '');

            // Count SPs and RPs in this cluster
            const clusterPitchers = DATA.pitcherSeasons.filter(p => p.cluster === id && (!_teamPitcherIds || _teamPitcherIds.has(p.pitcher)));
            const spCount = clusterPitchers.filter(p => p.is_sp).length;
            const rpCount = clusterPitchers.length - spCount;
            const displayCount = _teamCounts ? (_teamCounts[id] ? _teamCounts[id].size : 0) : c.pitcher_count;

            html += '<div class="' + cls + '" data-cluster="' + id + '" style="border-left-color:' + c.color + ';">';
            html += '<div class="card-top">';
            html += '<span class="card-name" style="color:' + (vis ? c.color : '#666') + ';">' + archName(id) + '</span>';
            html += '<span class="card-count">' + displayCount + ' P</span>';
            html += '</div>';

            // Profile stats line
            const velo = (cent.avg_velo_FF || 0).toFixed(1);
            const whiff = ((cent.whiff_rate || 0) * 100).toFixed(0);
            html += '<div class="card-profile">' + velo + ' mph \u00b7 ' + whiff + '% Whiff</div>';

            // Batter matchup line (if active)
            if (hasBatters) {
                const matchups = allMatchups[allMatchups.length - 1];
                const m = matchups.find(x => String(x.cluster) === id);
                if (m && m.PA >= STATE.minPA) {
                    const val = m[STATE.selectedStat] || 0;
                    const display = (STATE.selectedStat === 'K_pct' || STATE.selectedStat === 'BB_pct')
                        ? (val * 100).toFixed(0) + '%' : val.toFixed(3);
                    html += '<div class="card-matchup" style="color:' + perfHex(STATE.selectedStat, val) + ';">' + display + ' ' + statLabel(STATE.selectedStat) + ' vs ' + fmtName(STATE.activeBatters[STATE.activeBatters.length-1].batter_name) + '</div>';
                } else {
                    html += '<div class="card-matchup" style="color:#444;">\u2014 no data</div>';
                }
            }

            // Role tags
            if (spCount > 0 || rpCount > 0) {
                html += '<div class="card-roles">';
                if (spCount > 0) html += '<span class="role-tag sp">\u2B50 ' + spCount + ' SP</span>';
                if (rpCount > 0) html += '<span class="role-tag rp">\u{1F6E1}\uFE0F ' + rpCount + ' RP</span>';
                html += '</div>';
            }

            html += '</div>';
        });
    };
    renderGroup(rhp, 'RIGHT-HANDED PITCHERS');
    renderGroup(lhp, 'LEFT-HANDED PITCHERS');
    dir.innerHTML = html;

    // Bind click handlers
    dir.querySelectorAll('.arch-card').forEach(el => {
        el.addEventListener('click', () => {
            const id = el.dataset.cluster;
            if (STATE.highlightedCluster === id) {
                STATE.highlightedCluster = null;
                closeSheet();
                render(); buildArchetypeCards(); buildArchetypeSpread();
                return;
            }
            const ab = STATE.activeBatters.length > 0 ? STATE.activeBatters[STATE.activeBatters.length-1] : null;
            showStatPanel(ab, id);
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ARCHETYPE KEY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildArchetypeKey() {
    let html = '<div class="stat-header">\u{1F511} Archetype Key</div>';
    html += '<div style="font-size:11px;color:#888;font-family:var(--font-tech);margin:4px 0 12px;">13 distinct pitcher identities across 19 clusters</div>';

    // Shared archetypes (both hands)
    const shared = [
        { name: 'Firestarter', ids: ['R_6', 'L_2'] },
        { name: 'Earthworm', ids: ['R_4', 'L_4'] },
        { name: 'Splitter Demon', ids: ['R_9', 'L_6'] },
        { name: 'Boomerang', ids: ['R_1', 'L_7'] },
        { name: 'Side-Sweeper', ids: ['R_5', 'L_8'] },
        { name: 'Big Hooker', ids: ['R_7', 'L_3'] },
    ];

    const rhpOnly = [
        { name: 'Cut & Curved', ids: ['R_0'] },
        { name: 'Ghost Baller', ids: ['R_2'] },
        { name: 'Triple Threat', ids: ['R_3'] },
        { name: 'Snakey', ids: ['R_8'] },
    ];

    const lhpOnly = [
        { name: 'Undertow', ids: ['L_0'] },
        { name: 'Craftsman', ids: ['L_1'] },
        { name: 'Uncle Charlie', ids: ['L_5'] },
    ];

    const renderSection = (title, items) => {
        html += '<div class="section-hdr">' + title + '</div>';
        items.forEach(item => {
            const a = ARCHETYPE_MAP[item.ids[0]];
            const desc = ARCHETYPE_DESC[item.name] || '';
            const clusterColors = item.ids.map(id => DATA.clusters[id]?.color || '#666');
            html += '<div class="key-item">';
            html += '<div class="key-top">';
            html += '<span class="key-emoji">' + (a?.emoji || '') + '</span>';
            html += '<span class="key-name" style="color:' + clusterColors[0] + ';">' + item.name.toUpperCase() + '</span>';
            html += '</div>';
            html += '<div class="key-desc">' + desc + '</div>';
            html += '<div class="key-clusters">' + item.ids.map(id => {
                const cl = DATA.clusters[id];
                return cl ? '<span style="color:' + cl.color + ';">' + cl.hand + ': ' + id + '</span>' : '';
            }).join(' \u00b7 ') + '</div>';
            const kings = DATA.archetypeKings[item.ids[0]] || [];
            if (kings.length > 0) {
                const names = kings.slice(0, 3).map(k => k.name).join(', ');
                html += '<div class="key-examples">' + names + '</div>';
            }
            html += '</div>';
        });
    };

    renderSection('SHARED (Both Hands)', shared);
    renderSection('RHP ONLY', rhpOnly);
    renderSection('LHP ONLY', lhpOnly);

    // Role key
    html += '<div class="section-hdr">ROLES (Per Pitcher)</div>';
    html += '<div class="key-item"><div class="key-top"><span class="key-emoji">\u2B50</span><span class="key-name" style="color:#f4a261;">SP \u2014 STARTER</span></div><div class="key-desc">Primary rotation pitcher, 5+ innings per start</div></div>';
    html += '<div class="key-item"><div class="key-top"><span class="key-emoji">\u{1F6E1}\uFE0F</span><span class="key-name" style="color:#a8dadc;">RP \u2014 RELIEVER</span></div><div class="key-desc">Bullpen pitcher, 1-3 innings per appearance</div></div>';
    html += '<div class="key-item"><div class="key-top"><span class="key-emoji">\u{1F504}</span><span class="key-name" style="color:#e76f51;">SW \u2014 SWINGMAN</span></div><div class="key-desc">Flexible role, starts and relieves</div></div>';

    // TAGS placeholder
    html += '<div class="section-hdr">STATS</div>';
    html += '<div class="key-item tags-placeholder">';
    html += '<div class="key-top"><span class="key-emoji">\u{1F3F7}\uFE0F</span><span class="key-name" style="color:#555;">TAGGED</span></div>';
    html += '<div class="key-desc" style="color:#555;font-style:italic;">When a pitcher retires the same batter 2+ times in a single game. Tracks pitcher dominance in individual games.<br><span style="color:#444;">(Pipeline update required \u2014 Coming Soon)</span></div>';
    html += '</div>';

    sheetContent.innerHTML = html;
    openSheet('full');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUNT FEED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHuntFeed() {
    let html = '<div class="stat-header">\u{1F3AF} Hunt Feed</div>';

    if (STATE.activeBatters.length === 0) {
        html += '<div style="font-size:12px;color:#666;text-align:center;padding:40px 0;font-family:var(--font-tech);">Search a batter to see<br>matchup edges</div>';
        sheetContent.innerHTML = html;
        openSheet('full');
        return;
    }

    const batter = STATE.activeBatters[STATE.activeBatters.length - 1];
    html += '<div style="font-size:11px;color:#888;font-family:var(--font-tech);margin:4px 0 12px;">' + fmtName(batter.batter_name) + ' matchup edges</div>';

    const matchups = getMatchupData(batter);

    // Compute BA for each matchup
    const withBA = matchups.filter(m => (m.PA || 0) >= Math.max(STATE.minPA, 9) && m.AB > 0).map(m => {
        const ba = m.H / m.AB;
        return { ...m, ba_calc: ba };
    });

    // CRUSH ZONE: BA >= .350
    const crush = withBA.filter(m => m.ba_calc >= 0.350).sort((a, b) => b.ba_calc - a.ba_calc);
    // DANGER ZONE: BA <= .150
    const danger = withBA.filter(m => m.ba_calc <= 0.150).sort((a, b) => a.ba_calc - b.ba_calc);

    if (crush.length > 0) {
        html += '<div class="section-hdr">\u{1F7E2} CRUSH ZONE</div>';
        crush.slice(0, 5).forEach(m => {
            const cl = DATA.clusters[m.cluster];
            const color = cl?.color || '#888';
            const hand = m.cluster[0];
            html += '<div class="hunt-row" data-cluster="' + m.cluster + '" style="cursor:pointer;">';
            html += '<span class="hunt-ba" style="color:var(--green);">' + m.ba_calc.toFixed(3) + '</span>';
            html += '<span class="hunt-arch" style="color:' + color + ';"><span style="color:#666;font-size:9px;font-weight:800;margin-right:3px;">' + hand + '</span>vs ' + archName(m.cluster) + '</span>';
            html += '<span class="hunt-meta">' + m.PA + ' PA \u00b7 ' + fmtStatVal('wOBA', m.wOBA || 0) + ' wOBA</span>';
            html += '</div>';
        });
    } else {
        html += '<div class="section-hdr">\u{1F7E2} CRUSH ZONE</div>';
        html += '<div style="font-size:11px;color:#444;font-family:var(--font-tech);padding:8px 0;text-align:center;">No extreme high-BA matchups found</div>';
    }

    if (danger.length > 0) {
        html += '<div class="section-hdr">\u{1F534} DANGER ZONE</div>';
        danger.slice(0, 5).forEach(m => {
            const cl = DATA.clusters[m.cluster];
            const color = cl?.color || '#888';
            const hand = m.cluster[0];
            html += '<div class="hunt-row" data-cluster="' + m.cluster + '" style="cursor:pointer;">';
            html += '<span class="hunt-ba" style="color:var(--red);">' + m.ba_calc.toFixed(3) + '</span>';
            html += '<span class="hunt-arch" style="color:' + color + ';"><span style="color:#666;font-size:9px;font-weight:800;margin-right:3px;">' + hand + '</span>vs ' + archName(m.cluster) + '</span>';
            html += '<span class="hunt-meta">' + m.PA + ' PA \u00b7 ' + fmtStatVal('wOBA', m.wOBA || 0) + ' wOBA</span>';
            html += '</div>';
        });
    } else {
        html += '<div class="section-hdr">\u{1F534} DANGER ZONE</div>';
        html += '<div style="font-size:11px;color:#444;font-family:var(--font-tech);padding:8px 0;text-align:center;">No extreme low-BA matchups found</div>';
    }

    // TAGS placeholder in hunt feed too
    html += '<div class="section-hdr">\u{1F3F7}\uFE0F TAGGED</div>';
    html += '<div style="font-size:11px;color:#555;font-style:italic;font-family:var(--font-tech);padding:8px 0;">Coming soon \u2014 tracks when a pitcher retires the same batter 2+ times in a single game</div>';

    sheetContent.innerHTML = html;
    openSheet('full');

    // Wire click handlers for hunt rows â†’ open stat panel
    sheetContent.querySelectorAll('.hunt-row[data-cluster]').forEach(row => {
        row.addEventListener('click', () => {
            showStatPanel(batter, row.dataset.cluster);
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fuse = null;
function initSearch() { fuse = new Fuse(DATA.batters, { keys: ['batter_name'], threshold: 0.3, distance: 100 }); }

const searchInput = document.getElementById('batter-search');
const searchDrop = document.getElementById('search-dropdown');
let sHighlight = 0, sResults = [];

searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    if (q.length < 2) { searchDrop.classList.remove('visible'); return; }
    sResults = fuse.search(q).slice(0,8).map(r => r.item);
    sHighlight = 0;
    renderSearchResults();
});
searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowDown') { e.preventDefault(); sHighlight = Math.min(sHighlight+1, sResults.length-1); renderSearchResults(); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); sHighlight = Math.max(sHighlight-1, 0); renderSearchResults(); }
    else if (e.key === 'Enter') { e.preventDefault(); if (sResults[sHighlight]) selectResult(sResults[sHighlight]); }
    else if (e.key === 'Escape') searchDrop.classList.remove('visible');
});

function renderSearchResults() {
    if (sResults.length === 0) { searchDrop.classList.remove('visible'); return; }
    searchDrop.innerHTML = sResults.map((b,i) =>
        '<div class="search-result '+(i===sHighlight?'highlighted':'')+'" data-idx="'+i+'"><span>'+fmtName(b.batter_name)+'</span><span class="pa-label">'+(b.total_PA||0).toLocaleString()+' PA</span></div>'
    ).join('');
    searchDrop.classList.add('visible');
}

searchDrop.addEventListener('mousedown', (e) => {
    const el = e.target.closest('.search-result');
    if (!el) return;
    e.preventDefault();
    selectResult(sResults[parseInt(el.dataset.idx)]);
});
searchDrop.addEventListener('touchstart', (e) => {
    const el = e.target.closest('.search-result');
    if (!el) return;
    selectResult(sResults[parseInt(el.dataset.idx)]);
}, { passive: true });

function selectResult(batter) { addBatter(batter); searchInput.value = ''; searchDrop.classList.remove('visible'); searchInput.blur(); }

function addBatter(batter) {
    STATE.activeBatters = STATE.activeBatters.filter(b => b.batter !== batter.batter);
    if (STATE.activeBatters.length >= 3) STATE.activeBatters.shift();
    STATE.activeBatters.push(batter);
    renderBatterChips();
    spawnBatter(batter);
}

function removeBatter(id) {
    STATE.activeBatters = STATE.activeBatters.filter(b => b.batter !== id);
    renderBatterChips();
    if (STATE.activeBatters.length > 0) spawnBatter(STATE.activeBatters[STATE.activeBatters.length-1]);
    else { clearBatter(); buildArchetypeCards(); buildArchetypeSpread(); }
}

function renderBatterChips() {
    const bar = document.getElementById('batter-chip-bar');
    if (STATE.activeBatters.length === 0) { bar.classList.remove('visible'); return; }
    bar.classList.add('visible');
    bar.innerHTML = STATE.activeBatters.map(b =>
        '<div class="batter-chip" data-id="'+b.batter+'">'+fmtName(b.batter_name)+'<span class="remove" data-id="'+b.batter+'">\u2715</span></div>'
    ).join('');
    bar.querySelectorAll('.remove').forEach(r => {
        r.addEventListener('click', (e) => { e.stopPropagation(); removeBatter(parseInt(r.dataset.id)); });
    });
}

// Close search on tap outside
document.addEventListener('touchstart', (e) => {
    if (!e.target.closest('.search-box')) searchDrop.classList.remove('visible');
}, { passive: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVED SEARCHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveSearch(batter) {
    const idx = STATE.savedSearches.findIndex(s => s.batter === batter.batter);
    if (idx >= 0) STATE.savedSearches.splice(idx, 1);
    STATE.savedSearches.unshift({ batter: batter.batter, batter_name: batter.batter_name, total_PA: batter.total_PA });
    if (STATE.savedSearches.length > 10) STATE.savedSearches = STATE.savedSearches.slice(0, 10);
    localStorage.setItem('pfx_saved', JSON.stringify(STATE.savedSearches));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Metric pills
document.getElementById('filter-bar').addEventListener('click', (e) => {
    const pill = e.target.closest('.pill');
    if (!pill) return;

    if (pill.dataset.stat) {
        document.querySelectorAll('.pill[data-stat]').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        STATE.selectedStat = pill.dataset.stat;
        refreshData(); buildArchetypeCards(); buildArchetypeSpread(); render();
        // Re-render stat panel if open
        if (STATE.highlightedCluster && STATE.sheetState !== 'hidden') {
            const ab = STATE.activeBatters.length > 0 ? STATE.activeBatters[STATE.activeBatters.length-1] : null;
            showStatPanel(ab, STATE.highlightedCluster);
        }
    }
    if (pill.dataset.filter) {
        document.querySelectorAll('.pill[data-filter]').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
        const filter = pill.dataset.filter;
        Object.keys(DATA.clusters).forEach(id => {
            const c = DATA.clusters[id];
            const show = filter === 'all' || c.hand === filter;
            if (show) STATE.visibleClusters.add(id); else STATE.visibleClusters.delete(id);
        });
        render(); refreshData(); buildArchetypeCards(); buildArchetypeSpread();
    }
});

document.getElementById('year-select').addEventListener('change', (e) => {
    STATE.selectedYear = e.target.value; refreshData(); buildArchetypeCards(); buildArchetypeSpread(); render();
});

document.getElementById('team-select').addEventListener('change', (e) => {
    updateTeamFilter(e.target.value || null);
});

const paSlider = document.getElementById('pa-slider'), paVal = document.getElementById('pa-val');
paSlider.addEventListener('input', () => {
    STATE.minPA = parseInt(paSlider.value); paVal.textContent = STATE.minPA;
    refreshData(); buildArchetypeCards(); buildArchetypeSpread(); render();
});

// â•â•â• ROLE FILTER (pitcher filters) â•â•â•
document.querySelectorAll('.pill[data-role]').forEach(pill => {
    pill.addEventListener('click', () => {
        document.querySelectorAll('.pill[data-role]').forEach(p => {
            p.style.background = ''; p.style.color = '';
        });
        pill.style.background = '#f4a261'; pill.style.color = '#111';
        const role = pill.dataset.role;
        STATE.pitcherFilters.roleFilter = role === 'all' ? null : role;
        render();
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const action = tab.dataset.tab;
        if (action === 'home') {
            closeSheet();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        } else if (action === 'key') {
            buildArchetypeKey();
        } else if (action === 'hunt') {
            buildHuntFeed();
        } else if (action === 'sim') {
            showSimSheet();
        } else if (action === 'more') {
            showMoreSheet();
        }
    });
});

function showSimSheet() {
    let html = '<div class="stat-header" style="color:var(--accent);">\u26A1 SIM LAB</div>';
    html += '<div style="font-size:11px;color:#888;font-family:var(--font-tech);margin:8px 0 16px;">Weekly hitter projection tool. For the full SIM LAB experience, open on desktop.</div>';
    html += '<div style="font-size:12px;color:#666;text-align:center;padding:40px 0;">SIM LAB is optimized for desktop.<br>Visit on a larger screen for full projections.</div>';
    sheetContent.innerHTML = html;
    openSheet('full');
}

function showMoreSheet() {
    const total = DATA.pitcherSeasons.length;
    const clusters = Object.keys(DATA.clusters).length;
    let html = '<div class="stat-header">PITCH.FX // CLUSTER</div>';
    html += '<div style="font-size:11px;color:#888;font-family:var(--font-tech);margin:8px 0 16px;">MLB Pitcher Archetype Explorer</div>';
    html += '<div class="section-hdr">Data Summary</div>';
    html += '<div class="profile-row"><span>Archetypes</span><span class="pval">'+clusters+'</span></div>';
    html += '<div class="profile-row"><span>Pitcher Seasons</span><span class="pval">'+total.toLocaleString()+'</span></div>';
    html += '<div class="profile-row"><span>Batters</span><span class="pval">'+DATA.batters.length.toLocaleString()+'</span></div>';
    html += '<div class="section-hdr">Navigation</div>';
    html += '<div style="font-size:11px;color:#aaa;font-family:var(--font-tech);line-height:1.8;padding:4px 0;">';
    html += '\u2022 Tap an archetype card to view details<br>';
    html += '\u2022 Search a batter to see matchup lines<br>';
    html += '\u2022 Use filters to change metric, hand, or year<br>';
    html += '\u2022 Key tab shows all 12 archetypes<br>';
    html += '\u2022 Hunt tab shows batter matchup edges';
    html += '</div>';
    html += '<div class="section-hdr">Search History</div>';
    if (STATE.savedSearches.length === 0) {
        html += '<div style="font-size:11px;color:#666;font-family:var(--font-tech);padding:12px 0;text-align:center;">No search history yet</div>';
    } else {
        STATE.savedSearches.forEach(s => {
            html += '<div class="profile-row" style="cursor:pointer;padding:8px 0;" data-bid="'+s.batter+'"><span style="color:#eee;font-weight:700;">'+fmtName(s.batter_name)+'</span><span class="pval" style="color:#888;">'+(s.total_PA||0).toLocaleString()+' PA</span></div>';
        });
    }
    html += '<div style="margin-top:24px;text-align:center;"><a href="cosmos.html" style="color:var(--accent);font-size:11px;font-family:var(--font-tech);font-weight:700;text-decoration:none;">SWITCH TO DESKTOP VERSION \u2192</a></div>';
    sheetContent.innerHTML = html;
    openSheet('full');

    // Bind saved search clicks
    sheetContent.querySelectorAll('[data-bid]').forEach(el => {
        el.addEventListener('click', () => {
            const b = DATA.batters.find(x => x.batter === parseInt(el.dataset.bid));
            if (b) { addBatter(b); closeSheet(); }
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', resizeCanvas);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function boot() {
    try {
        await loadAllData();
        resizeCanvas();
        buildArchetypeCards(); buildArchetypeSpread();
        initSearch();
        setTimeout(() => {
            const loader = document.getElementById('loader');
            loader.style.opacity = '0';
            setTimeout(() => loader.remove(), 800);
        }, 400);
    } catch (err) {
        console.error('Boot failed:', err);
        document.getElementById('loader-status').textContent = 'ERROR: ' + err.message;
    }
}
boot();
})();
</script>
</body>
</html>
